define("fishstrap/util/upload.js",function(e,n,t){var i=e("fishstrap/core/global.js"),o=e("fishstrap/core/html5.js"),a=e("fishstrap/util/imageCompresser.js"),r=e("fishstrap/util/jpegMeta.js").JpegMeta,s=e("fishstrap/module/jweixin.js");t.exports={_checkFileSize:function(e,n,t){function i(e){e>n.maxSize?n.onFail(n.maxSize<1024?"上传文件必须少于"+n.maxSize+"Byte":n.maxSize<1048576?"上传文件必须少于"+n.maxSize/1024+"KB":"上传文件必须少于"+n.maxSize/1024/1024+"MB"):t()}if(e.files)i(e.files[0].size?e.files[0].size:e.files[0].fileSize);else if(n._fileName.match(/.jpg|.jpeg|.gif|.png|.bmp/i)){var o=new Image;o.onerror=function(){n.onFail("图像格式不正确")};var a=0,r=setInterval(function(){a++,o.fileSize>0?(i(o.fileSize),clearInterval(r)):10==a&&(clearInterval(r),t())},100);o.src=n._fileAddress}else t()},_checkCanUpload:function(e,n,t){if(i.os.android){var o=navigator.userAgent.match(/MQQBrowser\/([^\s]+)/);if((!o||o&&o[1]<"5.2")&&i.os.version.toString()<="2.1")return void n.onFail("您的安卓手机系统暂不支持上传功能，请下载最新版的QQ浏览器")}else if(i.os.ios&&i.os.version.toString()<"6.0")return void n.onFail("您的手机系统不支持传图，请升级到ios6.0以上");return i.os.wx&&i.os.wxVersion.toString()<"5.2"?void n.onFail("您当前的微信版本太低，不支持传图，请升级到最新版"):void t()},_checkFileSelect:function(e,n,t){if(e.files){if(0==e.files.length)return;n._fileName=e.files[0].name;var i=window.URL||window.webkitURL||!1;n._fileAddress=i?i.createObjectURL(e.files[0]):e.value}else{if(!e.value||null==e.value)return;n._fileName=e.value,n._fileAddress=e.value}t()},_checkFileType:function(e,n,t){if(n.type&&null!=n.type){var o=!1,a=n.type.split("|");for(var r in a){var s=i.trim(a[r]);if(""!=s){var s="."+s;if(n._fileName.substring(n._fileName.length-s.length).toLowerCase()==s.toLowerCase()){o=!0;break}}}if(!o)return void n.onFail("仅支持上传以下格式的文件："+n.type)}t()},_readImage:function(e,n,t){o.fileReader.open({file:e.files[0],mode:"binary",onSuccess:function(e){n._fieldata=e,t()},onFail:function(e){n.onFail(e)}})},_compressImage:function(e,n,t){var o={quality:n.quality,scale:0,orien:1};if(n.width&&null!=n.width&&(o.maxW=n.width),n.height&&null!=n.height&&(o.maxH=n.height),o.maxW&&o.maxH&&(o.scale=o.maxW/o.maxH),"image/jpeg"==e.files[0].type){try{var s=new r.JpegFile(n._fieldata,n._fileName)}catch(l){i.console.warn("读取jpeg的meta数据失败"+l)}s&&s.tiff&&s.tiff.Orientation&&(o=i.extend(o,{orien:s.tiff.Orientation.value}))}var c=new Image;c.onload=function(){if("image/jpeg"==e.files[0].type){var r;try{r=a.getImageBase64(this,{maxW:320,quality:.8,orien:o.orien})}catch(s){return n.onFail("压缩图片失败 "+s),!1}if(r.indexOf("data:image")<0)return n.onFail("上传照片格式不支持"),!1;var l;try{l=a.getImageBase64(this,o)}catch(s){return n.onFail("压缩图片失败 "+s),!1}if(l.indexOf("data:image")<0)return n.onFail("上传照片格式不支持"),!1;n.onOpen(r),n._uploadData=l.split(";base64,")[1]}else{var l=i.base64.encode(n._fieldata,!1);n.onOpen("data:"+e.files[0].type+";base64,"+l),n._uploadData=l}t()},c.onerror=function(){return n.onFail("读取图片数据失败"),!1},c.src=n._fileAddress},_startUploadProgres:function(e,n,t){n._progress=1,n._progressInterval=0,n.onProgress(n._progress),n._progressInterval=setInterval(function(){return n._progress+5>=100?(clearInterval(n._progressInterval),void(n._progressInterval=null)):(n._progress+=5,void n.onProgress(n._progress))},1e3),t()},_cloudImageUpload:function(e,n){var t=n._uploadData,o=function(e){e.lengthComputable&&(n._progress=Math.ceil(100*(e.loaded/e.total)),n.onProgress(n._progress))},a=function(e){var t=i.JSON.parse(e.target.response);if(0==_.isUndefined(t.error))return void n.onFail(t.error);var o={code:0,msg:"",data:"http://"+n.url+"/"+t.key};n.onSuccess(i.JSON.stringify(o))},r=function(){n.onFail("网络断开，请稍后重新操作")},s=function(){n.onFail("上传已取消")},l=new XMLHttpRequest;l.upload&&l.upload.addEventListener("progress",o,!1),l.open("POST","http://upload.qiniu.com/putb64/-1",!0),l.addEventListener("progress",o,!1),l.addEventListener("load",a,!1),l.addEventListener("abort",s,!1),l.addEventListener("error",r,!1),l.setRequestHeader("Authorization","UpToken "+n.urlToken),l.setRequestHeader("Content-Type","application/octet-stream"),l.send(t)},_localImageUpload:function(e,n){var t=new FormData;t.append("data",n._uploadData);var i=function(e){e.lengthComputable&&(n._progress=Math.ceil(100*(e.loaded/e.total)),n.onProgress(n._progress))},o=function(e){n.onSuccess(e.target.response)},a=function(){n.onFail("网络断开，请稍后重新操作")},r=function(){n.onFail("上传已取消")},s=new XMLHttpRequest;s.upload&&s.upload.addEventListener("progress",i,!1),s.open("POST",n.url+"?t="+Date.now(),!0),s.addEventListener("progress",i,!1),s.addEventListener("load",o,!1),s.addEventListener("abort",r,!1),s.addEventListener("error",a,!1),s.send(t)},_uploadImage:function(e,n){var t=this;"local"==n.urlType?t._localImageUpload(e,n):t._cloudImageUpload(e,n)},_iframeUpload:function(e,n,t){t._progress=1,t._progressInterval=0,t.onProgress(t._progress),t._progressInterval=setInterval(function(){return t._progress+5>=100?(clearInterval(t._progressInterval),void(t._progressInterval=null)):(t._progress+=5,void t.onProgress(t._progress))},1e3),i("#"+n).submit()},file:function(e){var n=this,t={url:"",target:"",field:"",type:null,maxSize:null,accept:null,iframe:null};t=i.extend(t,e);var o="",a=i.uniqueNum(),r=i.uniqueNum(),s=i.uniqueNum();t.accept&&(t.accept='accept="'+t.accept+'"'),window.FormData&&window.File||(t.iframe='<iframe name="'+r+'" id="'+r+'" style="display:none">'),o='<form id="'+a+'" action="'+t.url+'" target="'+r+'" method="post" enctype="multipart/form-data" style="opacity:0;filter:alpha(opacity=0);display:block;position:absolute;top:0px;bottom:0px;left:0px;right:0px;width:100%;height:100%;z-index:9;overflow:hidden;"><input type="file" id="'+s+'" style="width:100%;height:100%;font-size:1000px;" name="'+t.field+'"'+t.accept+"/>"+t.iframe+"</form>",o=i(o),i("#"+t.target).css("position","relative"),i("#"+t.target).append(o),t.iframe&&i("#"+r).load(function(){if(t._progress){var e;e=this.contentWindow?i(this.contentWindow.document.body).text():i(this.contentDocument.document.body).text(),clearInterval(t._progressInterval),t.onProgress(100),t.onSuccess(e)}}),o.find("input").on("change",function(){var e=this;n._checkCanUpload(e,t,function(){n._checkFileSelect(e,t,function(){n._checkFileType(e,t,function(){n._checkFileSize(e,t,function(){t.iframe?n._iframeUpload(r,a,t):(t._uploadData=e.files[0],n._localImageUpload(e,t))})})})})})},_cordovaImage:function(e){function n(n){window.imagePicker.getPictures(function(t){return 0==t.length?void e.onFail("请选择图片上传噢"):void n(t[0])},function(n){e.onFail(n)},{maximumImagesCount:1,width:e.width})}function t(n){var t=function(n){return 200!=n.responseCode?void e.onFail("上传图片到服务器失败，错误码为："+n.responseCode):void e.onSuccess(n.response)},i=function(n){e.onFail("上传图片到服务器失败 "+n.code)},o=new window.FileUploadOptions;o.fileKey="data",o.fileName=n.substr(n.lastIndexOf("/")+1),o.mimeType="text/plain";var a=new window.FileTransfer;a.onprogress=function(n){if(n.lengthComputable){var t=Math.ceil(100*(n.loaded/n.total));e.onProgress(t)}},a.upload(n,encodeURI(e.url),t,i,o)}function o(){e.onOpen(),n(function(e){t(e)})}i("#"+e.target).click(o)},_wxImage:function(e){function n(n){s.chooseImage({success:function(t){var i=t.localIds;0!=i.length&&(r=i[0],e.onOpen(r),e.onProgress(0),n())}})}function t(n){s.uploadImage({localId:r,isShowProgressTips:1,success:function(e){l=e.serverId,n()},fail:function(){e.onFail("上传图片到微信服务器失败")}})}function o(){var n=new FormData;n.append("data",l);var t=function(n){if(n.lengthComputable){var t=Math.ceil(100*(n.loaded/n.total));e.onProgress(t)}},i=function(n){e.onSuccess(n.target.response)},o=function(){e.onFail("下载微信图片断开，请稍后重新操作")},a=function(){e.onFail("上传已取消")},r=new XMLHttpRequest;r.upload&&r.upload.addEventListener("progress",t,!1),r.open("POST",e.url+"?t="+Date.now(),!0),r.addEventListener("progress",t,!1),r.addEventListener("load",i,!1),r.addEventListener("abort",a,!1),r.addEventListener("error",o,!1),r.send(n)}function a(){return i.os.wxVersion.toString()<"6.1"?void alert("您的微信版本过低，微信上传图功能将不能正常使用，请升级微信至6.1及以上"):void n(function(){t(function(){o()})})}var r=null,l=null;i("#"+e.target).click(a)},_crossImage:function(e){function n(n){i._ajax({url:"/crossapi/image/choose",data:{isShowCamera:!0,count:1},success:function(t){return t=i.JSON.parse(t),0!=t.code?void alert(t.msg):void(0!=t.data.length&&(e.onOpen(),e.onProgress(0),a=t.data[0],n()))},error:function(e,n){alert(n)}})}function t(){i._ajax({url:"/crossapi/image/upload",data:{url:e.url,image:a,field:"data",maxWidth:e.width,maxHeight:e.height},success:function(n){return n=i.JSON.parse(n),0!=n.code?void e.onFail(n.msg):(e.onProgress(100),void e.onSuccess(n.data))},error:function(n,t){e.onFail(t)}})}function o(){n(function(){t()})}var a=null;i("#"+e.target).click(o)},imageV3:function(e){var n={url:"",field:"",target:"",width:null,height:null,quality:.8,onOpen:function(){},onProgress:function(){},onSuccess:function(){},onFail:function(){}};return n=i.extend(n,e),i.os.wx?this._wxImage(n):i.os.crossapi?this._crossImage(n):i.os.crosswalk?(n.type="png|jpg|jpeg|gif|bmp",n.accept="image/*",n.maxSize=8388608,this.file(n)):this.image(n)},imageV2:function(e){var n=this,t={url:"",urlToken:"",urlType:"local",field:"",width:null,height:null,quality:.8,onOpen:function(){},onProgress:function(){},onSuccess:function(){},onFail:function(){}};t=i.extend(t,e),t.type="png|jpg|jpeg|gif|bmp",t.id=_.uniqueId("upload_"),t.onUpload=function(e){n._checkCanUpload(e,t,function(){n._checkFileSelect(e,t,function(){n._checkFileType(e,t,function(){n._readImage(e,t,function(){n._compressImage(e,t,function(){n._startUploadProgres(e,t,function(){n._uploadImage(e,t)})})})})})})};var o='<input id="'+t.id+'" type="file" name="'+t.field+'" style="opacity:0;display:block;position:absolute;top:0px;bottom:0px;left:0px;right:0px;width:100%;height:100%;" accept="image/*" onchange="'+i.func.invoke(t.onUpload)+'">';return{el:o}},image:function(e){var n,t=this;if(n=window.File&&window.FileList&&window.FileReader&&window.Blob?!0:!1,0==n)return e.type="png|jpg|jpeg|gif|bmp",e.accept="image/*",t.file(e);var o={url:"",urlToken:"",urlType:"local",target:"",field:"",width:null,height:null,quality:.8,onOpen:function(){},onProgress:function(){},onSuccess:function(){},onFail:function(){}};o=i.extend(o,e),o.type="png|jpg|jpeg|gif|bmp";var a="",r=i.uniqueNum();o.accept&&(o.type='accept="image/*"'),a='<input id="'+r+'" type="file" name="'+o.field+'" style="opacity:0;display:block;position:absolute;top:0px;bottom:0px;left:0px;right:0px;width:100%;height:100%;" accept="image/*">',a=i(a),i("#"+o.target).css("overflow","hidden"),i("#"+o.target).css("position","relative"),i("#"+o.target).append(a),a.on("change",function(){var e=this;t._checkCanUpload(e,o,function(){t._checkFileSelect(e,o,function(){t._checkFileType(e,o,function(){t._readImage(e,o,function(){t._compressImage(e,o,function(){t._uploadImage(e,o)})})})})})})}}});