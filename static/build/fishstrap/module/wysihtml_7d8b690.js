define("fishstrap/module/wysihtml.js",function(e,t,n){var r={version:"0.5.0-beta13",commands:{},dom:{},quirks:{},toolbar:{},lang:{},selection:{},views:{},INVISIBLE_SPACE:"﻿",INVISIBLE_SPACE_REG_EXP:/\uFEFF/g,EMPTY_FUNCTION:function(){},ELEMENT_NODE:1,TEXT_NODE:3,BACKSPACE_KEY:8,ENTER_KEY:13,ESCAPE_KEY:27,SPACE_KEY:32,TAB_KEY:9,DELETE_KEY:46};r.polyfills=function(e,t){String.prototype.trim||!function(){var e=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;String.prototype.trim=function(){return this.replace(e,"")}}(),function(){var n="addEventListener",r="removeEventListener";t[n]||(e.Element.prototype[n]=e[n]=t[n]=function(t,n,r){return(r=this).attachEvent("on"+t,function(t){var t=t||e.event;t.target=t.target||t.srcElement,t.preventDefault=t.preventDefault||function(){t.returnValue=!1},t.stopPropagation=t.stopPropagation||function(){t.cancelBubble=!0},t.which=t.button?2===t.button?3:4===t.button?2:t.button:t.keyCode,n.call(r,t)})},e.Element.prototype[r]=e[r]=t[r]=function(e,t){return this.detachEvent("on"+e,t)})}(),Object.defineProperty&&Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(e.Element.prototype,"textContent")&&!Object.getOwnPropertyDescriptor(e.Element.prototype,"textContent").get&&!function(){var t=Object.getOwnPropertyDescriptor(e.Element.prototype,"innerText");Object.defineProperty(e.Element.prototype,"textContent",{get:function(){return t.get.call(this)},set:function(e){return t.set.call(this,e)}})}(),Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){for(var n=this.length,r=-1,o=t>>>0;~(n-o);r=this[--n]===e?n:r);return r}),Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),n=this,r=function(){},o=function(){return n.apply(this instanceof r&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return r.prototype=this.prototype,o.prototype=new r,o}),e.Element&&function(e){e.matches=e.matches||e.matchesSelector||e.mozMatchesSelector||e.msMatchesSelector||e.oMatchesSelector||e.webkitMatchesSelector||function(e){for(var t=this,n=(t.parentNode||t.document).querySelectorAll(e),r=-1;n[++r]&&n[r]!=t;);return!!n[r]}}(e.Element.prototype),"document"in e&&("classList"in t.createElement("_")?"DOMTokenList"in e&&!function(){"use strict";var n=t.createElement("_");if(n.classList.add("c1","c2"),!n.classList.contains("c2")){var r=function(t){var n=e.DOMTokenList.prototype[t];e.DOMTokenList.prototype[t]=function(e){var t,r=arguments.length;for(t=0;r>t;t++)e=arguments[t],n.call(this,e)}};r("add"),r("remove")}if(n.classList.toggle("c3",!1),n.classList.contains("c3")){var o=e.DOMTokenList.prototype.toggle;e.DOMTokenList.prototype.toggle=function(e,t){return 1 in arguments&&!this.contains(e)==!t?t:o.call(this,e)}}n=null}():!function(e){"use strict";if("Element"in e){var t="classList",n="prototype",r=e.Element[n],o=Object,i=String[n].trim||function(){return this.replace(/^\s+|\s+$/g,"")},s=Array[n].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1},a=function(e,t){this.name=e,this.code=DOMException[e],this.message=t},l=function(e,t){if(""===t)throw new a("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(t))throw new a("INVALID_CHARACTER_ERR","String contains an invalid character");return s.call(e,t)},c=function(e){for(var t=i.call(e.getAttribute("class")||""),n=t?t.split(/\s+/):[],r=0,o=n.length;o>r;r++)this.push(n[r]);this._updateClassName=function(){e.setAttribute("class",this.toString())}},d=c[n]=[],u=function(){return new c(this)};if(a[n]=Error[n],d.item=function(e){return this[e]||null},d.contains=function(e){return e+="",-1!==l(this,e)},d.add=function(){var e,t=arguments,n=0,r=t.length,o=!1;do e=t[n]+"",-1===l(this,e)&&(this.push(e),o=!0);while(++n<r);o&&this._updateClassName()},d.remove=function(){var e,t,n=arguments,r=0,o=n.length,i=!1;do for(e=n[r]+"",t=l(this,e);-1!==t;)this.splice(t,1),i=!0,t=l(this,e);while(++r<o);i&&this._updateClassName()},d.toggle=function(e,t){e+="";var n=this.contains(e),r=n?t!==!0&&"remove":t!==!1&&"add";return r&&this[r](e),t===!0||t===!1?t:!n},d.toString=function(){return this.join(" ")},o.defineProperty){var f={get:u,enumerable:!0,configurable:!0};try{o.defineProperty(r,t,f)}catch(h){-2146823252===h.number&&(f.enumerable=!1,o.defineProperty(r,t,f))}}else o[n].__defineGetter__&&r.__defineGetter__(t,u)}}(e));var n=function(){if("createRange"in document&&"getSelection"in window){var e,t,n=document.createElement("div"),r=document.createTextNode("a"),o=document.createTextNode("a"),i=document.createTextNode("a"),s=document.createRange();return n.setAttribute("contenteditable","true"),n.appendChild(r),n.appendChild(o),n.appendChild(i),document.body.appendChild(n),s.setStart(o,1),s.setEnd(o,1),e=window.getSelection(),e.removeAllRanges(),e.addRange(s),n.normalize(),e=window.getSelection(),t=1!==n.childNodes.length||e.anchorNode!==n.firstChild||2!==e.anchorOffset,n.parentNode.removeChild(n),e.removeAllRanges(),t}},r=function(e){var t=[];for(e=e.firstChild;e;e=e.nextSibling)3==e.nodeType?t.push(e):t=t.concat(r(e));return t},o=function(){var e=(Node.prototype.normalize,function(){var e=r(this),t=this.ownerDocument.defaultView.getSelection(),n=t.anchorNode,o=t.anchorOffset,i=n&&1===n.nodeType&&n.childNodes.length>0?n.childNodes[o]:void 0,s=t.focusNode,a=t.focusOffset,l=s&&1===s.nodeType&&a>0?s.childNodes[a-1]:void 0,c=this.ownerDocument.createRange(),d=e.shift(),u=d?e.shift():null;for((n===s&&o>a||n!==s&&n.compareDocumentPosition(s)&Node.DOCUMENT_POSITION_PRECEDING&&!(n.compareDocumentPosition(s)&Node.DOCUMENT_POSITION_CONTAINS))&&(s=[n,n=s][0],a=[o,o=a][0]);d&&u;)u.previousSibling&&u.previousSibling===d?(n===u&&(n=d,o=d.nodeValue.length+o),s===u&&(s=d,a=d.nodeValue.length+a),d.nodeValue=d.nodeValue+u.nodeValue,u.parentNode.removeChild(u),u=e.shift()):(d=u,u=e.shift());l&&(a=Array.prototype.indexOf.call(l.parentNode.childNodes,l)+1),i&&(o=Array.prototype.indexOf.call(i.parentNode.childNodes,i)),n&&n.parentNode&&s&&s.parentNode&&(c.setStart(n,o),c.setEnd(s,a),t.removeAllRanges(),t.addRange(c))});Node.prototype.normalize=e};"Node"in window&&"normalize"in Node.prototype&&n()&&o()},r.polyfills(window,document),function(e,t){t.rangy=e()}(function(){function e(e,t){var n=typeof e[t];return n==C||!(n!=b||!e[t])||"unknown"==n}function t(e,t){return!(typeof e[t]!=b||!e[t])}function n(e,t){return typeof e[t]!=N}function r(e){return function(t,n){for(var r=n.length;r--;)if(!e(t,n[r]))return!1;return!0}}function o(e){return e&&T(e,S)&&A(e,x)}function i(e){return t(e,"body")?e.body:e.getElementsByTagName("body")[0]}function s(t){typeof console!=N&&e(console,"log")&&console.log(t)}function a(e,t){L&&t?alert(e):s(e)}function l(e){P.initialized=!0,P.supported=!1,a("Rangy is not supported in this environment. Reason: "+e,P.config.alertOnFail)}function c(e){a("Rangy warning: "+e,P.config.alertOnWarn)}function d(e){return e.message||e.description||String(e)}function u(){if(L&&!P.initialized){var t,n=!1,r=!1;e(document,"createRange")&&(t=document.createRange(),T(t,E)&&A(t,w)&&(n=!0));var a=i(document);if(!a||"body"!=a.nodeName.toLowerCase())return void l("No body element found");if(a&&e(a,"createTextRange")&&(t=a.createTextRange(),o(t)&&(r=!0)),!n&&!r)return void l("Neither Range nor TextRange are available");P.initialized=!0,P.features={implementsDomRange:n,implementsTextRange:r};var c,u;for(var f in O)(c=O[f])instanceof p&&c.init(c,P);for(var h=0,m=M.length;m>h;++h)try{M[h](P)}catch(g){u="Rangy init listener threw an exception. Continuing. Detail: "+d(g),s(u)}}}function f(e,t,n){n&&(e+=" in module "+n.name),P.warn("DEPRECATED: "+e+" is deprecated. Please use "+t+" instead.")}function h(e,t,n,r){e[t]=function(){return f(t,n,r),e[n].apply(e,I.toArray(arguments))}}function m(e){e=e||window,u();for(var t=0,n=B.length;n>t;++t)B[t](e)}function p(e,t,n){this.name=e,this.dependencies=t,this.initialized=!1,this.supported=!1,this.initializer=n}function g(e,t,n){var r=new p(e,t,function(t){if(!t.initialized){t.initialized=!0;try{n(P,t),t.supported=!0}catch(r){var o="Module '"+e+"' failed to load: "+d(r);s(o),r.stack&&s(r.stack)}}});return O[e]=r,r}function v(){}function y(){}var b="object",C="function",N="undefined",w=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],E=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],x=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],S=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],T=r(e),R=r(t),A=r(n),_=[].forEach?function(e,t){e.forEach(t)}:function(e,t){for(var n=0,r=e.length;r>n;++n)t(e[n],n)},O={},L=typeof window!=N&&typeof document!=N,I={isHostMethod:e,isHostObject:t,isHostProperty:n,areHostMethods:T,areHostObjects:R,areHostProperties:A,isTextRange:o,getBody:i,forEach:_},P={version:"1.3.0",initialized:!1,isBrowser:L,supported:!0,util:I,features:{},modules:O,config:{alertOnFail:!1,alertOnWarn:!1,preferTextRange:!1,autoInitialize:typeof rangyAutoInitialize==N?!0:rangyAutoInitialize}};P.fail=l,P.warn=c;var D;({}).hasOwnProperty?(I.extend=D=function(e,t,n){var r,o;for(var i in t)t.hasOwnProperty(i)&&(r=e[i],o=t[i],n&&null!==r&&"object"==typeof r&&null!==o&&"object"==typeof o&&D(r,o,!0),e[i]=o);return t.hasOwnProperty("toString")&&(e.toString=t.toString),e},I.createOptions=function(e,t){var n={};return D(n,t),e&&D(n,e),n}):l("hasOwnProperty not supported"),L||l("Rangy can only run in a browser"),function(){var e;if(L){var t=document.createElement("div");t.appendChild(document.createElement("span"));var n=[].slice;try{1==n.call(t.childNodes,0)[0].nodeType&&(e=function(e){return n.call(e,0)})}catch(r){}}e||(e=function(e){for(var t=[],n=0,r=e.length;r>n;++n)t[n]=e[n];return t}),I.toArray=e}();var k;L&&(e(document,"addEventListener")?k=function(e,t,n){e.addEventListener(t,n,!1)}:e(document,"attachEvent")?k=function(e,t,n){e.attachEvent("on"+t,n)}:l("Document does not have required addEventListener or attachEvent method"),I.addListener=k);var M=[];I.deprecationNotice=f,I.createAliasForDeprecatedMethod=h,P.init=u,P.addInitListener=function(e){P.initialized?e(P):M.push(e)};var B=[];P.addShimListener=function(e){B.push(e)},L&&(P.shim=P.createMissingNativeApi=m,h(P,"createMissingNativeApi","shim")),p.prototype={init:function(){for(var e,t,n=this.dependencies||[],r=0,o=n.length;o>r;++r){if(t=n[r],e=O[t],!(e&&e instanceof p))throw new Error("required module '"+t+"' not found");if(e.init(),!e.supported)throw new Error("required module '"+t+"' not supported")}this.initializer(this)},fail:function(e){throw this.initialized=!0,this.supported=!1,new Error(e)},warn:function(e){P.warn("Module "+this.name+": "+e)},deprecationNotice:function(e,t){P.warn("DEPRECATED: "+e+" in module "+this.name+" is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in Rangy "+this.name+" module: "+e)}},P.createModule=function(e){var t,n;2==arguments.length?(t=arguments[1],n=[]):(t=arguments[2],n=arguments[1]);var r=g(e,n,t);P.initialized&&P.supported&&r.init()},P.createCoreModule=function(e,t,n){g(e,t,n)},P.RangePrototype=v,P.rangePrototype=new v,P.selectionPrototype=new y,P.createCoreModule("DomUtil",[],function(e,t){function n(e){var t;return typeof e.namespaceURI==L||null===(t=e.namespaceURI)||"http://www.w3.org/1999/xhtml"==t}function r(e){var t=e.parentNode;return 1==t.nodeType?t:null}function o(e){for(var t=0;e=e.previousSibling;)++t;return t}function i(e){switch(e.nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}}function s(e,t){var n,r=[];for(n=e;n;n=n.parentNode)r.push(n);for(n=t;n;n=n.parentNode)if(M(r,n))return n;return null}function a(e,t,n){for(var r=n?t:t.parentNode;r;){if(r===e)return!0;r=r.parentNode}return!1}function l(e,t){return a(e,t,!0)}function c(e,t,n){for(var r,o=n?e:e.parentNode;o;){if(r=o.parentNode,r===t)return o;o=r}return null}function d(e){var t=e.nodeType;return 3==t||4==t||8==t}function u(e){if(!e)return!1;var t=e.nodeType;return 3==t||8==t}function f(e,t){var n=t.nextSibling,r=t.parentNode;return n?r.insertBefore(e,n):r.appendChild(e),e}function h(e,t,n){var r=e.cloneNode(!1);if(r.deleteData(0,t),e.deleteData(t,e.length-t),f(r,e),n)for(var i,s=0;i=n[s++];)i.node==e&&i.offset>t?(i.node=r,i.offset-=t):i.node==e.parentNode&&i.offset>o(e)&&++i.offset;return r}function m(e){if(9==e.nodeType)return e;if(typeof e.ownerDocument!=L)return e.ownerDocument;if(typeof e.document!=L)return e.document;if(e.parentNode)return m(e.parentNode);throw t.createError("getDocument: no document found for node")}function p(e){var n=m(e);if(typeof n.defaultView!=L)return n.defaultView;if(typeof n.parentWindow!=L)return n.parentWindow;throw t.createError("Cannot get a window object for node")}function g(e){if(typeof e.contentDocument!=L)return e.contentDocument;if(typeof e.contentWindow!=L)return e.contentWindow.document;throw t.createError("getIframeDocument: No Document object found for iframe element")}function v(e){if(typeof e.contentWindow!=L)return e.contentWindow;if(typeof e.contentDocument!=L)return e.contentDocument.defaultView;throw t.createError("getIframeWindow: No Window object found for iframe element")}function y(e){return e&&I.isHostMethod(e,"setTimeout")&&I.isHostObject(e,"document")}function b(e,t,n){var r;if(e?I.isHostProperty(e,"nodeType")?r=1==e.nodeType&&"iframe"==e.tagName.toLowerCase()?g(e):m(e):y(e)&&(r=e.document):r=document,!r)throw t.createError(n+"(): Parameter must be a Window object or DOM node");return r}function C(e){for(var t;t=e.parentNode;)e=t;return e}function N(e,n,r,i){var a,l,d,u,f;if(e==r)return n===i?0:i>n?-1:1;if(a=c(r,e,!0))return n<=o(a)?-1:1;if(a=c(e,r,!0))return o(a)<i?-1:1;if(l=s(e,r),!l)throw new Error("comparePoints error: nodes have no common ancestor");if(d=e===l?l:c(e,l,!0),u=r===l?l:c(r,l,!0),d===u)throw t.createError("comparePoints got to case 4 and childA and childB are the same!");for(f=l.firstChild;f;){if(f===d)return-1;if(f===u)return 1;f=f.nextSibling}}function w(e){var t;try{return t=e.parentNode,!1}catch(n){return!0}}function E(e){if(!e)return"[No node]";if(B&&w(e))return"[Broken node]";if(d(e))return'"'+e.data+'"';if(1==e.nodeType){var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">[index:"+o(e)+",length:"+e.childNodes.length+"]["+(e.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return e.nodeName}function x(e){for(var t,n=m(e).createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n}function S(e,t,n){var r=P(e),o=e.createElement("div");o.contentEditable=""+!!n,t&&(o.innerHTML=t);var i=r.firstChild;return i?r.insertBefore(o,i):r.appendChild(o),o}function T(e){return e.parentNode.removeChild(e)}function R(e){this.root=e,this._next=e}function A(e){return new R(e)}function _(e,t){this.node=e,this.offset=t}function O(e){this.code=this[e],this.codeName=e,this.message="DOMException: "+this.codeName}var L="undefined",I=e.util,P=I.getBody;I.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||t.fail("document missing a Node creation method"),I.isHostMethod(document,"getElementsByTagName")||t.fail("document missing getElementsByTagName method");var D=document.createElement("div");I.areHostMethods(D,["insertBefore","appendChild","cloneNode"]||!I.areHostObjects(D,["previousSibling","nextSibling","childNodes","parentNode"]))||t.fail("Incomplete Element implementation"),I.isHostProperty(D,"innerHTML")||t.fail("Element is missing innerHTML property");var k=document.createTextNode("test");I.areHostMethods(k,["splitText","deleteData","insertData","appendData","cloneNode"]||!I.areHostObjects(D,["previousSibling","nextSibling","childNodes","parentNode"])||!I.areHostProperties(k,["data"]))||t.fail("Incomplete Text Node implementation");var M=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1},B=!1;!function(){var t=document.createElement("b");t.innerHTML="1";var n=t.firstChild;t.innerHTML="<br />",B=w(n),e.features.crashyTextNodes=B}();var H;typeof window.getComputedStyle!=L?H=function(e,t){return p(e).getComputedStyle(e,null)[t]}:typeof document.documentElement.currentStyle!=L?H=function(e,t){return e.currentStyle?e.currentStyle[t]:""}:t.fail("No means of obtaining computed style properties found"),R.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var e,t,n=this._current=this._next;if(this._current)if(e=n.firstChild)this._next=e;else{for(t=null;n!==this.root&&!(t=n.nextSibling);)n=n.parentNode;this._next=t}return this._current},detach:function(){this._current=this._next=this.root=null}},_.prototype={equals:function(e){return!!e&&this.node===e.node&&this.offset==e.offset},inspect:function(){return"[DomPosition("+E(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},O.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24},O.prototype.toString=function(){return this.message},e.dom={arrayContains:M,isHtmlNamespace:n,parentElement:r,getNodeIndex:o,getNodeLength:i,getCommonAncestor:s,isAncestorOf:a,isOrIsAncestorOf:l,getClosestAncestorIn:c,isCharacterDataNode:d,isTextOrCommentNode:u,insertAfter:f,splitDataNode:h,getDocument:m,getWindow:p,getIframeWindow:v,getIframeDocument:g,getBody:P,isWindow:y,getContentDocument:b,getRootContainer:C,comparePoints:N,isBrokenNode:w,inspectNode:E,getComputedStyleProperty:H,createTestElement:S,removeNode:T,fragmentFromNodeChildren:x,createIterator:A,DomPosition:_},e.DOMException=O}),P.createCoreModule("DomRange",["DomUtil"],function(e){function t(e,t){return 3!=e.nodeType&&(q(e,t.startContainer)||q(e,t.endContainer))}function n(e){return e.document||j(e.startContainer)}function r(e){return K(e.startContainer)}function o(e){return new M(e.parentNode,V(e))}function i(e){return new M(e.parentNode,V(e)+1)}function s(e,t,n){var r=11==e.nodeType?e.firstChild:e;return H(t)?n==t.length?D.insertAfter(e,t):t.parentNode.insertBefore(e,0==n?t:z(t,n)):n>=t.childNodes.length?t.appendChild(e):t.insertBefore(e,t.childNodes[n]),r}function a(e,t,r){if(x(e),x(t),n(t)!=n(e))throw new B("WRONG_DOCUMENT_ERR");var o=F(e.startContainer,e.startOffset,t.endContainer,t.endOffset),i=F(e.endContainer,e.endOffset,t.startContainer,t.startOffset);return r?0>=o&&i>=0:0>o&&i>0}function l(e){for(var t,r,o,i=n(e.range).createDocumentFragment();r=e.next();){if(t=e.isPartiallySelectedSubtree(),r=r.cloneNode(!t),t&&(o=e.getSubtreeIterator(),r.appendChild(l(o)),o.detach()),10==r.nodeType)throw new B("HIERARCHY_REQUEST_ERR");i.appendChild(r)}return i}function c(e,t,n){var r,o;n=n||{stop:!1};for(var i,s;i=e.next();)if(e.isPartiallySelectedSubtree()){if(t(i)===!1)return void(n.stop=!0);if(s=e.getSubtreeIterator(),c(s,t,n),s.detach(),n.stop)return}else for(r=D.createIterator(i);o=r.next();)if(t(o)===!1)return void(n.stop=!0)}function d(e){for(var t;e.next();)e.isPartiallySelectedSubtree()?(t=e.getSubtreeIterator(),d(t),t.detach()):e.remove()}function u(e){for(var t,r,o=n(e.range).createDocumentFragment();t=e.next();){if(e.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),r=e.getSubtreeIterator(),t.appendChild(u(r)),r.detach()):e.remove(),10==t.nodeType)throw new B("HIERARCHY_REQUEST_ERR");o.appendChild(t)}return o}function f(e,t,n){var r,o=!(!t||!t.length),i=!!n;o&&(r=new RegExp("^("+t.join("|")+")$"));var s=[];return c(new m(e,!1),function(t){if(!(o&&!r.test(t.nodeType)||i&&!n(t))){var a=e.startContainer;if(t!=a||!H(a)||e.startOffset!=a.length){var l=e.endContainer;t==l&&H(l)&&0==e.endOffset||s.push(t)}}}),s}function h(e){var t="undefined"==typeof e.getName?"Range":e.getName();return"["+t+"("+D.inspectNode(e.startContainer)+":"+e.startOffset+", "+D.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function m(e,t){if(this.range=e,this.clonePartiallySelectedTextNodes=t,!e.collapsed){this.sc=e.startContainer,this.so=e.startOffset,this.ec=e.endContainer,this.eo=e.endOffset;var n=e.commonAncestorContainer;this.sc===this.ec&&H(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||H(this.sc)?U(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||H(this.ec)?U(this.ec,n,!0):this.ec.childNodes[this.eo-1])}}function p(e){return function(t,n){for(var r,o=n?t:t.parentNode;o;){if(r=o.nodeType,$(e,r))return o;o=o.parentNode}return null}}function g(e,t){if(rt(e,t))throw new B("INVALID_NODE_TYPE_ERR")}function v(e,t){if(!$(t,e.nodeType))throw new B("INVALID_NODE_TYPE_ERR")}function y(e,t){if(0>t||t>(H(e)?e.length:e.childNodes.length))throw new B("INDEX_SIZE_ERR")}function b(e,t){if(tt(e,!0)!==tt(t,!0))throw new B("WRONG_DOCUMENT_ERR")}function C(e){if(nt(e,!0))throw new B("NO_MODIFICATION_ALLOWED_ERR")}function N(e,t){if(!e)throw new B(t)}function w(e,t){return t<=(H(e)?e.length:e.childNodes.length)}function E(e){return!!e.startContainer&&!!e.endContainer&&!(G&&(D.isBrokenNode(e.startContainer)||D.isBrokenNode(e.endContainer)))&&K(e.startContainer)==K(e.endContainer)&&w(e.startContainer,e.startOffset)&&w(e.endContainer,e.endOffset)}function x(e){if(!E(e))throw new Error("Range error: Range is not valid. This usually happens after DOM mutation. Range: ("+e.inspect()+")")}function S(e,t){x(e);var n=e.startContainer,r=e.startOffset,o=e.endContainer,i=e.endOffset,s=n===o;H(o)&&i>0&&i<o.length&&z(o,i,t),H(n)&&r>0&&r<n.length&&(n=z(n,r,t),s?(i-=r,o=n):o==n.parentNode&&i>=V(n)&&i++,r=0),e.setStartAndEnd(n,r,o,i)}function T(e){x(e);var t=e.commonAncestorContainer.parentNode.cloneNode(!1);return t.appendChild(e.cloneContents()),t.innerHTML}function R(e){e.START_TO_START=ct,e.START_TO_END=dt,e.END_TO_END=ut,e.END_TO_START=ft,e.NODE_BEFORE=ht,e.NODE_AFTER=mt,e.NODE_BEFORE_AND_AFTER=pt,e.NODE_INSIDE=gt}function A(e){R(e),R(e.prototype)}function _(e,t){return function(){x(this);var n,r,o=this.startContainer,s=this.startOffset,a=this.commonAncestorContainer,l=new m(this,!0);o!==a&&(n=U(o,a,!0),r=i(n),o=r.node,s=r.offset),c(l,C),l.reset();var d=e(l);return l.detach(),t(this,o,s,o,s),d}}function O(n,r){function s(e,t){return function(n){v(n,Y),v(K(n),Q);var r=(e?o:i)(n);(t?a:l)(this,r.node,r.offset)}}function a(e,t,n){var o=e.endContainer,i=e.endOffset;(t!==e.startContainer||n!==e.startOffset)&&((K(t)!=K(o)||1==F(t,n,o,i))&&(o=t,i=n),r(e,t,n,o,i))}function l(e,t,n){var o=e.startContainer,i=e.startOffset;(t!==e.endContainer||n!==e.endOffset)&&((K(t)!=K(o)||-1==F(t,n,o,i))&&(o=t,i=n),r(e,o,i,t,n))}var c=function(){};c.prototype=e.rangePrototype,n.prototype=new c,k.extend(n.prototype,{setStart:function(e,t){g(e,!0),y(e,t),a(this,e,t)},setEnd:function(e,t){g(e,!0),y(e,t),l(this,e,t)},setStartAndEnd:function(){var e=arguments,t=e[0],n=e[1],o=t,i=n;switch(e.length){case 3:i=e[2];break;case 4:o=e[2],i=e[3]}r(this,t,n,o,i)},setBoundary:function(e,t,n){this["set"+(n?"Start":"End")](e,t)},setStartBefore:s(!0,!0),setStartAfter:s(!1,!0),setEndBefore:s(!0,!1),setEndAfter:s(!1,!1),collapse:function(e){x(this),e?r(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):r(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(e){g(e,!0),r(this,e,0,e,W(e))},selectNode:function(e){g(e,!1),v(e,Y);var t=o(e),n=i(e);r(this,t.node,t.offset,n.node,n.offset)},extractContents:_(u,r),deleteContents:_(d,r),canSurroundContents:function(){x(this),C(this.startContainer),C(this.endContainer);var e=new m(this,!0),n=e._first&&t(e._first,this)||e._last&&t(e._last,this);return e.detach(),!n},splitBoundaries:function(){S(this)},splitBoundariesPreservingPositions:function(e){S(this,e)},normalizeBoundaries:function(){x(this);var e,t=this.startContainer,n=this.startOffset,o=this.endContainer,i=this.endOffset,s=function(e){var t=e.nextSibling;t&&t.nodeType==e.nodeType&&(o=e,i=e.length,e.appendData(t.data),X(t))},a=function(e){var r=e.previousSibling;if(r&&r.nodeType==e.nodeType){t=e;var s=e.length;if(n=r.length,e.insertData(0,r.data),X(r),t==o)i+=n,o=t;else if(o==e.parentNode){var a=V(e);i==a?(o=e,i=s):i>a&&i--}}},l=!0;if(H(o))i==o.length?s(o):0==i&&(e=o.previousSibling,e&&e.nodeType==o.nodeType&&(i=e.length,t==o&&(l=!1),e.appendData(o.data),X(o),o=e));else{if(i>0){var c=o.childNodes[i-1];c&&H(c)&&s(c)}l=!this.collapsed}if(l){if(H(t))0==n?a(t):n==t.length&&(e=t.nextSibling,e&&e.nodeType==t.nodeType&&(o==e&&(o=t,i+=t.length),t.appendData(e.data),X(e)));else if(n<t.childNodes.length){var d=t.childNodes[n];d&&H(d)&&a(d)}}else t=o,n=i;r(this,t,n,o,i)},collapseToPoint:function(e,t){g(e,!0),y(e,t),this.setStartAndEnd(e,t)}}),A(n)}function L(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e.commonAncestorContainer=e.collapsed?e.startContainer:D.getCommonAncestor(e.startContainer,e.endContainer)}function I(e,t,n,r,o){e.startContainer=t,e.startOffset=n,e.endContainer=r,e.endOffset=o,e.document=D.getDocument(t),L(e)}function P(e){this.startContainer=e,this.startOffset=0,this.endContainer=e,this.endOffset=0,this.document=e,L(this)}var D=e.dom,k=e.util,M=D.DomPosition,B=e.DOMException,H=D.isCharacterDataNode,V=D.getNodeIndex,q=D.isOrIsAncestorOf,j=D.getDocument,F=D.comparePoints,z=D.splitDataNode,U=D.getClosestAncestorIn,W=D.getNodeLength,$=D.arrayContains,K=D.getRootContainer,G=e.features.crashyTextNodes,X=D.removeNode;m.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return e&&(this._next=e!==this._last?e.nextSibling:null,H(e)&&this.clonePartiallySelectedTextNodes&&(e===this.ec&&(e=e.cloneNode(!0)).deleteData(this.eo,e.length-this.eo),this._current===this.sc&&(e=e.cloneNode(!0)).deleteData(0,this.so))),e},remove:function(){var e,t,n=this._current;!H(n)||n!==this.sc&&n!==this.ec?n.parentNode&&X(n):(e=n===this.sc?this.so:0,t=n===this.ec?this.eo:n.length,e!=t&&n.deleteData(e,t-e))},isPartiallySelectedSubtree:function(){var e=this._current;return t(e,this.range)},getSubtreeIterator:function(){var e;if(this.isSingleCharacterDataNode)e=this.range.cloneRange(),e.collapse(!1);else{e=new P(n(this.range));var t=this._current,r=t,o=0,i=t,s=W(t);q(t,this.sc)&&(r=this.sc,o=this.so),q(t,this.ec)&&(i=this.ec,s=this.eo),I(e,r,o,i,s)}return new m(e,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var Y=[1,3,4,5,7,8,10],Q=[2,9,11],Z=[5,6,10,12],J=[1,3,4,5,7,8,10,11],et=[1,3,4,5,7,8],tt=p([9,11]),nt=p(Z),rt=p([6,10,12]),ot=document.createElement("style"),it=!1;try{ot.innerHTML="<b>x</b>",it=3==ot.firstChild.nodeType}catch(st){}e.features.htmlParsingConforms=it;var at=it?function(e){var t=this.startContainer,n=j(t);if(!t)throw new B("INVALID_STATE_ERR");var r=null;return 1==t.nodeType?r=t:H(t)&&(r=D.parentElement(t)),r=null===r||"HTML"==r.nodeName&&D.isHtmlNamespace(j(r).documentElement)&&D.isHtmlNamespace(r)?n.createElement("body"):r.cloneNode(!1),r.innerHTML=e,D.fragmentFromNodeChildren(r)}:function(e){var t=n(this),r=t.createElement("body");return r.innerHTML=e,D.fragmentFromNodeChildren(r)},lt=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],ct=0,dt=1,ut=2,ft=3,ht=0,mt=1,pt=2,gt=3;k.extend(e.rangePrototype,{compareBoundaryPoints:function(e,t){x(this),b(this.startContainer,t.startContainer);var n,r,o,i,s=e==ft||e==ct?"start":"end",a=e==dt||e==ct?"start":"end";return n=this[s+"Container"],r=this[s+"Offset"],o=t[a+"Container"],i=t[a+"Offset"],F(n,r,o,i)},insertNode:function(e){if(x(this),v(e,J),C(this.startContainer),q(e,this.startContainer))throw new B("HIERARCHY_REQUEST_ERR");var t=s(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){x(this);var e,t;if(this.collapsed)return n(this).createDocumentFragment();if(this.startContainer===this.endContainer&&H(this.startContainer))return e=this.startContainer.cloneNode(!0),e.data=e.data.slice(this.startOffset,this.endOffset),t=n(this).createDocumentFragment(),t.appendChild(e),t;var r=new m(this,!0);return e=l(r),r.detach(),e},canSurroundContents:function(){x(this),C(this.startContainer),C(this.endContainer);var e=new m(this,!0),n=e._first&&t(e._first,this)||e._last&&t(e._last,this);return e.detach(),!n},surroundContents:function(e){if(v(e,et),!this.canSurroundContents())throw new B("INVALID_STATE_ERR");var t=this.extractContents();if(e.hasChildNodes())for(;e.lastChild;)e.removeChild(e.lastChild);s(e,this.startContainer,this.startOffset),e.appendChild(t),this.selectNode(e)},cloneRange:function(){x(this);for(var e,t=new P(n(this)),r=lt.length;r--;)e=lt[r],t[e]=this[e];return t},toString:function(){x(this);var e=this.startContainer;if(e===this.endContainer&&H(e))return 3==e.nodeType||4==e.nodeType?e.data.slice(this.startOffset,this.endOffset):"";var t=[],n=new m(this,!0);return c(n,function(e){(3==e.nodeType||4==e.nodeType)&&t.push(e.data)}),n.detach(),t.join("")},compareNode:function(e){x(this);var t=e.parentNode,n=V(e);if(!t)throw new B("NOT_FOUND_ERR");var r=this.comparePoint(t,n),o=this.comparePoint(t,n+1);return 0>r?o>0?pt:ht:o>0?mt:gt},comparePoint:function(e,t){return x(this),N(e,"HIERARCHY_REQUEST_ERR"),b(e,this.startContainer),F(e,t,this.startContainer,this.startOffset)<0?-1:F(e,t,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:at,toHtml:function(){return T(this)},intersectsNode:function(e,t){if(x(this),K(e)!=r(this))return!1;var n=e.parentNode,o=V(e);if(!n)return!0;var i=F(n,o,this.endContainer,this.endOffset),s=F(n,o+1,this.startContainer,this.startOffset);return t?0>=i&&s>=0:0>i&&s>0},isPointInRange:function(e,t){return x(this),N(e,"HIERARCHY_REQUEST_ERR"),b(e,this.startContainer),F(e,t,this.startContainer,this.startOffset)>=0&&F(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e){return a(this,e,!1)},intersectsOrTouchesRange:function(e){return a(this,e,!0)},intersection:function(e){if(this.intersectsRange(e)){var t=F(this.startContainer,this.startOffset,e.startContainer,e.startOffset),n=F(this.endContainer,this.endOffset,e.endContainer,e.endOffset),r=this.cloneRange();return-1==t&&r.setStart(e.startContainer,e.startOffset),1==n&&r.setEnd(e.endContainer,e.endOffset),r}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var t=this.cloneRange();return-1==F(e.startContainer,e.startOffset,this.startContainer,this.startOffset)&&t.setStart(e.startContainer,e.startOffset),1==F(e.endContainer,e.endOffset,this.endContainer,this.endOffset)&&t.setEnd(e.endContainer,e.endOffset),t}throw new B("Ranges do not intersect")},containsNode:function(e,t){return t?this.intersectsNode(e,!1):this.compareNode(e)==gt},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,W(e))<=0},containsRange:function(e){var t=this.intersection(e);return null!==t&&e.equals(t)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(n.length>0){t.setStart(n[0],0);var r=n.pop();return t.setEnd(r,r.length),this.containsRange(t)}return this.containsNodeContents(e)},getNodes:function(e,t){return x(this),f(this,e,t)},getDocument:function(){return n(this)},collapseBefore:function(e){this.setEndBefore(e),this.collapse(!1)},collapseAfter:function(e){this.setStartAfter(e),this.collapse(!0)},getBookmark:function(t){var r=n(this),o=e.createRange(r);t=t||D.getBody(r),o.selectNodeContents(t);var i=this.intersection(o),s=0,a=0;
return i&&(o.setEnd(i.startContainer,i.startOffset),s=o.toString().length,a=s+i.toString().length),{start:s,end:a,containerNode:t}},moveToBookmark:function(e){var t=e.containerNode,n=0;this.setStart(t,0),this.collapse(!0);for(var r,o,i,s,a=[t],l=!1,c=!1;!c&&(r=a.pop());)if(3==r.nodeType)o=n+r.length,!l&&e.start>=n&&e.start<=o&&(this.setStart(r,e.start-n),l=!0),l&&e.end>=n&&e.end<=o&&(this.setEnd(r,e.end-n),c=!0),n=o;else for(s=r.childNodes,i=s.length;i--;)a.push(s[i])},getName:function(){return"DomRange"},equals:function(e){return P.rangesEqual(this,e)},isValid:function(){return E(this)},inspect:function(){return h(this)},detach:function(){}}),O(P,I),k.extend(P,{rangeProperties:lt,RangeIterator:m,copyComparisonConstants:A,createPrototypeRange:O,inspect:h,toHtml:T,getRangeDocument:n,rangesEqual:function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset}}),e.DomRange=P}),P.createCoreModule("WrappedRange",["DomRange"],function(e,t){var n,r,o=e.dom,i=e.util,s=o.DomPosition,a=e.DomRange,l=o.getBody,c=o.getContentDocument,d=o.isCharacterDataNode;if(e.features.implementsDomRange&&!function(){function r(e){for(var t,n=f.length;n--;)t=f[n],e[t]=e.nativeRange[t];e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset}function s(e,t,n,r,o){var i=e.startContainer!==t||e.startOffset!=n,s=e.endContainer!==r||e.endOffset!=o,a=!e.equals(e.nativeRange);(i||s||a)&&(e.setEnd(r,o),e.setStart(t,n))}var d,u,f=a.rangeProperties;n=function(e){if(!e)throw t.createError("WrappedRange: Range must be specified");this.nativeRange=e,r(this)},a.createPrototypeRange(n,s),d=n.prototype,d.selectNode=function(e){this.nativeRange.selectNode(e),r(this)},d.cloneContents=function(){return this.nativeRange.cloneContents()},d.surroundContents=function(e){this.nativeRange.surroundContents(e),r(this)},d.collapse=function(e){this.nativeRange.collapse(e),r(this)},d.cloneRange=function(){return new n(this.nativeRange.cloneRange())},d.refresh=function(){r(this)},d.toString=function(){return this.nativeRange.toString()};var h=document.createTextNode("test");l(document).appendChild(h);var m=document.createRange();m.setStart(h,0),m.setEnd(h,0);try{m.setStart(h,1),d.setStart=function(e,t){this.nativeRange.setStart(e,t),r(this)},d.setEnd=function(e,t){this.nativeRange.setEnd(e,t),r(this)},u=function(e){return function(t){this.nativeRange[e](t),r(this)}}}catch(p){d.setStart=function(e,t){try{this.nativeRange.setStart(e,t)}catch(n){this.nativeRange.setEnd(e,t),this.nativeRange.setStart(e,t)}r(this)},d.setEnd=function(e,t){try{this.nativeRange.setEnd(e,t)}catch(n){this.nativeRange.setStart(e,t),this.nativeRange.setEnd(e,t)}r(this)},u=function(e,t){return function(n){try{this.nativeRange[e](n)}catch(o){this.nativeRange[t](n),this.nativeRange[e](n)}r(this)}}}d.setStartBefore=u("setStartBefore","setEndBefore"),d.setStartAfter=u("setStartAfter","setEndAfter"),d.setEndBefore=u("setEndBefore","setStartBefore"),d.setEndAfter=u("setEndAfter","setStartAfter"),d.selectNodeContents=function(e){this.setStartAndEnd(e,0,o.getNodeLength(e))},m.selectNodeContents(h),m.setEnd(h,3);var g=document.createRange();g.selectNodeContents(h),g.setEnd(h,4),g.setStart(h,2),d.compareBoundaryPoints=-1==m.compareBoundaryPoints(m.START_TO_END,g)&&1==m.compareBoundaryPoints(m.END_TO_START,g)?function(e,t){return t=t.nativeRange||t,e==t.START_TO_END?e=t.END_TO_START:e==t.END_TO_START&&(e=t.START_TO_END),this.nativeRange.compareBoundaryPoints(e,t)}:function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)};var v=document.createElement("div");v.innerHTML="123";var y=v.firstChild,b=l(document);b.appendChild(v),m.setStart(y,1),m.setEnd(y,2),m.deleteContents(),"13"==y.data&&(d.deleteContents=function(){this.nativeRange.deleteContents(),r(this)},d.extractContents=function(){var e=this.nativeRange.extractContents();return r(this),e}),b.removeChild(v),b=null,i.isHostMethod(m,"createContextualFragment")&&(d.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}),l(document).removeChild(h),d.getName=function(){return"WrappedRange"},e.WrappedRange=n,e.createNativeRange=function(e){return e=c(e,t,"createNativeRange"),e.createRange()}}(),e.features.implementsTextRange){var u=function(e){var t=e.parentElement(),n=e.duplicate();n.collapse(!0);var r=n.parentElement();n=e.duplicate(),n.collapse(!1);var i=n.parentElement(),s=r==i?r:o.getCommonAncestor(r,i);return s==t?s:o.getCommonAncestor(t,s)},f=function(e){return 0==e.compareEndPoints("StartToEnd",e)},h=function(e,t,n,r,i){var a=e.duplicate();a.collapse(n);var l=a.parentElement();if(o.isOrIsAncestorOf(t,l)||(l=t),!l.canHaveHTML){var c=new s(l.parentNode,o.getNodeIndex(l));return{boundaryPosition:c,nodeInfo:{nodeIndex:c.offset,containerElement:c.node}}}var u=o.getDocument(l).createElement("span");u.parentNode&&o.removeNode(u);for(var f,h,m,p,g,v=n?"StartToStart":"StartToEnd",y=i&&i.containerElement==l?i.nodeIndex:0,b=l.childNodes.length,C=b,N=C;;){if(N==b?l.appendChild(u):l.insertBefore(u,l.childNodes[N]),a.moveToElementText(u),f=a.compareEndPoints(v,e),0==f||y==C)break;if(-1==f){if(C==y+1)break;y=N}else C=C==y+1?y:N;N=Math.floor((y+C)/2),l.removeChild(u)}if(g=u.nextSibling,-1==f&&g&&d(g)){a.setEndPoint(n?"EndToStart":"EndToEnd",e);var w;if(/[\r\n]/.test(g.data)){var E=a.duplicate(),x=E.text.replace(/\r\n/g,"\r").length;for(w=E.moveStart("character",x);-1==(f=E.compareEndPoints("StartToEnd",E));)w++,E.moveStart("character",1)}else w=a.text.length;p=new s(g,w)}else h=(r||!n)&&u.previousSibling,m=(r||n)&&u.nextSibling,p=m&&d(m)?new s(m,0):h&&d(h)?new s(h,h.data.length):new s(l,o.getNodeIndex(u));return o.removeNode(u),{boundaryPosition:p,nodeInfo:{nodeIndex:N,containerElement:l}}},m=function(e,t){var n,r,i,s,a=e.offset,c=o.getDocument(e.node),u=l(c).createTextRange(),f=d(e.node);return f?(n=e.node,r=n.parentNode):(s=e.node.childNodes,n=a<s.length?s[a]:null,r=e.node),i=c.createElement("span"),i.innerHTML="&#feff;",n?r.insertBefore(i,n):r.appendChild(i),u.moveToElementText(i),u.collapse(!t),r.removeChild(i),f&&u[t?"moveStart":"moveEnd"]("character",a),u};r=function(e){this.textRange=e,this.refresh()},r.prototype=new a(document),r.prototype.refresh=function(){var e,t,n,r=u(this.textRange);f(this.textRange)?t=e=h(this.textRange,r,!0,!0).boundaryPosition:(n=h(this.textRange,r,!0,!1),e=n.boundaryPosition,t=h(this.textRange,r,!1,!1,n.nodeInfo).boundaryPosition),this.setStart(e.node,e.offset),this.setEnd(t.node,t.offset)},r.prototype.getName=function(){return"WrappedTextRange"},a.copyComparisonConstants(r);var p=function(e){if(e.collapsed)return m(new s(e.startContainer,e.startOffset),!0);var t=m(new s(e.startContainer,e.startOffset),!0),n=m(new s(e.endContainer,e.endOffset),!1),r=l(a.getRangeDocument(e)).createTextRange();return r.setEndPoint("StartToStart",t),r.setEndPoint("EndToEnd",n),r};if(r.rangeToTextRange=p,r.prototype.toTextRange=function(){return p(this)},e.WrappedTextRange=r,!e.features.implementsDomRange||e.config.preferTextRange){var g=function(e){return e("return this;")()}(Function);"undefined"==typeof g.Range&&(g.Range=r),e.createNativeRange=function(e){return e=c(e,t,"createNativeRange"),l(e).createTextRange()},e.WrappedRange=r}}e.createRange=function(n){return n=c(n,t,"createRange"),new e.WrappedRange(e.createNativeRange(n))},e.createRangyRange=function(e){return e=c(e,t,"createRangyRange"),new a(e)},i.createAliasForDeprecatedMethod(e,"createIframeRange","createRange"),i.createAliasForDeprecatedMethod(e,"createIframeRangyRange","createRangyRange"),e.addShimListener(function(t){var n=t.document;"undefined"==typeof n.createRange&&(n.createRange=function(){return e.createRange(n)}),n=t=null})}),P.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(e,t){function n(e){return"string"==typeof e?/^backward(s)?$/i.test(e):!!e}function r(e,n){if(e){if(A.isWindow(e))return e;if(e instanceof v)return e.win;var r=A.getContentDocument(e,t,n);return A.getWindow(r)}return window}function o(e){return r(e,"getWinSelection").getSelection()}function i(e){return r(e,"getDocSelection").document.selection}function s(e){var t=!1;return e.anchorNode&&(t=1==A.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)),t}function a(e,t,n){var r=n?"end":"start",o=n?"start":"end";e.anchorNode=t[r+"Container"],e.anchorOffset=t[r+"Offset"],e.focusNode=t[o+"Container"],e.focusOffset=t[o+"Offset"]}function l(e){var t=e.nativeSelection;e.anchorNode=t.anchorNode,e.anchorOffset=t.anchorOffset,e.focusNode=t.focusNode,e.focusOffset=t.focusOffset}function c(e){e.anchorNode=e.focusNode=null,e.anchorOffset=e.focusOffset=0,e.rangeCount=0,e.isCollapsed=!0,e._ranges.length=0}function d(t){var n;return t instanceof L?(n=e.createNativeRange(t.getDocument()),n.setEnd(t.endContainer,t.endOffset),n.setStart(t.startContainer,t.startOffset)):t instanceof I?n=t.nativeRange:k.implementsDomRange&&t instanceof A.getWindow(t.startContainer).Range&&(n=t),n}function u(e){if(!e.length||1!=e[0].nodeType)return!1;for(var t=1,n=e.length;n>t;++t)if(!A.isAncestorOf(e[0],e[t]))return!1;return!0}function f(e){var n=e.getNodes();if(!u(n))throw t.createError("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element");return n[0]}function h(e){return!!e&&"undefined"!=typeof e.text}function m(e,t){var n=new I(t);e._ranges=[n],a(e,n,!1),e.rangeCount=1,e.isCollapsed=n.collapsed}function p(t){if(t._ranges.length=0,"None"==t.docSelection.type)c(t);else{var n=t.docSelection.createRange();if(h(n))m(t,n);else{t.rangeCount=n.length;for(var r,o=B(n.item(0)),i=0;i<t.rangeCount;++i)r=e.createRange(o),r.selectNode(n.item(i)),t._ranges.push(r);t.isCollapsed=1==t.rangeCount&&t._ranges[0].collapsed,a(t,t._ranges[t.rangeCount-1],!1)}}}function g(e,n){for(var r=e.docSelection.createRange(),o=f(n),i=B(r.item(0)),s=H(i).createControlRange(),a=0,l=r.length;l>a;++a)s.add(r.item(a));try{s.add(o)}catch(c){throw t.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}s.select(),p(e)}function v(e,t,n){this.nativeSelection=e,this.docSelection=t,this._ranges=[],this.win=n,this.refresh()}function y(e){e.win=e.anchorNode=e.focusNode=e._ranges=null,e.rangeCount=e.anchorOffset=e.focusOffset=0,e.detached=!0}function b(e,t){for(var n,r,o=tt.length;o--;)if(n=tt[o],r=n.selection,"deleteAll"==t)y(r);else if(n.win==e)return"delete"==t?(tt.splice(o,1),!0):r;return"deleteAll"==t&&(tt.length=0),null}function C(e,n){for(var r,o=B(n[0].startContainer),i=H(o).createControlRange(),s=0,a=n.length;a>s;++s){r=f(n[s]);try{i.add(r)}catch(l){throw t.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}i.select(),p(e)}function N(e,t){if(e.win.document!=B(t))throw new P("WRONG_DOCUMENT_ERR")}function w(t){return function(n,r){var o;this.rangeCount?(o=this.getRangeAt(0),o["set"+(t?"Start":"End")](n,r)):(o=e.createRange(this.win.document),o.setStartAndEnd(n,r)),this.setSingleRange(o,this.isBackward())}}function E(e){var t=[],n=new D(e.anchorNode,e.anchorOffset),r=new D(e.focusNode,e.focusOffset),o="function"==typeof e.getName?e.getName():"Selection";if("undefined"!=typeof e.rangeCount)for(var i=0,s=e.rangeCount;s>i;++i)t[i]=L.inspect(e.getRangeAt(i));return"["+o+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+r.inspect()+"]"}e.config.checkSelectionRanges=!0;var x,S,T="boolean",R="number",A=e.dom,_=e.util,O=_.isHostMethod,L=e.DomRange,I=e.WrappedRange,P=e.DOMException,D=A.DomPosition,k=e.features,M="Control",B=A.getDocument,H=A.getBody,V=L.rangesEqual,q=O(window,"getSelection"),j=_.isHostObject(document,"selection");k.implementsWinGetSelection=q,k.implementsDocSelection=j;var F=j&&(!q||e.config.preferTextRange);if(F)x=i,e.isSelectionValid=function(e){var t=r(e,"isSelectionValid").document,n=t.selection;return"None"!=n.type||B(n.createRange().parentElement())==t};else{if(!q)return t.fail("Neither document.selection or window.getSelection() detected."),!1;x=o,e.isSelectionValid=function(){return!0}}e.getNativeSelection=x;var z=x();if(!z)return t.fail("Native selection was null (possibly issue 138?)"),!1;var U=e.createNativeRange(document),W=H(document),$=_.areHostProperties(z,["anchorNode","focusNode","anchorOffset","focusOffset"]);k.selectionHasAnchorAndFocus=$;var K=O(z,"extend");k.selectionHasExtend=K;var G=typeof z.rangeCount==R;k.selectionHasRangeCount=G;var X=!1,Y=!0,Q=K?function(t,n){var r=L.getRangeDocument(n),o=e.createRange(r);o.collapseToPoint(n.endContainer,n.endOffset),t.addRange(d(o)),t.extend(n.startContainer,n.startOffset)}:null;_.areHostMethods(z,["addRange","getRangeAt","removeAllRanges"])&&typeof z.rangeCount==R&&k.implementsDomRange&&!function(){var t=window.getSelection();if(t){for(var n=t.rangeCount,r=n>1,o=[],i=s(t),a=0;n>a;++a)o[a]=t.getRangeAt(a);var l=A.createTestElement(document,"",!1),c=l.appendChild(document.createTextNode("   ")),d=document.createRange();if(d.setStart(c,1),d.collapse(!0),t.removeAllRanges(),t.addRange(d),Y=1==t.rangeCount,t.removeAllRanges(),!r){var u=window.navigator.appVersion.match(/Chrome\/(.*?) /);if(u&&parseInt(u[1])>=36)X=!1;else{var f=d.cloneRange();d.setStart(c,0),f.setEnd(c,3),f.setStart(c,2),t.addRange(d),t.addRange(f),X=2==t.rangeCount}}for(A.removeNode(l),t.removeAllRanges(),a=0;n>a;++a)0==a&&i?Q?Q(t,o[a]):(e.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),t.addRange(o[a])):t.addRange(o[a])}}(),k.selectionSupportsMultipleRanges=X,k.collapsedNonEditableSelectionsSupported=Y;var Z,J=!1;W&&O(W,"createControlRange")&&(Z=W.createControlRange(),_.areHostProperties(Z,["item","add"])&&(J=!0)),k.implementsControlRange=J,S=$?function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}:function(e){return e.rangeCount?e.getRangeAt(e.rangeCount-1).collapsed:!1};var et;O(z,"getRangeAt")?et=function(e,t){try{return e.getRangeAt(t)}catch(n){return null}}:$&&(et=function(t){var n=B(t.anchorNode),r=e.createRange(n);return r.setStartAndEnd(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset),r.collapsed!==this.isCollapsed&&r.setStartAndEnd(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset),r}),v.prototype=e.selectionPrototype;var tt=[],nt=function(e){if(e&&e instanceof v)return e.refresh(),e;e=r(e,"getNativeSelection");var t=b(e),n=x(e),o=j?i(e):null;return t?(t.nativeSelection=n,t.docSelection=o,t.refresh()):(t=new v(n,o,e),tt.push({win:e,selection:t})),t};e.getSelection=nt,_.createAliasForDeprecatedMethod(e,"getIframeSelection","getSelection");var rt=v.prototype;if(!F&&$&&_.areHostMethods(z,["removeAllRanges","addRange"])){rt.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),c(this)};var ot=function(e,t){Q(e.nativeSelection,t),e.refresh()};rt.addRange=G?function(t,r){if(J&&j&&this.docSelection.type==M)g(this,t);else if(n(r)&&K)ot(this,t);else{var o;X?o=this.rangeCount:(this.removeAllRanges(),o=0);var i=d(t).cloneRange();try{this.nativeSelection.addRange(i)}catch(s){}if(this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==o+1){if(e.config.checkSelectionRanges){var l=et(this.nativeSelection,this.rangeCount-1);l&&!V(l,t)&&(t=new I(l))}this._ranges[this.rangeCount-1]=t,a(this,t,at(this.nativeSelection)),this.isCollapsed=S(this)}else this.refresh()}}:function(e,t){n(t)&&K?ot(this,e):(this.nativeSelection.addRange(d(e)),this.refresh())},rt.setRanges=function(e){if(J&&j&&e.length>1)C(this,e);else{this.removeAllRanges();for(var t=0,n=e.length;n>t;++t)this.addRange(e[t])}}}else{if(!(O(z,"empty")&&O(U,"select")&&J&&F))return t.fail("No means of selecting a Range or TextRange was found"),!1;rt.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var e;if(this.anchorNode)e=B(this.anchorNode);else if(this.docSelection.type==M){var t=this.docSelection.createRange();t.length&&(e=B(t.item(0)))}if(e){var n=H(e).createTextRange();n.select(),this.docSelection.empty()}}}catch(r){}c(this)},rt.addRange=function(t){this.docSelection.type==M?g(this,t):(e.WrappedTextRange.rangeToTextRange(t).select(),this._ranges[0]=t,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,a(this,t,!1))},rt.setRanges=function(e){this.removeAllRanges();var t=e.length;t>1?C(this,e):t&&this.addRange(e[0])}}rt.getRangeAt=function(e){if(0>e||e>=this.rangeCount)throw new P("INDEX_SIZE_ERR");return this._ranges[e].cloneRange()};var it;if(F)it=function(t){var n;e.isSelectionValid(t.win)?n=t.docSelection.createRange():(n=H(t.win.document).createTextRange(),n.collapse(!0)),t.docSelection.type==M?p(t):h(n)?m(t,n):c(t)};else if(O(z,"getRangeAt")&&typeof z.rangeCount==R)it=function(t){if(J&&j&&t.docSelection.type==M)p(t);else if(t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount,t.rangeCount){for(var n=0,r=t.rangeCount;r>n;++n)t._ranges[n]=new e.WrappedRange(t.nativeSelection.getRangeAt(n));a(t,t._ranges[t.rangeCount-1],at(t.nativeSelection)),t.isCollapsed=S(t)}else c(t)};else{if(!$||typeof z.isCollapsed!=T||typeof U.collapsed!=T||!k.implementsDomRange)return t.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;it=function(e){var t,n=e.nativeSelection;n.anchorNode?(t=et(n,0),e._ranges=[t],e.rangeCount=1,l(e),e.isCollapsed=S(e)):c(e)}}rt.refresh=function(e){var t=e?this._ranges.slice(0):null,n=this.anchorNode,r=this.anchorOffset;if(it(this),e){var o=t.length;if(o!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=r)return!0;for(;o--;)if(!V(t[o],this._ranges[o]))return!0;return!1}};var st=function(e,t){var n=e.getAllRanges();e.removeAllRanges();for(var r=0,o=n.length;o>r;++r)V(t,n[r])||e.addRange(n[r]);e.rangeCount||c(e)};rt.removeRange=J&&j?function(e){if(this.docSelection.type==M){for(var t,n=this.docSelection.createRange(),r=f(e),o=B(n.item(0)),i=H(o).createControlRange(),s=!1,a=0,l=n.length;l>a;++a)t=n.item(a),t!==r||s?i.add(n.item(a)):s=!0;i.select(),p(this)}else st(this,e)}:function(e){st(this,e)};var at;!F&&$&&k.implementsDomRange?(at=s,rt.isBackward=function(){return at(this)}):at=rt.isBackward=function(){return!1},rt.isBackwards=rt.isBackward,rt.toString=function(){for(var e=[],t=0,n=this.rangeCount;n>t;++t)e[t]=""+this._ranges[t];return e.join("")},rt.collapse=function(t,n){N(this,t);var r=e.createRange(t);r.collapseToPoint(t,n),this.setSingleRange(r),this.isCollapsed=!0},rt.collapseToStart=function(){if(!this.rangeCount)throw new P("INVALID_STATE_ERR");var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)},rt.collapseToEnd=function(){if(!this.rangeCount)throw new P("INVALID_STATE_ERR");var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)},rt.selectAllChildren=function(t){N(this,t);var n=e.createRange(t);n.selectNodeContents(t),this.setSingleRange(n)},rt.deleteFromDocument=function(){if(J&&j&&this.docSelection.type==M){for(var e,t=this.docSelection.createRange();t.length;)e=t.item(0),t.remove(e),A.removeNode(e);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var r=0,o=n.length;o>r;++r)n[r].deleteContents();this.addRange(n[o-1])}}},rt.eachRange=function(e,t){for(var n=0,r=this._ranges.length;r>n;++n)if(e(this.getRangeAt(n)))return t},rt.getAllRanges=function(){var e=[];return this.eachRange(function(t){e.push(t)}),e},rt.setSingleRange=function(e,t){this.removeAllRanges(),this.addRange(e,t)},rt.callMethodOnEachRange=function(e,t){var n=[];return this.eachRange(function(r){n.push(r[e].apply(r,t||[]))}),n},rt.setStart=w(!0),rt.setEnd=w(!1),e.rangePrototype.select=function(e){nt(this.getDocument()).setSingleRange(this,e)},rt.changeEachRange=function(e){var t=[],n=this.isBackward();this.eachRange(function(n){e(n),t.push(n)}),this.removeAllRanges(),n&&1==t.length?this.addRange(t[0],"backward"):this.setRanges(t)},rt.containsNode=function(e,t){return this.eachRange(function(n){return n.containsNode(e,t)},!0)||!1},rt.getBookmark=function(e){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[e])}},rt.moveToBookmark=function(t){for(var n,r,o=[],i=0;n=t.rangeBookmarks[i++];)r=e.createRange(this.win),r.moveToBookmark(n),o.push(r);t.backward?this.setSingleRange(o[0],"backward"):this.setRanges(o)},rt.saveRanges=function(){return{backward:this.isBackward(),ranges:this.callMethodOnEachRange("cloneRange")}},rt.restoreRanges=function(e){this.removeAllRanges();for(var t,n=0;t=e.ranges[n];++n)this.addRange(t,e.backward&&0==n)},rt.toHtml=function(){var e=[];return this.eachRange(function(t){e.push(L.toHtml(t))}),e.join("")},k.implementsTextRange&&(rt.getNativeTextRange=function(){var n;if(n=this.docSelection){var r=n.createRange();if(h(r))return r;throw t.createError("getNativeTextRange: selection is a control selection")}if(this.rangeCount>0)return e.WrappedTextRange.rangeToTextRange(this.getRangeAt(0));throw t.createError("getNativeTextRange: selection contains no range")}),rt.getName=function(){return"WrappedSelection"},rt.inspect=function(){return E(this)},rt.detach=function(){b(this.win,"delete"),y(this)},v.detachAll=function(){b(null,"deleteAll")},v.inspect=E,v.isDirectionBackward=n,e.Selection=v,e.selectionPrototype=rt,e.addShimListener(function(e){"undefined"==typeof e.getSelection&&(e.getSelection=function(){return nt(e)}),e=null})});var H=!1,V=function(){H||(H=!0,!P.initialized&&P.config.autoInitialize&&u())};return L&&("complete"==document.readyState?V():(e(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",V,!1),k(window,"load",V))),P},window),function(e,t){e(t.rangy)}(function(e){return e.createModule("SaveRestore",["WrappedRange"],function(e,t){function n(e,t){return(t||document).getElementById(e)}function r(e,t){var n,r="selectionBoundary_"+ +new Date+"_"+(""+Math.random()).slice(2),o=m.getDocument(e.startContainer),i=e.cloneRange();return i.collapse(t),n=o.createElement("span"),n.id=r,n.style.lineHeight="0",n.style.display="none",n.className="rangySelectionBoundary",n.appendChild(o.createTextNode(v)),i.insertNode(n),n}function o(e,r,o,i){var s=n(o,e);s?(r[i?"setStartBefore":"setEndBefore"](s),p(s)):t.warn("Marker element has been removed. Cannot restore selection.")}function i(e,t){return t.compareBoundaryPoints(e.START_TO_START,e)}function s(t,n){var o,i,s=e.DomRange.getRangeDocument(t),a=t.toString(),l=g(n);return t.collapsed?(i=r(t,!1),{document:s,markerId:i.id,collapsed:!0}):(i=r(t,!1),o=r(t,!0),{document:s,startMarkerId:o.id,endMarkerId:i.id,collapsed:!1,backward:l,toString:function(){return"original text: '"+a+"', new text: '"+t.toString()+"'"}})}function a(r,i){var s=r.document;"undefined"==typeof i&&(i=!0);var a=e.createRange(s);if(r.collapsed){var l=n(r.markerId,s);if(l){l.style.display="inline";var c=l.previousSibling;c&&3==c.nodeType?(p(l),a.collapseToPoint(c,c.length)):(a.collapseBefore(l),p(l))}else t.warn("Marker element has been removed. Cannot restore selection.")}else o(s,a,r.startMarkerId,!0),o(s,a,r.endMarkerId,!1);return i&&a.normalizeBoundaries(),a}function l(t,r){var o,a,l=[],c=g(r);t=t.slice(0),t.sort(i);for(var d=0,u=t.length;u>d;++d)l[d]=s(t[d],c);for(d=u-1;d>=0;--d)o=t[d],a=e.DomRange.getRangeDocument(o),o.collapsed?o.collapseAfter(n(l[d].markerId,a)):(o.setEndBefore(n(l[d].endMarkerId,a)),o.setStartAfter(n(l[d].startMarkerId,a)));return l}function c(n){if(!e.isSelectionValid(n))return t.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus."),null;var r=e.getSelection(n),o=r.getAllRanges(),i=1==o.length&&r.isBackward(),s=l(o,i);return i?r.setSingleRange(o[0],i):r.setRanges(o),{win:n,rangeInfos:s,restored:!1}}function d(e){for(var t=[],n=e.length,r=n-1;r>=0;r--)t[r]=a(e[r],!0);return t}function u(t,n){if(!t.restored){var r=t.rangeInfos,o=e.getSelection(t.win),i=d(r),s=r.length;1==s&&n&&e.features.selectionHasExtend&&r[0].backward?(o.removeAllRanges(),o.addRange(i[0],!0)):o.setRanges(i),t.restored=!0}}function f(e,t){var r=n(t,e);r&&p(r)}function h(e){for(var t,n=e.rangeInfos,r=0,o=n.length;o>r;++r)t=n[r],t.collapsed?f(e.doc,t.markerId):(f(e.doc,t.startMarkerId),f(e.doc,t.endMarkerId))}var m=e.dom,p=m.removeNode,g=e.Selection.isDirectionBackward,v="﻿";e.util.extend(e,{saveRange:s,restoreRange:a,saveRanges:l,restoreRanges:d,saveSelection:c,restoreSelection:u,removeMarkerElement:f,removeMarkers:h})}),e},window);var o=function(){};o.extend=function(e,t){var n=o.prototype.extend;o._prototyping=!0;var r=new this;n.call(r,e),r.base=function(){},delete o._prototyping;var i=r.constructor,s=r.constructor=function(){if(!o._prototyping)if(this._constructing||this.constructor==s)this._constructing=!0,i.apply(this,arguments),delete this._constructing;else if(null!=arguments[0])return(arguments[0].extend||n).call(arguments[0],r)};return s.ancestor=this,s.extend=this.extend,s.forEach=this.forEach,s.implement=this.implement,s.prototype=r,s.toString=this.toString,s.valueOf=function(e){return"object"==e?s:i.valueOf()},n.call(s,t),"function"==typeof s.init&&s.init(),s},o.prototype={extend:function(e,t){if(arguments.length>1){var n=this[e];if(n&&"function"==typeof t&&(!n.valueOf||n.valueOf()!=t.valueOf())&&/\bbase\b/.test(t)){var r=t.valueOf();t=function(){var e=this.base||o.prototype.base;this.base=n;var t=r.apply(this,arguments);return this.base=e,t},t.valueOf=function(e){return"object"==e?t:r},t.toString=o.toString}this[e]=t}else if(e){var i=o.prototype.extend;o._prototyping||"function"==typeof this||(i=this.extend||i);for(var s={toSource:null},a=["constructor","toString","valueOf"],l=o._prototyping?0:1;c=a[l++];)e[c]!=s[c]&&i.call(this,c,e[c]);for(var c in e)s[c]||i.call(this,c,e[c])}return this}},o=o.extend({constructor:function(){this.extend(arguments[0])}},{ancestor:Object,version:"1.1",forEach:function(e,t,n){for(var r in e)void 0===this.prototype[r]&&t.call(n,e[r],r,e)},implement:function(){for(var e=0;e<arguments.length;e++)"function"==typeof arguments[e]?arguments[e](this.prototype):this.prototype.extend(arguments[e]);return this},toString:function(){return String(this.valueOf())}}),r.browser=function(){function e(e){return+(/ipad|iphone|ipod/.test(e)&&e.match(/ os (\d+).+? like mac os x/)||[void 0,0])[1]}function t(e){return+(e.match(/android (\d+)/)||[void 0,0])[1]}function n(e,t){var n,r=-1;return"Microsoft Internet Explorer"==navigator.appName?n=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})"):"Netscape"==navigator.appName&&(n=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})")),n&&null!=n.exec(navigator.userAgent)&&(r=parseFloat(RegExp.$1)),-1===r?!1:e?t?"<"===t?r>e:">"===t?e>r:"<="===t?r>=e:">="===t?e>=r:void 0:e===r:!0}var r=navigator.userAgent,o=document.createElement("div"),i=-1!==r.indexOf("Gecko")&&-1===r.indexOf("KHTML"),s=-1!==r.indexOf("AppleWebKit/"),a=-1!==r.indexOf("Chrome/"),l=-1!==r.indexOf("Opera/");return{USER_AGENT:r,supported:function(){var n=this.USER_AGENT.toLowerCase(),r="contentEditable"in o,i=document.execCommand&&document.queryCommandSupported&&document.queryCommandState,s=document.querySelector&&document.querySelectorAll,a=this.isIos()&&e(n)<5||this.isAndroid()&&t(n)<4||-1!==n.indexOf("opera mobi")||-1!==n.indexOf("hpwos/");return r&&i&&s&&!a},isTouchDevice:function(){return this.supportsEvent("touchmove")},isIos:function(){return/ipad|iphone|ipod/i.test(this.USER_AGENT)},isAndroid:function(){return-1!==this.USER_AGENT.indexOf("Android")},supportsSandboxedIframes:function(){return n()},throwsMixedContentWarningWhenIframeSrcIsEmpty:function(){return!("querySelector"in document)},displaysCaretInEmptyContentEditableCorrectly:function(){return n()},hasCurrentStyleProperty:function(){return"currentStyle"in o},insertsLineBreaksOnReturn:function(){return i},supportsPlaceholderAttributeOn:function(e){return"placeholder"in e},supportsEvent:function(e){return"on"+e in o||function(){return o.setAttribute("on"+e,"return;"),"function"==typeof o["on"+e]}()},supportsEventsInIframeCorrectly:function(){return!l},supportsHTML5Tags:function(e){var t=e.createElement("div"),n="<article>foo</article>";return t.innerHTML=n,t.innerHTML.toLowerCase()===n},supportsCommand:function(){var e={formatBlock:n(10,"<="),insertUnorderedList:n(9,">="),insertOrderedList:n(9,">=")},t={insertHTML:i};return function(n,r){var o=e[r];if(!o){try{return n.queryCommandSupported(r)}catch(i){}try{return n.queryCommandEnabled(r)}catch(s){return!!t[r]}}return!1}}(),doesAutoLinkingInContentEditable:function(){return n()},canDisableAutoLinking:function(){return this.supportsCommand(document,"AutoUrlDetect")},clearsContentEditableCorrectly:function(){return i||l||s},supportsGetAttributeCorrectly:function(){var e=document.createElement("td");return"1"!=e.getAttribute("rowspan")},canSelectImagesInContentEditable:function(){return i||n()||l},autoScrollsToCaret:function(){return!s},autoClosesUnclosedTags:function(){var e,t,n=o.cloneNode(!1);return n.innerHTML="<p><div></div>",t=n.innerHTML.toLowerCase(),e="<p></p><div></div>"===t||"<p><div></div></p>"===t,this.autoClosesUnclosedTags=function(){return e},e},supportsNativeGetElementsByClassName:function(){return-1!==String(document.getElementsByClassName).indexOf("[native code]")},supportsSelectionModify:function(){return"getSelection"in window&&"modify"in window.getSelection()},needsSpaceAfterLineBreak:function(){return l},supportsSpeechApiOn:function(e){var t=r.match(/Chrome\/(\d+)/)||[void 0,0];return t[1]>=11&&("onwebkitspeechchange"in e||"speech"in e)},crashesWhenDefineProperty:function(e){return n(9)&&("XMLHttpRequest"===e||"XDomainRequest"===e)},doesAsyncFocus:function(){return n()},hasProblemsSettingCaretAfterImg:function(){return n()},hasUndoInContextMenu:function(){return i||a||l},hasInsertNodeIssue:function(){return l},hasIframeFocusIssue:function(){return n()},createsNestedInvalidMarkupAfterPaste:function(){return s},supportsMutationEvents:function(){return"MutationEvent"in window},supportsModernPaste:function(){return!("clipboardData"in window)},fixStyleKey:function(e){return"cssFloat"===e?"styleFloat"in document.createElement("div").style?"styleFloat":"cssFloat":e}}}(),r.lang.array=function(e){return{contains:function(t){if(Array.isArray(t)){for(var n=t.length;n--;)if(-1!==r.lang.array(e).indexOf(t[n]))return!0;return!1}return-1!==r.lang.array(e).indexOf(t)},indexOf:function(t){if(e.indexOf)return e.indexOf(t);for(var n=0,r=e.length;r>n;n++)if(e[n]===t)return n;return-1},without:function(t){t=r.lang.array(t);for(var n=[],o=0,i=e.length;i>o;o++)t.contains(e[o])||n.push(e[o]);return n},get:function(){for(var t=0,n=e.length,r=[];n>t;t++)r.push(e[t]);return r},map:function(t,n){if(Array.prototype.map)return e.map(t,n);for(var r=e.length>>>0,o=new Array(r),i=0;r>i;i++)o[i]=t.call(n,e[i],i,e);return o},unique:function(){for(var t=[],n=e.length,o=0;n>o;)r.lang.array(t).contains(e[o])||t.push(e[o]),o++;return t}}},r.lang.Dispatcher=o.extend({on:function(e,t){return this.events=this.events||{},this.events[e]=this.events[e]||[],this.events[e].push(t),this},off:function(e,t){this.events=this.events||{};var n,r,o=0;if(e){for(n=this.events[e]||[],r=[];o<n.length;o++)n[o]!==t&&t&&r.push(n[o]);this.events[e]=r}else this.events={};return this},fire:function(e,t){this.events=this.events||{};for(var n=this.events[e]||[],r=0;r<n.length;r++)n[r].call(this,t);return this},observe:function(){return this.on.apply(this,arguments)},stopObserving:function(){return this.off.apply(this,arguments)}}),r.lang.object=function(e){return{merge:function(t,n){for(var o in t)n&&r.lang.object(t[o]).isPlainObject()&&("undefined"==typeof e[o]||r.lang.object(e[o]).isPlainObject())?"undefined"==typeof e[o]?e[o]=r.lang.object(t[o]).clone(!0):r.lang.object(e[o]).merge(r.lang.object(t[o]).clone(!0)):e[o]=r.lang.object(t[o]).isPlainObject()?r.lang.object(t[o]).clone(!0):t[o];return this},difference:function(t){var n={};for(var r in e)e.hasOwnProperty(r)&&(t.hasOwnProperty(r)||(n[r]=e[r]));
for(var o in t)t.hasOwnProperty(o)&&(e.hasOwnProperty(o)&&e[o]===t[o]||(n[0]=e[0]));return n},get:function(){return e},clone:function(t){var n,o={};if(null===e||!r.lang.object(e).isPlainObject())return e;for(n in e)e.hasOwnProperty(n)&&(o[n]=t?r.lang.object(e[n]).clone(t):e[n]);return o},isArray:function(){return"[object Array]"===Object.prototype.toString.call(e)},isFunction:function(){return"[object Function]"===Object.prototype.toString.call(e)},isPlainObject:function(){return e&&"[object Object]"===Object.prototype.toString.call(e)&&!("Node"in window?e instanceof Node:e instanceof Element||e instanceof Text)},isEmpty:function(){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}}},function(){var e=/^\s+/,t=/\s+$/,n=/[&<>\t"]/g,o={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","	":"&nbsp; "};r.lang.string=function(r){return r=String(r),{trim:function(){return r.replace(e,"").replace(t,"")},interpolate:function(e){for(var t in e)r=this.replace("#{"+t+"}").by(e[t]);return r},replace:function(e){return{by:function(t){return r.split(e).join(t)}}},escapeHTML:function(e,t){var i=r.replace(n,function(e){return o[e]});return e&&(i=i.replace(/(?:\r\n|\r|\n)/g,"<br />")),t&&(i=i.replace(/  /gi,"&nbsp; ")),i}}}}(),function(e){function t(e,t){return i(e,t)?e:(e===e.ownerDocument.documentElement&&(e=e.ownerDocument.body),s(e,t))}function n(e){return e.replace(l,function(e,t){var n=(t.match(c)||[])[1]||"",r=u[n];t=t.replace(c,""),t.split(r).length>t.split(n).length&&(t+=n,n="");var o=t,i=t;return t.length>d&&(i=i.substr(0,d)+"..."),"www."===o.substr(0,4)&&(o="http://"+o),'<a href="'+o+'">'+i+"</a>"+n})}function r(e){var t=e._wysihtml5_tempElement;return t||(t=e._wysihtml5_tempElement=e.createElement("div")),t}function o(t){var o=t.parentNode,i=e.lang.string(t.data).escapeHTML(),s=r(o.ownerDocument);for(s.innerHTML="<span></span>"+n(i),s.removeChild(s.firstChild);s.firstChild;)o.insertBefore(s.firstChild,t);o.removeChild(t)}function i(t,n){for(var r;t.parentNode;){if(t=t.parentNode,r=t.nodeName,t.className&&e.lang.array(t.className.split(" ")).contains(n))return!0;if(a.contains(r))return!0;if("body"===r)return!1}return!1}function s(t,n){if(!(a.contains(t.nodeName)||t.className&&e.lang.array(t.className.split(" ")).contains(n))){if(t.nodeType===e.TEXT_NODE&&t.data.match(l))return void o(t);for(var r=e.lang.array(t.childNodes).get(),i=r.length,c=0;i>c;c++)s(r[c],n);return t}}var a=e.lang.array(["CODE","PRE","A","SCRIPT","HEAD","TITLE","STYLE"]),l=/((https?:\/\/|www\.)[^\s<]{3,})/gi,c=/([^\w\/\-](,?))$/i,d=100,u={")":"(","]":"[","}":"{"};e.dom.autoLink=t,e.dom.autoLink.URL_REG_EXP=l}(r),function(e){var t=e.dom;t.addClass=function(e,n){var r=e.classList;return r?r.add(n):void(t.hasClass(e,n)||(e.className+=" "+n))},t.removeClass=function(e,t){var n=e.classList;return n?n.remove(t):void(e.className=e.className.replace(new RegExp("(^|\\s+)"+t+"(\\s+|$)")," "))},t.hasClass=function(e,t){var n=e.classList;if(n)return n.contains(t);var r=e.className;return r.length>0&&(r==t||new RegExp("(^|\\s)"+t+"(\\s|$)").test(r))}}(r),r.dom.contains=function(){var e=document.documentElement;return e.contains?function(e,t){if(t.nodeType!==r.ELEMENT_NODE){if(t.parentNode===e)return!0;t=t.parentNode}return e!==t&&e.contains(t)}:e.compareDocumentPosition?function(e,t){return!!(16&e.compareDocumentPosition(t))}:void 0}(),r.dom.convertToList=function(){function e(e,t){var n=e.createElement("li");return t.appendChild(n),n}function t(e,t){return e.createElement(t)}function n(n,o,i){if("UL"===n.nodeName||"OL"===n.nodeName||"MENU"===n.nodeName)return n;var s,a,l,c,d,u,f,h,m,p=n.ownerDocument,g=t(p,o),v=n.querySelectorAll("br"),y=v.length;for(m=0;y>m;m++)for(c=v[m];(d=c.parentNode)&&d!==n&&d.lastChild===c;){if("block"===r.dom.getStyle("display").from(d)){d.removeChild(c);break}r.dom.insert(c).after(c.parentNode)}for(s=r.lang.array(n.childNodes).get(),a=s.length,m=0;a>m;m++)h=h||e(p,g),l=s[m],u="block"===r.dom.getStyle("display").from(l),f="BR"===l.nodeName,!u||i&&r.dom.hasClass(l,i)?f?h=h.firstChild?null:h:h.appendChild(l):(h=h.firstChild?e(p,g):h,h.appendChild(l),h=null);return 0===s.length&&e(p,g),n.parentNode.replaceChild(g,n),g}return n}(),r.dom.copyAttributes=function(e){return{from:function(t){return{to:function(n){for(var r,o=0,i=e.length;i>o;o++)r=e[o],"undefined"!=typeof t[r]&&""!==t[r]&&(n[r]=t[r]);return{andTo:arguments.callee}}}}}},function(e){var t=["-webkit-box-sizing","-moz-box-sizing","-ms-box-sizing","box-sizing"],n=function(t){return o(t)?parseInt(e.getStyle("width").from(t),10)<t.offsetWidth:!1},o=function(n){for(var r=0,o=t.length;o>r;r++)if("border-box"===e.getStyle(t[r]).from(n))return t[r]};e.copyStyles=function(o){return{from:function(i){n(i)&&(o=r.lang.array(o).without(t));for(var s,a="",l=o.length,c=0;l>c;c++)s=o[c],a+=s+":"+e.getStyle(s).from(i)+";";return{to:function(t){return e.setStyles(a).on(t),{andTo:arguments.callee}}}}}}}(r.dom),function(e){e.dom.delegate=function(e,t,n,r){var o=function(n){for(var o=n.target,i=3===o.nodeType?o.parentNode:o,s=e.querySelectorAll(t),a=0,l=s.length;l>a;a++)s[a].contains(i)&&r.call(s[a],n)};return e.addEventListener(n,o,!1),{stop:function(){e.removeEventListener(n,o,!1)}}}}(r),function(e){function t(e,t){for(var n=[e],r=e;t&&r&&r!==t||!t&&r;)n.unshift(r),r=r.parentNode;return n}e.dom.domNode=function(n){var r=[e.ELEMENT_NODE,e.TEXT_NODE];return{is:{emptyTextNode:function(t){var r=t?/^\s*$/g:/^[\r\n]*$/g;return n.nodeType===e.TEXT_NODE&&r.test(n.data)},visible:function(){var t=!/^\s*$/g.test(e.dom.getTextContent(n));return t||1===n.nodeType&&n.querySelector("img, br, hr, object, embed, canvas, input, textarea")&&(t=!0),t}},prev:function(t){var o=n.previousSibling,i=t&&t.nodeTypes?t.nodeTypes:r;return o?!e.lang.array(i).contains(o.nodeType)||t&&t.ignoreBlankTexts&&e.dom.domNode(o).is.emptyTextNode(!0)?e.dom.domNode(o).prev(t):o:null},next:function(t){var o=n.nextSibling,i=t&&t.nodeTypes?t.nodeTypes:r;return o?!e.lang.array(i).contains(o.nodeType)||t&&t.ignoreBlankTexts&&e.dom.domNode(o).is.emptyTextNode(!0)?e.dom.domNode(o).next(t):o:null},commonAncestor:function(e,r){var o=t(n,r),i=t(e,r);if(o[0]!=i[0])return null;for(var s=0;s<o.length;s++)if(o[s]!=i[s])return o[s-1];return null},lastLeafNode:function(t){var r;if(1!==n.nodeType)return n;if(r=n.lastChild,!r)return n;if(t&&t.leafClasses)for(var o=t.leafClasses.length;o--;)if(e.dom.hasClass(n,t.leafClasses[o]))return n;return e.dom.domNode(r).lastLeafNode(t)},escapeParent:function(t,r){var o,i,s,a=n;if(!e.dom.contains(t,n))throw new Error("Child is not a descendant of node.");do{for(o=a.parentNode,i=o.cloneNode(!1);o.lastChild&&o.lastChild!==a;)i.insertBefore(o.lastChild,i.firstChild);if(o!==t&&(s=o.cloneNode(!1),s.appendChild(a),a=s),o.parentNode.insertBefore(a,o.nextSibling),""!==i.innerHTML)if(/^\s+$/.test(i.innerHTML))for(;i.lastChild;)o.parentNode.insertBefore(i.lastChild,a.nextSibling);else o.parentNode.insertBefore(i,a.nextSibling);if(""===o.innerHTML)o.parentNode.removeChild(o);else if(/^\s+$/.test(o.innerHTML)){for(;o.firstChild;)o.parentNode.insertBefore(o.firstChild,o);o.parentNode.removeChild(o)}}while(o&&o!==t);r&&a&&(a.parentNode.insertBefore(r,a),r.appendChild(a))},test:function(t){var r;if(!t)return!1;if(1!==n.nodeType)return!1;if(t.query&&!n.matches(t.query))return!1;if(t.nodeName&&n.nodeName!==t.nodeName)return!1;if(t.className&&!n.classList.contains(t.className))return!1;if(t.classRegExp){var o=(n.className||"").match(t.classRegExp)||[];if(0===o.length)return!1}if(t.styleProperty&&t.styleProperty.length>0)for(var i=!1,s=Array.isArray(t.styleProperty)?t.styleProperty:[t.styleProperty],a=0,l=s.length;l>a;a++){if(r=e.browser.fixStyleKey(s[a]),n.style[r]){if(!t.styleValue){i=!0;break}if(t.styleValue instanceof RegExp){if(n.style[r].trim().match(t.styleValue).length>0){i=!0;break}}else if(Array.isArray(t.styleValue)){if(t.styleValue.indexOf(n.style[r].trim())){i=!0;break}}else if(t.styleValue===n.style[r].trim().replace(/, /g,",")){i=!0;break}}if(!i)return!1}if(t.attribute){var c=e.dom.getAttributes(n),d=[],u=!1;Array.isArray(t.attribute)?d=t.attribute:d[t.attribute]=t.attributeValue;for(var f in d)if(d.hasOwnProperty(f))if("undefined"==typeof d[f]){if("undefined"!=typeof c[f]){u=!0;break}}else if(c[f]===d[f]){u=!0;break}if(!u)return!1}return!0}}}}(r),r.dom.getAsDom=function(){var e=function(e,t){var n=t.createElement("div");n.style.display="none",t.body.appendChild(n);try{n.innerHTML=e}catch(r){}return t.body.removeChild(n),n},t=function(e){if(!e._wysihtml5_supportsHTML5Tags){for(var t=0,r=n.length;r>t;t++)e.createElement(n[t]);e._wysihtml5_supportsHTML5Tags=!0}},n=["abbr","article","aside","audio","bdi","canvas","command","datalist","details","figcaption","figure","footer","header","hgroup","keygen","mark","meter","nav","output","progress","rp","rt","ruby","svg","section","source","summary","time","track","video","wbr"];return function(n,o){o=o||document;var i;return"object"==typeof n&&n.nodeType?(i=o.createElement("div"),i.appendChild(n)):r.browser.supportsHTML5Tags(o)?(i=o.createElement("div"),i.innerHTML=n):(t(o),i=e(n,o)),i}}(),r.dom.getParentElement=function(){return function(e,t,n,o){for(n=n||50;n--&&e&&"BODY"!==e.nodeName&&(!o||e!==o);){if(r.dom.domNode(e).test(t))return e;e=e.parentNode}return null}}(),r.dom.getStyle=function(){function e(e){return e.replace(n,function(e){return e.charAt(1).toUpperCase()})}var t={"float":"styleFloat"in document.createElement("div").style?"styleFloat":"cssFloat"},n=/\-[a-z]/g;return function(n){return{from:function(o){if(o.nodeType===r.ELEMENT_NODE){var i=o.ownerDocument,s=t[n]||e(n),a=o.style,l=o.currentStyle,c=a[s];if(c)return c;if(l)try{return l[s]}catch(d){}var u,f,h=i.defaultView||i.parentWindow,m=("height"===n||"width"===n)&&"TEXTAREA"===o.nodeName;return h.getComputedStyle?(m&&(u=a.overflow,a.overflow="hidden"),f=h.getComputedStyle(o,null).getPropertyValue(n),m&&(a.overflow=u||""),f):void 0}}}}}(),r.dom.getTextNodes=function(e,t){var n=[];for(e=e.firstChild;e;e=e.nextSibling)3==e.nodeType?t&&/^\s*$/.test(e.innerText||e.textContent)||n.push(e):n=n.concat(r.dom.getTextNodes(e,t));return n},r.dom.hasElementWithTagName=function(){function e(e){return e._wysihtml5_identifier||(e._wysihtml5_identifier=n++)}var t={},n=1;return function(n,r){var o=e(n)+":"+r,i=t[o];return i||(i=t[o]=n.getElementsByTagName(r)),i.length>0}}(),function(e){function t(e){return e._wysihtml5_identifier||(e._wysihtml5_identifier=r++)}var n={},r=1;e.dom.hasElementWithClassName=function(r,o){if(!e.browser.supportsNativeGetElementsByClassName())return!!r.querySelector("."+o);var i=t(r)+":"+o,s=n[i];return s||(s=n[i]=r.getElementsByClassName(o)),s.length>0}}(r),r.dom.insert=function(e){return{after:function(t){t.parentNode.insertBefore(e,t.nextSibling)},before:function(t){t.parentNode.insertBefore(e,t)},into:function(t){t.appendChild(e)}}},r.dom.insertCSS=function(e){return e=e.join("\n"),{into:function(t){var n=t.createElement("style");n.type="text/css",n.styleSheet?n.styleSheet.cssText=e:n.appendChild(t.createTextNode(e));var r=t.querySelector("head link");if(r)return void r.parentNode.insertBefore(n,r);var o=t.querySelector("head");o&&o.appendChild(n)}}},function(e){e.dom.lineBreaks=function(t){function n(e){return"BR"===e.nodeName}function r(t){return n(t)?!0:"block"===e.dom.getStyle("display").from(t)?!0:!1}return{add:function(){var n=t.ownerDocument,o=e.dom.domNode(t).next({ignoreBlankTexts:!0}),i=e.dom.domNode(t).prev({ignoreBlankTexts:!0});o&&!r(o)&&e.dom.insert(n.createElement("br")).after(t),i&&!r(i)&&e.dom.insert(n.createElement("br")).before(t)},remove:function(){var r=e.dom.domNode(t).next({ignoreBlankTexts:!0}),o=e.dom.domNode(t).prev({ignoreBlankTexts:!0});r&&n(r)&&r.parentNode.removeChild(r),o&&n(o)&&o.parentNode.removeChild(o)}}}}(r),r.dom.observe=function(e,t,n){t="string"==typeof t?[t]:t;for(var r,o,i=0,s=t.length;s>i;i++)o=t[i],e.addEventListener?e.addEventListener(o,n,!1):(r=function(t){"target"in t||(t.target=t.srcElement),t.preventDefault=t.preventDefault||function(){this.returnValue=!1},t.stopPropagation=t.stopPropagation||function(){this.cancelBubble=!0},n.call(e,t)},e.attachEvent("on"+o,r));return{stop:function(){for(var o,i=0,s=t.length;s>i;i++)o=t[i],e.removeEventListener?e.removeEventListener(o,n,!1):e.detachEvent("on"+o,r)}}},r.dom.parse=function(e,t){function n(e,t){r.lang.object(C).merge(b).merge(t.rules).get();var n,s,a,l=t.context||e.ownerDocument||document,c=l.createDocumentFragment(),d="string"==typeof e,u=!1;for(t.clearInternals===!0&&(u=!0),n=d?r.dom.getAsDom(e,l):e,C.selectors&&i(n,C.selectors);n.firstChild;)a=n.firstChild,s=o(a,t.cleanUp,u,t.uneditableClass),s&&c.appendChild(s),a!==s&&n.removeChild(a);if(t.unjoinNbsps)for(var f=r.dom.getTextNodes(c),h=f.length;h--;)f[h].nodeValue=f[h].nodeValue.replace(/([\S\u00A0])\u00A0/gi,"$1 ");return n.innerHTML="",n.appendChild(c),d?r.quirks.getCorrectInnerHTML(n):n}function o(e,t,n,i){var s,a,l,c,d=e.nodeType,u=e.childNodes,f=u.length,h=g[d],m=0;if(i&&1===d&&r.dom.hasClass(e,i))return e;if(a=h&&h(e,n),!a){if(a===!1){for(s=e.ownerDocument.createDocumentFragment(),m=f;m--;)u[m]&&(l=o(u[m],t,n,i),l&&(u[m]===l&&m--,s.insertBefore(l,s.firstChild)));return c=r.dom.getStyle("display").from(e),""===c&&(c=r.lang.array(N).contains(e.tagName)?"block":""),r.lang.array(["block","flex","table"]).contains(c)&&s.appendChild(e.ownerDocument.createElement("br")),r.lang.array(["div","pre","p","table","td","th","ul","ol","li","dd","dl","footer","header","section","h1","h2","h3","h4","h5","h6"]).contains(e.nodeName.toLowerCase())&&e.parentNode.lastChild!==e&&(e.nextSibling&&3===e.nextSibling.nodeType&&/^\s/.test(e.nextSibling.nodeValue)||s.appendChild(e.ownerDocument.createTextNode(" "))),s.normalize&&s.normalize(),s}return null}for(m=0;f>m;m++)u[m]&&(l=o(u[m],t,n,i),l&&(u[m]===l&&m--,a.appendChild(l)));if(t&&a.nodeName.toLowerCase()===v&&(!a.childNodes.length||/^\s*$/gi.test(a.innerHTML)&&(n||"_wysihtml5-temp-placeholder"!==e.className&&"rangySelectionBoundary"!==e.className)||!a.attributes.length)){for(s=a.ownerDocument.createDocumentFragment();a.firstChild;)s.appendChild(a.firstChild);return s.normalize&&s.normalize(),s}return a.normalize&&a.normalize(),a}function i(e,t){var n,o,i;for(n in t)if(t.hasOwnProperty(n)){r.lang.object(t[n]).isFunction()?o=t[n]:"string"==typeof t[n]&&T[t[n]]&&(o=T[t[n]]),i=e.querySelectorAll(n);for(var s=i.length;s--;)o(i[s])}}function s(e,t){var n,o,i,s=C.tags,l=e.nodeName.toLowerCase(),d=e.scopeName;if(e._wysihtml5)return null;if(e._wysihtml5=1,"wysihtml5-temp"===e.className)return null;if(d&&"HTML"!=d&&(l=d+":"+l),"outerHTML"in e&&(r.browser.autoClosesUnclosedTags()||"P"!==e.nodeName||"</p>"===e.outerHTML.slice(-4).toLowerCase()||(l="div")),l in s){if(n=s[l],!n||n.remove)return null;if(n.unwrap)return!1;n="string"==typeof n?{rename_tag:n}:n}else{if(!e.firstChild)return null;n={rename_tag:v}}if(n.one_of_type&&!a(e,C,n.one_of_type,t)){if(!n.remove_action)return null;if("unwrap"===n.remove_action)return!1;if("rename"!==n.remove_action)return null;i=n.remove_action_rename_to||v}return o=e.ownerDocument.createElement(i||n.rename_tag||l),h(e,o,n,t),c(e,o,n),e=null,o.normalize&&o.normalize(),o}function a(e,t,n,r){var o,i;if("SPAN"===e.nodeName&&!r&&("_wysihtml5-temp-placeholder"===e.className||"rangySelectionBoundary"===e.className))return!0;for(i in n)if(n.hasOwnProperty(i)&&t.type_definitions&&t.type_definitions[i]&&(o=t.type_definitions[i],l(e,o)))return!0;return!1}function l(e,t){var n,o,i,s,a,l=e.getAttribute("class"),c=e.getAttribute("style");if(t.methods)for(var d in t.methods)if(t.methods.hasOwnProperty(d)&&S[d]&&S[d](e))return!0;if(l&&t.classes){l=l.replace(/^\s+/g,"").replace(/\s+$/g,"").split(y),n=l.length;for(var u=0;n>u;u++)if(t.classes[l[u]])return!0}if(c&&t.styles){c=c.split(";");for(o in t.styles)if(t.styles.hasOwnProperty(o))for(var f=c.length;f--;)if(a=c[f].split(":"),a[0].replace(/\s/g,"").toLowerCase()===o&&(t.styles[o]===!0||1===t.styles[o]||r.lang.array(t.styles[o]).contains(a[1].replace(/\s/g,"").toLowerCase())))return!0}if(t.attrs)for(i in t.attrs)if(t.attrs.hasOwnProperty(i)&&(s=r.dom.getAttribute(e,i),"string"==typeof s&&s.search(t.attrs[i])>-1))return!0;return!1}function c(e,t,n){var r,o;if(n&&n.keep_styles)for(r in n.keep_styles)if(n.keep_styles.hasOwnProperty(r)){if(o="float"===r?e.style.styleFloat||e.style.cssFloat:e.style[r],n.keep_styles[r]instanceof RegExp&&!n.keep_styles[r].test(o))continue;"float"===r?t.style[e.style.styleFloat?"styleFloat":"cssFloat"]=o:e.style[r]&&(t.style[r]=o)}}function d(e,t){var n=[];for(var r in t)t.hasOwnProperty(r)&&0===r.indexOf(e)&&n.push(r);return n}function u(e,t,n,o){var i,s=r.lang.object(n).isFunction()?n:w[n];return s&&(i=s(t,o),"string"==typeof i)?i:!1}function f(e,t){var n,o,i,s=r.lang.object(C.attributes||{}).clone(),a=r.lang.object(s).merge(r.lang.object(t||{}).clone()).get(),l={},c=r.dom.getAttributes(e);for(n in a)if(/\*$/.test(n)){i=d(n.slice(0,-1),c);for(var f=0,h=i.length;h>f;f++)o=u(i[f],c[i[f]],a[n],e.nodeName),o!==!1&&(l[i[f]]=o)}else o=u(n,c[n],a[n],e.nodeName),o!==!1&&(l[n]=o);return l}function h(e,t,n,o){var i,s,a,l,c,d={},u=n.set_class,h=n.add_class,m=n.add_style,p=n.set_attributes,g=C.classes,v=0,b=[],N=[],w=[],S=[];if(p&&(d=r.lang.object(p).clone()),d=r.lang.object(d).merge(f(e,n.check_attributes)).get(),u&&b.push(u),h)for(l in h)c=x[h[l]],c&&(a=c(r.dom.getAttribute(e,l)),"string"==typeof a&&b.push(a));if(m)for(l in m)c=E[m[l]],c&&(newStyle=c(r.dom.getAttribute(e,l)),"string"==typeof newStyle&&N.push(newStyle));if("string"==typeof g&&"any"===g&&e.getAttribute("class"))if(C.classes_blacklist){for(S=e.getAttribute("class"),S&&(b=b.concat(S.split(y))),i=b.length;i>v;v++)s=b[v],C.classes_blacklist[s]||w.push(s);w.length&&(d["class"]=r.lang.array(w).unique().join(" "))}else d["class"]=e.getAttribute("class");else{for(o||(g["_wysihtml5-temp-placeholder"]=1,g._rangySelectionBoundary=1,g["wysiwyg-tmp-selected-cell"]=1),S=e.getAttribute("class"),S&&(b=b.concat(S.split(y))),i=b.length;i>v;v++)s=b[v],g[s]&&w.push(s);w.length&&(d["class"]=r.lang.array(w).unique().join(" "))}d["class"]&&o&&(d["class"]=d["class"].replace("wysiwyg-tmp-selected-cell",""),/^\s*$/g.test(d["class"])&&delete d["class"]),N.length&&(d.style=r.lang.array(N).unique().join(" "));for(l in d)try{t.setAttribute(l,d[l])}catch(T){}d.src&&("undefined"!=typeof d.width&&t.setAttribute("width",d.width),"undefined"!=typeof d.height&&t.setAttribute("height",d.height))}function m(e){var t=e.nextSibling;if(!t||t.nodeType!==r.TEXT_NODE){var n=e.data.replace(r.INVISIBLE_SPACE_REG_EXP,"");return e.ownerDocument.createTextNode(n)}t.data=e.data.replace(r.INVISIBLE_SPACE_REG_EXP,"")+t.data.replace(r.INVISIBLE_SPACE_REG_EXP,"")}function p(e){return C.comments?e.ownerDocument.createComment(e.nodeValue):void 0}var g={1:s,3:m,8:p},v="span",y=/\s+/,b={tags:{},classes:{}},C={},N=["ADDRESS","BLOCKQUOTE","CENTER","DIR","DIV","DL","FIELDSET","FORM","H1","H2","H3","H4","H5","H6","ISINDEX","MENU","NOFRAMES","NOSCRIPT","OL","P","PRE","TABLE","UL"],w={url:function(){var e=/^https?:\/\//i;return function(t){return t&&t.match(e)?t.replace(e,function(e){return e.toLowerCase()}):null}}(),src:function(){var e=/^(\/|https?:\/\/)/i;return function(t){return t&&t.match(e)?t.replace(e,function(e){return e.toLowerCase()}):null}}(),href:function(){var e=/^(#|\/|https?:\/\/|mailto:|tel:)/i;return function(t){return t&&t.match(e)?t.replace(e,function(e){return e.toLowerCase()}):null}}(),alt:function(){var e=/[^ a-z0-9_\-]/gi;return function(t,n){return t?t.replace(e,""):"IMG"===n?"":null}}(),numbers:function(){var e=/\D/g;return function(t){return t=(t||"").replace(e,""),t||null}}(),dimension:function(){var e=/\D*(\d+)(\.\d+)?\s?(%)?\D*/;return function(t){return t=(t||"").replace(e,"$1$2$3"),t||null}}(),any:function(){return function(e){return e?e:null}}()},E={align_text:function(){var e={left:"text-align: left;",right:"text-align: right;",center:"text-align: center;"};return function(t){return e[String(t).toLowerCase()]}}()},x={align_img:function(){var e={left:"wysiwyg-float-left",right:"wysiwyg-float-right"};return function(t){return e[String(t).toLowerCase()]}}(),align_text:function(){var e={left:"wysiwyg-text-align-left",right:"wysiwyg-text-align-right",center:"wysiwyg-text-align-center",justify:"wysiwyg-text-align-justify"};return function(t){return e[String(t).toLowerCase()]}}(),clear_br:function(){var e={left:"wysiwyg-clear-left",right:"wysiwyg-clear-right",both:"wysiwyg-clear-both",all:"wysiwyg-clear-both"};return function(t){return e[String(t).toLowerCase()]}}(),size_font:function(){var e={1:"wysiwyg-font-size-xx-small",2:"wysiwyg-font-size-small",3:"wysiwyg-font-size-medium",4:"wysiwyg-font-size-large",5:"wysiwyg-font-size-x-large",6:"wysiwyg-font-size-xx-large",7:"wysiwyg-font-size-xx-large","-":"wysiwyg-font-size-smaller","+":"wysiwyg-font-size-larger"};return function(t){return e[String(t).charAt(0)]}}()},S={has_visible_contet:function(){var e,t=["img","video","picture","br","script","noscript","style","table","iframe","object","embed","audio","svg","input","button","select","textarea","canvas"];return function(n){if(e=(n.innerText||n.textContent).replace(/\s/g,""),e&&e.length>0)return!0;for(var r=t.length;r--;)if(n.querySelector(t[r]))return!0;return n.offsetWidth&&n.offsetWidth>0&&n.offsetHeight&&n.offsetHeight>0?!0:!1}}()},T={unwrap:function(e){r.dom.unwrap(e)},remove:function(e){e.parentNode.removeChild(e)}};return n(e,t)},r.dom.removeEmptyTextNodes=function(e){for(var t,n=r.lang.array(e.childNodes).get(),o=n.length,i=0;o>i;i++)t=n[i],t.nodeType===r.TEXT_NODE&&/^[\n\r]*$/.test(t.data)&&t.parentNode.removeChild(t)},r.dom.renameElement=function(e,t){for(var n,o=e.ownerDocument.createElement(t);n=e.firstChild;)o.appendChild(n);return r.dom.copyAttributes(["align","className"]).from(e).to(o),e.parentNode&&e.parentNode.replaceChild(o,e),o},r.dom.replaceWithChildNodes=function(e){if(e.parentNode){if(!e.firstChild)return void e.parentNode.removeChild(e);for(var t=e.ownerDocument.createDocumentFragment();e.firstChild;)t.appendChild(e.firstChild);e.parentNode.replaceChild(t,e),e=t=null}},function(e){function t(t){return"block"===e.getStyle("display").from(t)}function n(e){return"BR"===e.nodeName}function o(e){var t=e.ownerDocument.createElement("br");e.appendChild(t)}function i(e,i){if(e.nodeName.match(/^(MENU|UL|OL)$/)){var s,a,l,c,d,u,f,h=e.ownerDocument,m=h.createDocumentFragment(),p=r.dom.domNode(e).prev({ignoreBlankTexts:!0}),g=r.dom.domNode(e).next({ignoreBlankTexts:!0}),v=e.lastElementChild||e.lastChild;if(i)for(!p||t(p)||n(p)||o(m);u=e.firstElementChild||e.firstChild;){for(a=u.lastChild,f=u===v;s=u.firstChild;)l=s===a,c=(!f||g&&!t(g))&&l&&!t(s)&&!n(s),m.appendChild(s),c&&o(m);u.parentNode.removeChild(u)}else for(;u=e.firstElementChild||e.firstChild;){if(u.querySelector&&u.querySelector("div, p, ul, ol, menu, blockquote, h1, h2, h3, h4, h5, h6"))for(;s=u.firstChild;)m.appendChild(s);else{for(d=h.createElement("p");s=u.firstChild;)d.appendChild(s);m.appendChild(d)}u.parentNode.removeChild(u)}e.parentNode.replaceChild(m,e)}}e.resolveList=i}(r.dom),function(e){var t=document,n=["parent","top","opener","frameElement","frames","localStorage","globalStorage","sessionStorage","indexedDB"],r=["open","close","openDialog","showModalDialog","alert","confirm","prompt","openDatabase","postMessage","XMLHttpRequest","XDomainRequest"],i=["referrer","write","open","close"];e.dom.Sandbox=o.extend({constructor:function(t,n){this.callback=t||e.EMPTY_FUNCTION,this.config=e.lang.object({}).merge(n).get(),this.config.className||(this.config.className="wysihtml5-sandbox"),this.editableArea=this._createIframe()},insertInto:function(e){"string"==typeof e&&(e=t.getElementById(e)),e.appendChild(this.editableArea)},getIframe:function(){return this.editableArea},getWindow:function(){this._readyError()},getDocument:function(){this._readyError()},destroy:function(){var e=this.getIframe();e.parentNode.removeChild(e)},_readyError:function(){throw new Error("wysihtml5.Sandbox: Sandbox iframe isn't loaded yet")},_createIframe:function(){var n=this,r=t.createElement("iframe");return r.className=this.config.className,e.dom.setAttributes({security:"restricted",allowtransparency:"true",frameborder:0,width:0,height:0,marginwidth:0,marginheight:0}).on(r),e.browser.throwsMixedContentWarningWhenIframeSrcIsEmpty()&&(r.src="javascript:'<html></html>'"),r.onload=function(){r.onreadystatechange=r.onload=null,n._onLoadIframe(r)},r.onreadystatechange=function(){/loaded|complete/.test(r.readyState)&&(r.onreadystatechange=r.onload=null,n._onLoadIframe(r))},r},_onLoadIframe:function(o){if(e.dom.contains(t.documentElement,o)){var s=this,a=o.contentWindow,l=o.contentWindow.document,c=t.characterSet||t.charset||"utf-8",d=this._getHtml({charset:c,stylesheets:this.config.stylesheets});if(l.open("text/html","replace"),l.write(d),l.close(),this.getWindow=function(){return o.contentWindow},this.getDocument=function(){return o.contentWindow.document},a.onerror=function(e,t,n){throw new Error("wysihtml5.Sandbox: "+e,t,n)},!e.browser.supportsSandboxedIframes()){var u,f;for(u=0,f=n.length;f>u;u++)this._unset(a,n[u]);for(u=0,f=r.length;f>u;u++)this._unset(a,r[u],e.EMPTY_FUNCTION);for(u=0,f=i.length;f>u;u++)this._unset(l,i[u]);this._unset(l,"cookie","",!0)}e.polyfills&&e.polyfills(a,l),this.loaded=!0,setTimeout(function(){s.callback(s)},0)}},_getHtml:function(t){var n,r=t.stylesheets,o="",i=0;if(r="string"==typeof r?[r]:r)for(n=r.length;n>i;i++)o+='<link rel="stylesheet" href="'+r[i]+'">';return t.stylesheets=o,e.lang.string('<!DOCTYPE html><html><head><meta charset="#{charset}">#{stylesheets}</head><body></body></html>').interpolate(t)},_unset:function(t,n,r,o){try{t[n]=r}catch(i){}try{t.__defineGetter__(n,function(){return r})}catch(i){}if(o)try{t.__defineSetter__(n,function(){})}catch(i){}if(!e.browser.crashesWhenDefineProperty(n))try{var s={get:function(){return r}};o&&(s.set=function(){}),Object.defineProperty(t,n,s)}catch(i){}}})}(r),function(e){var t=document;e.dom.ContentEditableArea=o.extend({getContentEditable:function(){return this.element},getWindow:function(){return this.element.ownerDocument.defaultView||this.element.ownerDocument.parentWindow},getDocument:function(){return this.element.ownerDocument},constructor:function(t,n,r){this.callback=t||e.EMPTY_FUNCTION,this.config=e.lang.object({}).merge(n).get(),this.config.className||(this.config.className="wysihtml5-sandbox"),this.element=r?this._bindElement(r):this._createElement()},_createElement:function(){var e=t.createElement("div");return e.className=this.config.className,this._loadElement(e),e},_bindElement:function(e){return e.className=e.className?e.className+" wysihtml5-sandbox":"wysihtml5-sandbox",this._loadElement(e,!0),e},_loadElement:function(e,t){var n=this;if(!t){var r=this._getHtml();e.innerHTML=r}this.loaded=!0,setTimeout(function(){n.callback(n)},0)},_getHtml:function(){return""}})}(r),function(){var e={className:"class"};r.dom.setAttributes=function(t){return{on:function(n){for(var r in t)n.setAttribute(e[r]||r,t[r])}}}}(),r.dom.setStyles=function(e){return{on:function(t){var n=t.style;if("string"==typeof e)return void(n.cssText+=";"+e);for(var r in e)"float"===r?(n.cssFloat=e[r],n.styleFloat=e[r]):n[r]=e[r]}}},function(e){e.simulatePlaceholder=function(t,n,r,o){var i=o||"wysihtml5-placeholder",s=function(){var t=n.element.offsetWidth>0&&n.element.offsetHeight>0;n.hasPlaceholderSet()&&(n.clear(),n.element.focus(),t&&setTimeout(function(){var e=n.selection.getSelection();e.focusNode&&e.anchorNode||n.selection.selectNode(n.element.firstChild||n.element)},0)),n.placeholderSet=!1,e.removeClass(n.element,i)},a=function(){n.isEmpty()&&!n.placeholderSet&&(n.placeholderSet=!0,n.setValue(r),e.addClass(n.element,i))};t.on("set_placeholder",a).on("unset_placeholder",s).on("focus:composer",s).on("paste:composer",s).on("blur:composer",a),a()}}(r.dom),function(e){var t=document.documentElement;"textContent"in t?(e.setTextContent=function(e,t){e.textContent=t},e.getTextContent=function(e){return e.textContent}):"innerText"in t?(e.setTextContent=function(e,t){e.innerText=t},e.getTextContent=function(e){return e.innerText}):(e.setTextContent=function(e,t){e.nodeValue=t},e.getTextContent=function(e){return e.nodeValue})}(r.dom),r.dom.getAttribute=function(e,t){var n=!r.browser.supportsGetAttributeCorrectly();t=t.toLowerCase();var o=e.nodeName;if("IMG"==o&&"src"==t&&r.dom.isLoadedImage(e)===!0)return e.src;if(n&&"outerHTML"in e){var i=e.outerHTML.toLowerCase(),s=-1!=i.indexOf(" "+t+"=");return s?e.getAttribute(t):null}return e.getAttribute(t)},r.dom.getAttributes=function(e){var t,n=!r.browser.supportsGetAttributeCorrectly(),o=e.nodeName,i=[];for(t in e.attributes)(e.attributes.hasOwnProperty&&e.attributes.hasOwnProperty(t)||!e.attributes.hasOwnProperty&&Object.prototype.hasOwnProperty.call(e.attributes,t))&&e.attributes[t].specified&&("IMG"==o&&"src"==e.attributes[t].name.toLowerCase()&&r.dom.isLoadedImage(e)===!0?i.src=e.src:r.lang.array(["rowspan","colspan"]).contains(e.attributes[t].name.toLowerCase())&&n?1!==e.attributes[t].value&&(i[e.attributes[t].name]=e.attributes[t].value):i[e.attributes[t].name]=e.attributes[t].value);return i},r.dom.isLoadedImage=function(e){try{return e.complete&&!e.mozMatchesSelector(":-moz-broken")}catch(t){if(e.complete&&"complete"===e.readyState)return!0}},function(e){function t(e,t){for(var n,r=[],o=0,i=e.length;i>o;o++)if(n=e[o].querySelectorAll(t))for(var s=n.length;s--;r.unshift(n[s]));return r}function n(e){e.parentNode.removeChild(e)}function r(e,t){e.parentNode.insertBefore(t,e.nextSibling)}function o(e,t){for(var n=e.nextSibling;1!=n.nodeType;)if(n=n.nextSibling,!t||t==n.tagName.toLowerCase())return n;return null}var i=e.dom,s=function(e){this.el=e,this.isColspan=!1,this.isRowspan=!1,this.firstCol=!0,this.lastCol=!0,this.firstRow=!0,this.lastRow=!0,this.isReal=!0,this.spanCollection=[],this.modified=!1},a=function(e,t){e?(this.cell=e,this.table=i.getParentElement(e,{query:"table"})):t&&(this.table=t,this.cell=this.table.querySelectorAll("th, td")[0])};a.prototype={addSpannedCellToMap:function(e,t,n,r,o,i){for(var a=[],l=n+(i?parseInt(i,10)-1:0),c=r+(o?parseInt(o,10)-1:0),d=n;l>=d;d++){"undefined"==typeof t[d]&&(t[d]=[]);for(var u=r;c>=u;u++)t[d][u]=new s(e),t[d][u].isColspan=o&&parseInt(o,10)>1,t[d][u].isRowspan=i&&parseInt(i,10)>1,t[d][u].firstCol=u==r,t[d][u].lastCol=u==c,t[d][u].firstRow=d==n,t[d][u].lastRow=d==l,t[d][u].isReal=u==r&&d==n,t[d][u].spanCollection=a,a.push(t[d][u])}},setCellAsModified:function(e){if(e.modified=!0,e.spanCollection.length>0)for(var t=0,n=e.spanCollection.length;n>t;t++)e.spanCollection[t].modified=!0},setTableMap:function(){var e,t,n,r,o,a,l,c,d=[],u=this.getTableRows();for(e=0;e<u.length;e++)for(t=u[e],n=this.getRowCells(t),a=0,"undefined"==typeof d[e]&&(d[e]=[]),r=0;r<n.length;r++){for(o=n[r];"undefined"!=typeof d[e][a];)a++;l=i.getAttribute(o,"colspan"),c=i.getAttribute(o,"rowspan"),l||c?(this.addSpannedCellToMap(o,d,e,a,l,c),a+=l?parseInt(l,10):1):(d[e][a]=new s(o),a++)}return this.map=d,d},getRowCells:function(n){var r=this.table.querySelectorAll("table"),o=r?t(r,"th, td"):[],i=n.querySelectorAll("th, td"),s=o.length>0?e.lang.array(i).without(o):i;return s},getTableRows:function(){var n=this.table.querySelectorAll("table"),r=n?t(n,"tr"):[],o=this.table.querySelectorAll("tr"),i=r.length>0?e.lang.array(o).without(r):o;return i},getMapIndex:function(e){for(var t=this.map.length,n=this.map&&this.map[0]?this.map[0].length:0,r=0;t>r;r++)for(var o=0;n>o;o++)if(this.map[r][o].el===e)return{row:r,col:o};return!1},getElementAtIndex:function(e){return this.setTableMap(),this.map[e.row]&&this.map[e.row][e.col]&&this.map[e.row][e.col].el?this.map[e.row][e.col].el:null},getMapElsTo:function(e){var t=[];if(this.setTableMap(),this.idx_start=this.getMapIndex(this.cell),this.idx_end=this.getMapIndex(e),this.idx_start.row>this.idx_end.row||this.idx_start.row==this.idx_end.row&&this.idx_start.col>this.idx_end.col){var n=this.idx_start;
this.idx_start=this.idx_end,this.idx_end=n}if(this.idx_start.col>this.idx_end.col){var r=this.idx_start.col;this.idx_start.col=this.idx_end.col,this.idx_end.col=r}if(null!=this.idx_start&&null!=this.idx_end)for(var o=this.idx_start.row,i=this.idx_end.row;i>=o;o++)for(var s=this.idx_start.col,a=this.idx_end.col;a>=s;s++)t.push(this.map[o][s].el);return t},orderSelectionEnds:function(e){if(this.setTableMap(),this.idx_start=this.getMapIndex(this.cell),this.idx_end=this.getMapIndex(e),this.idx_start.row>this.idx_end.row||this.idx_start.row==this.idx_end.row&&this.idx_start.col>this.idx_end.col){var t=this.idx_start;this.idx_start=this.idx_end,this.idx_end=t}if(this.idx_start.col>this.idx_end.col){var n=this.idx_start.col;this.idx_start.col=this.idx_end.col,this.idx_end.col=n}return{start:this.map[this.idx_start.row][this.idx_start.col].el,end:this.map[this.idx_end.row][this.idx_end.col].el}},createCells:function(e,t,n){for(var r,o=this.table.ownerDocument,i=o.createDocumentFragment(),s=0;t>s;s++){if(r=o.createElement(e),n)for(var a in n)n.hasOwnProperty(a)&&r.setAttribute(a,n[a]);r.appendChild(document.createTextNode(" ")),i.appendChild(r)}return i},correctColIndexForUnreals:function(e,t){for(var n=this.map[t],r=-1,o=0;e>o;o++)n[o].isReal&&r++;return r},getLastNewCellOnRow:function(e,t){for(var n,r,o=this.getRowCells(e),i=0,s=o.length;s>i;i++)if(n=o[i],r=this.getMapIndex(n),r===!1||"undefined"!=typeof t&&r.row!=t)return n;return null},removeEmptyTable:function(){var e=this.table.querySelectorAll("td, th");return e&&0!=e.length?!1:(n(this.table),!0)},splitRowToCells:function(e){if(e.isColspan){var t=parseInt(i.getAttribute(e.el,"colspan")||1,10),n=e.el.tagName.toLowerCase();if(t>1){var o=this.createCells(n,t-1);r(e.el,o)}e.el.removeAttribute("colspan")}},getRealRowEl:function(e,t){var n=null,r=null;t=t||this.idx;for(var o=0,s=this.map[t.row].length;s>o;o++)if(r=this.map[t.row][o],r.isReal&&(n=i.getParentElement(r.el,{query:"tr"})))return n;return null===n&&e&&(n=i.getParentElement(this.map[t.row][t.col].el,{query:"tr"})||null),n},injectRowAt:function(e,t,n,o,s){var a=this.getRealRowEl(!1,{row:e,col:t}),l=this.createCells(o,n);if(a){var c=this.correctColIndexForUnreals(t,e);c>=0?r(this.getRowCells(a)[c],l):a.insertBefore(l,a.firstChild)}else{var d=this.table.ownerDocument.createElement("tr");d.appendChild(l),r(i.getParentElement(s.el,{query:"tr"}),d)}},canMerge:function(e){if(this.to=e,this.setTableMap(),this.idx_start=this.getMapIndex(this.cell),this.idx_end=this.getMapIndex(this.to),this.idx_start.row>this.idx_end.row||this.idx_start.row==this.idx_end.row&&this.idx_start.col>this.idx_end.col){var t=this.idx_start;this.idx_start=this.idx_end,this.idx_end=t}if(this.idx_start.col>this.idx_end.col){var n=this.idx_start.col;this.idx_start.col=this.idx_end.col,this.idx_end.col=n}for(var r=this.idx_start.row,o=this.idx_end.row;o>=r;r++)for(var i=this.idx_start.col,s=this.idx_end.col;s>=i;i++)if(this.map[r][i].isColspan||this.map[r][i].isRowspan)return!1;return!0},decreaseCellSpan:function(e,t){var n=parseInt(i.getAttribute(e.el,t),10)-1;n>=1?e.el.setAttribute(t,n):(e.el.removeAttribute(t),"colspan"==t&&(e.isColspan=!1),"rowspan"==t&&(e.isRowspan=!1),e.firstCol=!0,e.lastCol=!0,e.firstRow=!0,e.lastRow=!0,e.isReal=!0)},removeSurplusLines:function(){var e,t,r,o,s,a,l;if(this.setTableMap(),this.map){for(r=0,o=this.map.length;o>r;r++){for(e=this.map[r],l=!0,s=0,a=e.length;a>s;s++)if(t=e[s],!(i.getAttribute(t.el,"rowspan")&&parseInt(i.getAttribute(t.el,"rowspan"),10)>1&&t.firstRow!==!0)){l=!1;break}if(l)for(s=0;a>s;s++)this.decreaseCellSpan(e[s],"rowspan")}var c=this.getTableRows();for(r=0,o=c.length;o>r;r++)e=c[r],0==e.childNodes.length&&/^\s*$/.test(e.textContent||e.innerText)&&n(e)}},fillMissingCells:function(){var e=0,t=0,n=null;if(this.setTableMap(),this.map){e=this.map.length;for(var o=0;e>o;o++)this.map[o].length>t&&(t=this.map[o].length);for(var i=0;e>i;i++)for(var a=0;t>a;a++)this.map[i]&&!this.map[i][a]&&a>0&&(this.map[i][a]=new s(this.createCells("td",1)),n=this.map[i][a-1],n&&n.el&&n.el.parent&&r(this.map[i][a-1].el,this.map[i][a].el))}},rectify:function(){return this.removeEmptyTable()?!1:(this.removeSurplusLines(),this.fillMissingCells(),!0)},unmerge:function(){if(this.rectify()&&(this.setTableMap(),this.idx=this.getMapIndex(this.cell),this.idx)){var e=this.map[this.idx.row][this.idx.col],t=i.getAttribute(e.el,"colspan")?parseInt(i.getAttribute(e.el,"colspan"),10):1,n=e.el.tagName.toLowerCase();if(e.isRowspan){var r=parseInt(i.getAttribute(e.el,"rowspan"),10);if(r>1)for(var o=1,s=r-1;s>=o;o++)this.injectRowAt(this.idx.row+o,this.idx.col,t,n,e);e.el.removeAttribute("rowspan")}this.splitRowToCells(e)}},merge:function(e){if(this.rectify())if(this.canMerge(e)){for(var t=this.idx_end.row-this.idx_start.row+1,r=this.idx_end.col-this.idx_start.col+1,o=this.idx_start.row,i=this.idx_end.row;i>=o;o++)for(var s=this.idx_start.col,a=this.idx_end.col;a>=s;s++)o==this.idx_start.row&&s==this.idx_start.col?(t>1&&this.map[o][s].el.setAttribute("rowspan",t),r>1&&this.map[o][s].el.setAttribute("colspan",r)):(/^\s*<br\/?>\s*$/.test(this.map[o][s].el.innerHTML.toLowerCase())||(this.map[this.idx_start.row][this.idx_start.col].el.innerHTML+=" "+this.map[o][s].el.innerHTML),n(this.map[o][s].el));this.rectify()}else window.console&&console.log("Do not know how to merge allready merged cells.")},collapseCellToNextRow:function(e){var t=this.getMapIndex(e.el),n=t.row+1,o={row:n,col:t.col};if(n<this.map.length){var s=this.getRealRowEl(!1,o);if(null!==s){var a=this.correctColIndexForUnreals(o.col,o.row);if(a>=0)r(this.getRowCells(s)[a],e.el);else{var l=this.getLastNewCellOnRow(s,n);null!==l?r(l,e.el):s.insertBefore(e.el,s.firstChild)}parseInt(i.getAttribute(e.el,"rowspan"),10)>2?e.el.setAttribute("rowspan",parseInt(i.getAttribute(e.el,"rowspan"),10)-1):e.el.removeAttribute("rowspan")}}},removeRowCell:function(e){e.isReal?e.isRowspan?this.collapseCellToNextRow(e):n(e.el):parseInt(i.getAttribute(e.el,"rowspan"),10)>2?e.el.setAttribute("rowspan",parseInt(i.getAttribute(e.el,"rowspan"),10)-1):e.el.removeAttribute("rowspan")},getRowElementsByCell:function(){var e=[];if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),this.idx!==!1)for(var t=this.map[this.idx.row],n=0,r=t.length;r>n;n++)t[n].isReal&&e.push(t[n].el);return e},getColumnElementsByCell:function(){var e=[];if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),this.idx!==!1)for(var t=0,n=this.map.length;n>t;t++)this.map[t][this.idx.col]&&this.map[t][this.idx.col].isReal&&e.push(this.map[t][this.idx.col].el);return e},removeRow:function(){var e=i.getParentElement(this.cell,{query:"tr"});if(e){if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),this.idx!==!1)for(var t=this.map[this.idx.row],r=0,o=t.length;o>r;r++)t[r].modified||(this.setCellAsModified(t[r]),this.removeRowCell(t[r]));n(e)}},removeColCell:function(e){e.isColspan?parseInt(i.getAttribute(e.el,"colspan"),10)>2?e.el.setAttribute("colspan",parseInt(i.getAttribute(e.el,"colspan"),10)-1):e.el.removeAttribute("colspan"):e.isReal&&n(e.el)},removeColumn:function(){if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),this.idx!==!1)for(var e=0,t=this.map.length;t>e;e++)this.map[e][this.idx.col].modified||(this.setCellAsModified(this.map[e][this.idx.col]),this.removeColCell(this.map[e][this.idx.col]))},remove:function(e){if(this.rectify()){switch(e){case"row":this.removeRow();break;case"column":this.removeColumn()}this.rectify()}},addRow:function(e){var t=this.table.ownerDocument;if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),"below"==e&&i.getAttribute(this.cell,"rowspan")&&(this.idx.row=this.idx.row+parseInt(i.getAttribute(this.cell,"rowspan"),10)-1),this.idx!==!1){for(var n=this.map[this.idx.row],o=t.createElement("tr"),s=0,a=n.length;a>s;s++)n[s].modified||(this.setCellAsModified(n[s]),this.addRowCell(n[s],o,e));switch(e){case"below":r(this.getRealRowEl(!0),o);break;case"above":var l=i.getParentElement(this.map[this.idx.row][this.idx.col].el,{query:"tr"});l&&l.parentNode.insertBefore(o,l)}}},addRowCell:function(e,t,n){var r=e.isColspan?{colspan:i.getAttribute(e.el,"colspan")}:null;e.isReal?"above"!=n&&e.isRowspan?e.el.setAttribute("rowspan",parseInt(i.getAttribute(e.el,"rowspan"),10)+1):t.appendChild(this.createCells("td",1,r)):"above"!=n&&e.isRowspan&&e.lastRow?t.appendChild(this.createCells("td",1,r)):c.isRowspan&&e.el.attr("rowspan",parseInt(i.getAttribute(e.el,"rowspan"),10)+1)},add:function(e){this.rectify()&&(("below"==e||"above"==e)&&this.addRow(e),("before"==e||"after"==e)&&this.addColumn(e))},addColCell:function(e,t,n){var o,s=e.el.tagName.toLowerCase();switch(n){case"before":o=!e.isColspan||e.firstCol;break;case"after":o=!e.isColspan||e.lastCol||e.isColspan&&c.el==this.cell}if(o){switch(n){case"before":e.el.parentNode.insertBefore(this.createCells(s,1),e.el);break;case"after":r(e.el,this.createCells(s,1))}e.isRowspan&&this.handleCellAddWithRowspan(e,t+1,n)}else e.el.setAttribute("colspan",parseInt(i.getAttribute(e.el,"colspan"),10)+1)},addColumn:function(e){var t,n;if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),"after"==e&&i.getAttribute(this.cell,"colspan")&&(this.idx.col=this.idx.col+parseInt(i.getAttribute(this.cell,"colspan"),10)-1),this.idx!==!1)for(var r=0,o=this.map.length;o>r;r++)t=this.map[r],t[this.idx.col]&&(n=t[this.idx.col],n.modified||(this.setCellAsModified(n),this.addColCell(n,r,e)))},handleCellAddWithRowspan:function(e,t,n){for(var s,a,l,c=parseInt(i.getAttribute(this.cell,"rowspan"),10)-1,d=i.getParentElement(e.el,{query:"tr"}),u=e.el.tagName.toLowerCase(),f=this.table.ownerDocument,h=0;c>h;h++)if(s=this.correctColIndexForUnreals(this.idx.col,t+h),d=o(d,"tr"))if(s>0)switch(n){case"before":a=this.getRowCells(d),s>0&&this.map[t+h][this.idx.col].el!=a[s]&&s==a.length-1?r(a[s],this.createCells(u,1)):a[s].parentNode.insertBefore(this.createCells(u,1),a[s]);break;case"after":r(this.getRowCells(d)[s],this.createCells(u,1))}else d.insertBefore(this.createCells(u,1),d.firstChild);else l=f.createElement("tr"),l.appendChild(this.createCells(u,1)),this.table.appendChild(l)}},i.table={getCellsBetween:function(e,t){var n=new a(e);return n.getMapElsTo(t)},addCells:function(e,t){var n=new a(e);n.add(t)},removeCells:function(e,t){var n=new a(e);n.remove(t)},mergeCellsBetween:function(e,t){var n=new a(e);n.merge(t)},unmergeCell:function(e){var t=new a(e);t.unmerge()},orderSelectionEnds:function(e,t){var n=new a(e);return n.orderSelectionEnds(t)},indexOf:function(e){var t=new a(e);return t.setTableMap(),t.getMapIndex(e)},findCell:function(e,t){var n=new a(null,e);return n.getElementAtIndex(t)},findRowByCell:function(e){var t=new a(e);return t.getRowElementsByCell()},findColumnByCell:function(e){var t=new a(e);return t.getColumnElementsByCell()},canMerge:function(e,t){var n=new a(e);return n.canMerge(t)}}}(r),r.dom.query=function(e,t){var n,r=[];e.nodeType&&(e=[e]);for(var o=0,i=e.length;i>o;o++)if(n=e[o].querySelectorAll(t))for(var s=n.length;s--;r.unshift(n[s]));return r},r.dom.compareDocumentPosition=function(){var e=document.documentElement;return e.compareDocumentPosition?function(e,t){return e.compareDocumentPosition(t)}:function(e,t){var n,o;if(n=9===e.nodeType?e:e.ownerDocument,o=9===t.nodeType?t:t.ownerDocument,e===t)return 0;if(e===t.ownerDocument)return 20;if(e.ownerDocument===t)return 10;if(n!==o)return 1;if(2===e.nodeType&&e.childNodes&&-1!==r.lang.array(e.childNodes).indexOf(t))return 20;if(2===t.nodeType&&t.childNodes&&-1!==r.lang.array(t.childNodes).indexOf(e))return 10;for(var i=e,s=[],a=null;i;){if(i==t)return 10;s.push(i),i=i.parentNode}for(i=t,a=null;i;){if(i==e)return 20;var l=r.lang.array(s).indexOf(i);if(-1!==l){var c=s[l],d=r.lang.array(c.childNodes).indexOf(s[l-1]),u=r.lang.array(c.childNodes).indexOf(a);return d>u?2:4}a=i,i=i.parentNode}return 1}}(),r.dom.unwrap=function(e){var t=[];if(e.parentNode){for(;e.lastChild;)t.unshift(e.lastChild),r.dom.insert(e.lastChild).after(e);e.parentNode.removeChild(e)}return t},r.dom.getPastedHtml=function(e){var t;return e.clipboardData&&(r.lang.array(e.clipboardData.types).contains("text/html")?t=e.clipboardData.getData("text/html"):r.lang.array(e.clipboardData.types).contains("text/plain")&&(t=r.lang.string(e.clipboardData.getData("text/plain")).escapeHTML(!0,!0))),t},r.dom.getPastedHtmlWithDiv=function(e,t){var n=e.selection.getBookmark(),r=e.element.ownerDocument,o=r.createElement("DIV"),i=e.getScrollPos();r.body.appendChild(o),o.style.width="1px",o.style.height="1px",o.style.overflow="hidden",o.style.position="absolute",o.style.top=i.y+"px",o.style.left=i.x+"px",o.setAttribute("contenteditable","true"),o.focus(),setTimeout(function(){var r;e.selection.setBookmark(n),r=o.innerHTML,r&&/^<br\/?>$/i.test(r.trim())&&(r=!1),t(r),o.parentNode.removeChild(o)},0)},r.dom.removeInvisibleSpaces=function(e){for(var t=r.dom.getTextNodes(e),n=t.length;n--;)t[n].nodeValue=t[n].nodeValue.replace(r.INVISIBLE_SPACE_REG_EXP,"")},r.quirks.cleanPastedHTML=function(){var e=function(e){var t=r.lang.string(e).trim(),n=t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");return new RegExp("^((?!^"+n+"$).)*$","i")},t=function(t,n){var o,i,s=r.lang.object(t).clone(!0);for(o in s.tags)if(s.tags.hasOwnProperty(o)&&s.tags[o].keep_styles)for(i in s.tags[o].keep_styles)s.tags[o].keep_styles.hasOwnProperty(i)&&n[i]&&(s.tags[o].keep_styles[i]=e(n[i]));return s},n=function(e,t){var n;if(!e)return null;for(var r=0,o=e.length;o>r;r++)if(e[r].condition||(n=e[r].set),e[r].condition&&e[r].condition.test(t))return e[r].set;return n};return function(e,o){var i,s={color:r.dom.getStyle("color").from(o.referenceNode),fontSize:r.dom.getStyle("font-size").from(o.referenceNode)},a=t(n(o.rules,e)||{},s);return i=r.dom.parse(e,{rules:a,cleanUp:!0,context:o.referenceNode.ownerDocument,uneditableClass:o.uneditableClass,clearInternals:!0,unjoinNbsps:!0})}}(),r.quirks.ensureProperClearing=function(){var e=function(){var e=this;setTimeout(function(){var t=e.innerHTML.toLowerCase();("<p>&nbsp;</p>"==t||"<p>&nbsp;</p><p>&nbsp;</p>"==t)&&(e.innerHTML="")},0)};return function(t){r.dom.observe(t.element,["cut","keydown"],e)}}(),function(e){var t="%7E";e.quirks.getCorrectInnerHTML=function(n){var r=n.innerHTML;if(-1===r.indexOf(t))return r;var o,i,s,a,l=n.querySelectorAll("[href*='~'], [src*='~']");for(a=0,s=l.length;s>a;a++)o=l[a].href||l[a].src,i=e.lang.string(o).replace("~").by(t),r=e.lang.string(r).replace(i).by(o);return r}}(r),function(e){var t="wysihtml5-quirks-redraw";e.quirks.redraw=function(n){e.dom.addClass(n,t),e.dom.removeClass(n,t);try{var r=n.ownerDocument;r.execCommand("italic",!1,null),r.execCommand("italic",!1,null)}catch(o){}}}(r),r.quirks.tableCellsSelection=function(e,t){function n(){return e.addEventListener("mousedown",m),f}function o(n){f.start=n,f.end=n,f.cells=[n],f.table=u.getParentElement(f.start,{query:"table"},!1,e),f.table&&(i(),u.addClass(n,h),e.addEventListener("mousemove",a),e.addEventListener("mouseup",l),t.fire("tableselectstart").fire("tableselectstart:composer"))}function i(){if(e){var t=e.querySelectorAll("."+h);if(t.length>0)for(var n=0;n<t.length;n++)u.removeClass(t[n],h)}}function s(e){for(var t=0;t<e.length;t++)u.addClass(e[t],h)}function a(n){var r,o=null,a=u.getParentElement(n.target,{query:"td, th"},!1,e);a&&f.table&&f.start&&(o=u.getParentElement(a,{query:"table"},!1,e),o&&o===f.table&&(i(),r=f.end,f.end=a,f.cells=u.table.getCellsBetween(f.start,a),f.cells.length>1&&t.composer.selection.deselect(),s(f.cells),f.end!==r&&t.fire("tableselectchange").fire("tableselectchange:composer")))}function l(){e.removeEventListener("mousemove",a),e.removeEventListener("mouseup",l),t.fire("tableselect").fire("tableselect:composer"),setTimeout(function(){c()},0)}function c(){e.ownerDocument.addEventListener("click",p)}function d(n,r){f.start=n,f.end=r,f.table=u.getParentElement(f.start,{query:"table"},!1,e),selectedCells=u.table.getCellsBetween(f.start,f.end),s(selectedCells),c(),t.fire("tableselect").fire("tableselect:composer")}var u=r.dom,f={table:null,start:null,end:null,cells:null,select:d},h="wysiwyg-tmp-selected-cell",m=function(t){var n=r.dom.getParentElement(t.target,{query:"td, th"},!1,e);n&&o(n)},p=function(n){e.ownerDocument.removeEventListener("click",p),u.getParentElement(n.target,{query:"table"},!1,e)!=f.table&&(i(),f.table=null,f.start=null,f.end=null,t.fire("tableunselect").fire("tableunselect:composer"))};return n()},function(e){function t(e){var t,n;for(t in r)if(r.hasOwnProperty(t)&&(n=r[t],n.regex.test(e)))return n}function n(e){var n=t(e);return n?n.name:void 0}var r={rgba:{regex:/^rgba\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*([\d\.]+)\s*\)/i,name:"rgba"},rgb:{regex:/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/i,name:"rgb"},hex6:{regex:/^#([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])/i,name:"hex",radix:16},hex3:{regex:/^#([0-9a-f])([0-9a-f])([0-9a-f])/i,name:"hex",radix:16}},o=function(e){return new RegExp("(^|\\s|;)"+e+"\\s*:\\s*[^;$]+","gi")};e.quirks.styleParser={getColorParseMethod:t,getColorFormat:n,parseColor:function(n,i){var s,a,l,c,d,u=n;if(i){if(s=o(i),!(a=n.match(s)))return!1;a=a.pop().split(":")[1],u=e.lang.string(a).trim()}return(l=t(u))&&(c=u.match(l.regex))?(d=l.radix||10,l===r.hex3?(c.shift(),c.push(1),e.lang.array(c).map(function(e,t){return 3>t?parseInt(e,d)*d+parseInt(e,d):parseFloat(e)})):(c.shift(),c[3]||c.push(1),e.lang.array(c).map(function(e,t){return 3>t?parseInt(e,d):parseFloat(e)}))):!1},unparseColor:function(e,t){var n=16;return"hex"===t?(e[0].toString(n)+e[1].toString(n)+e[2].toString(n)).toUpperCase():"hash"===t?"#"+(e[0].toString(n)+e[1].toString(n)+e[2].toString(n)).toUpperCase():"rgb"===t?"rgb("+e[0]+","+e[1]+","+e[2]+")":"rgba"===t?"rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")":"csv"===t?e[0]+","+e[1]+","+e[2]+","+e[3]:e[3]&&1!==e[3]?"rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")":"rgb("+e[0]+","+e[1]+","+e[2]+")"},parseFontSize:function(t){var n=t.match(o("font-size"));return n?e.lang.string(n[n.length-1].split(":")[1]).trim():!1}}}(r),function(e){function t(e){var t=0;if(e.parentNode)do t+=e.offsetTop||0,e=e.offsetParent;while(e);return t}function n(e,t){for(var n=0;t!==e;)if(n++,t=t.parentNode,!t)throw new Error("not a descendant of ancestor!");return n}function r(t){var n=document.createElement("span"),r=function(){t.removeEventListener("mouseup",r),t.removeEventListener("keydown",r),t.removeEventListener("touchstart",r),t.removeEventListener("focus",r),t.removeEventListener("blur",r),t.removeEventListener("paste",o),t.removeEventListener("drop",o),t.removeEventListener("beforepaste",o),n&&n.parentNode&&n.parentNode.removeChild(n)},o=function(){n&&n.parentNode&&setTimeout(r,0)};return n.appendChild(document.createTextNode(e.INVISIBLE_SPACE)),n.className="_wysihtml5-temp-caret-fix",n.style.display="block",n.style.minWidth="1px",n.style.height="0px",t.addEventListener("mouseup",r),t.addEventListener("keydown",r),t.addEventListener("touchstart",r),t.addEventListener("focus",r),t.addEventListener("blur",r),t.addEventListener("paste",o),t.addEventListener("drop",o),t.addEventListener("beforepaste",o),n}function i(e){if(!e.canSurroundContents())for(var t=e.commonAncestorContainer,r=n(t,e.startContainer),o=n(t,e.endContainer);!e.canSurroundContents();)r>o?(e.setStartBefore(e.startContainer),r=n(t,e.startContainer)):(e.setEndAfter(e.endContainer),o=n(t,e.endContainer))}var s=e.dom;e.Selection=o.extend({constructor:function(e,t,n){window.rangy.init(),this.editor=e,this.composer=e.composer,this.doc=this.composer.doc,this.win=this.composer.win,this.contain=t,this.unselectableClass=n||!1},getBookmark:function(){var e=this.getRange();return e&&e.cloneRange()},setBookmark:function(e){e&&this.setSelection(e)},setBefore:function(e){var t=rangy.createRange(this.doc);return t.setStartBefore(e),t.setEndBefore(e),this.setSelection(t)},createTemporaryCaretSpaceAfter:function(t){var n=this.doc.createElement("span"),r=this.doc.createTextNode(e.INVISIBLE_SPACE),o=function(){var t;this.contain.removeEventListener("mouseup",o),this.contain.removeEventListener("keydown",s),this.contain.removeEventListener("touchstart",o),this.contain.removeEventListener("focus",o),this.contain.removeEventListener("blur",o),this.contain.removeEventListener("paste",i),this.contain.removeEventListener("drop",i),this.contain.removeEventListener("beforepaste",i),n&&n.parentNode&&(n.innerHTML=n.innerHTML.replace(e.INVISIBLE_SPACE_REG_EXP,""),/[^\s]+/.test(n.innerHTML)?(t=n.lastChild,e.dom.unwrap(n),this.setAfter(t)):n.parentNode.removeChild(n))}.bind(this),i=function(){n&&n.parentNode&&setTimeout(o,0)},s=function(e){8===e.which||91===e.which||17===e.which||86===e.which&&(e.ctrlKey||e.metaKey)||o()};return n.className="_wysihtml5-temp-caret-fix",n.style.position="absolute",n.style.display="block",n.style.minWidth="1px",n.style.zIndex="99999",n.appendChild(r),t.parentNode.insertBefore(n,t.nextSibling),this.setBefore(r),this.contain.addEventListener("mouseup",o),this.contain.addEventListener("keydown",s),this.contain.addEventListener("touchstart",o),this.contain.addEventListener("focus",o),this.contain.addEventListener("blur",o),this.contain.addEventListener("paste",i),this.contain.addEventListener("drop",i),this.contain.addEventListener("beforepaste",i),n},setAfter:function(t,n,r){var o,i=this.win,s=rangy.createRange(this.doc),a=function(){var r=t.parentNode,s=r?r.childNodes[r.childNodes.length-1]:null;if(!o||s===t&&1===t.nodeType&&"block"===i.getComputedStyle(t).display)if(n){var a=this.doc.createTextNode(e.INVISIBLE_SPACE);t.parentNode.insertBefore(a,t.nextSibling),this.selectNode(a),setTimeout(function(){a&&a.parentNode&&a.parentNode.removeChild(a)},0)}else this.createTemporaryCaretSpaceAfter(t)}.bind(this);if(s.setStartAfter(t),s.setEndAfter(t),document.activeElement&&document.activeElement===this.composer.element)o=this.setSelection(s),a(),r&&r(o);else{var l=this.composer.getScrollPos();this.composer.element.focus(),this.composer.setScrollPos(l),setTimeout(function(){o=this.setSelection(s),a(),r&&r(o)}.bind(this),0)}},selectNode:function(t,n){var r=rangy.createRange(this.doc),o=t.nodeType===e.ELEMENT_NODE,i="canHaveHTML"in t?t.canHaveHTML:"IMG"!==t.nodeName,a=o?t.innerHTML:t.data,l=""===a||a===e.INVISIBLE_SPACE,c=s.getStyle("display").from(t),d="block"===c||"list-item"===c;if(l&&o&&i&&!n)try{t.innerHTML=e.INVISIBLE_SPACE}catch(u){}i?r.selectNodeContents(t):r.selectNode(t),i&&l&&o?r.collapse(d):i&&l&&(r.setStartAfter(t),r.setEndAfter(t)),this.setSelection(r)},getSelectedNode:function(e){var t,n;return e&&this.doc.selection&&"Control"===this.doc.selection.type&&(n=this.doc.selection.createRange(),n&&n.length)?n.item(0):(t=this.getSelection(this.doc),t.focusNode===t.anchorNode?t.focusNode:(n=this.getRange(this.doc),n?n.commonAncestorContainer:this.doc.body))},fixSelBorders:function(){var e=this.getRange();i(e),this.setSelection(e)},getSelectedOwnNodes:function(){for(var e=this.getOwnRanges(),t=[],n=0,r=e.length;r>n;n++)t.push(e[n].commonAncestorContainer||this.doc.body);return t},findNodesInSelection:function(t){for(var n,r=this.getOwnRanges(),o=[],i=0,s=r.length;s>i;i++)n=r[i].getNodes([1],function(n){return e.lang.array(t).contains(n.nodeName)}),o=o.concat(n);return o},filterElements:function(e){for(var t,n=this.getOwnRanges(),r=[],o=0,i=n.length;i>o;o++)t=n[o].getNodes([1],function(t){return e(t,n[o])}),r=r.concat(t);return r},containsUneditable:function(){for(var e=this.getOwnUneditables(),t=this.getSelection(),n=0,r=e.length;r>n;n++)if(t.containsNode(e[n]))return!0;return!1},deleteContents:function(){var t,n,r,o,i=this.getRange();if(this.unselectableClass){(t=e.dom.getParentElement(i.startContainer,{query:"."+this.unselectableClass},!1,this.contain))&&i.setStartBefore(t),(n=e.dom.getParentElement(i.endContainer,{query:"."+this.unselectableClass},!1,this.contain))&&i.setEndAfter(n),r=i.getNodes([1],function(t){return e.dom.hasClass(t,this.unselectableClass)}.bind(this));for(var s=r.length;s--;)try{o=new CustomEvent("wysihtml5:uneditable:delete"),r[s].dispatchEvent(o)}catch(a){}}i.deleteContents(),this.setSelection(i)},getPreviousNode:function(t,n){var r;if(!t){var o=this.getSelection();t=o.anchorNode}if(t===this.contain)return!1;var i,s=t.previousSibling;return s===this.contain?!1:(s&&3!==s.nodeType&&1!==s.nodeType?s=this.getPreviousNode(s,n):s&&3===s.nodeType&&/^\s*$/.test(s.textContent)?s=this.getPreviousNode(s,n):n&&s&&1===s.nodeType?(r=e.dom.getStyle("display").from(s),e.lang.array(["BR","HR","IMG"]).contains(s.nodeName)||e.lang.array(["block","inline-block","flex","list-item","table"]).contains(r)||!/^[\s]*$/.test(s.innerHTML)||(s=this.getPreviousNode(s,n))):s||t===this.contain||(i=t.parentNode,i!==this.contain&&(s=this.getPreviousNode(i,n))),s!==this.contain?s:!1)},getSelectionParentsByTag:function(){for(var t,n=this.getSelectedOwnNodes(),r=[],o=0,i=n.length;i>o;o++)t=n[o].nodeName&&"LI"===n[o].nodeName?n[o]:e.dom.getParentElement(n[o],{query:"li"},!1,this.contain),t&&r.push(t);return r.length?r:null},getRangeToNodeEnd:function(){if(this.isCollapsed()){var e=this.getRange(),t=e.startContainer,n=e.startOffset,r=rangy.createRange(this.doc);return r.selectNodeContents(t),r.setStart(t,n),r}},caretIsLastInSelection:function(){var e=(rangy.createRange(this.doc),this.getSelection(),this.getRangeToNodeEnd().cloneContents()),t=e.textContent;return/^\s*$/.test(t)},caretIsFirstInSelection:function(){var t=rangy.createRange(this.doc),n=this.getSelection(),r=this.getRange(),o=r.startContainer;return o?o.nodeType===e.TEXT_NODE?this.isCollapsed()&&o.nodeType===e.TEXT_NODE&&/^\s*$/.test(o.data.substr(0,r.startOffset)):(t.selectNodeContents(this.getRange().commonAncestorContainer),t.collapse(!0),this.isCollapsed()&&(t.startContainer===n.anchorNode||t.endContainer===n.anchorNode)&&t.startOffset===n.anchorOffset):void 0},caretIsInTheBeginnig:function(t){var n=this.getSelection(),r=n.anchorNode,o=n.anchorOffset;return t&&r?0===o&&(r.nodeName&&r.nodeName===t.toUpperCase()||e.dom.getParentElement(r.parentNode,{query:t},1)):r?0===o&&!this.getPreviousNode(r,!0):void 0},getBeforeSelection:function(t){var n,r,o=this.getSelection(),i=o.isBackwards()?o.focusNode:o.anchorNode,s=o.isBackwards()?o.focusOffset:o.anchorOffset,a=this.createRange();if(r=e.dom.getParentElement(i,{query:"._wysihtml5-temp-caret-fix"},1),r&&(i=r.parentNode,s=Array.prototype.indexOf.call(i.childNodes,r)),i){if(s>0)return 3===i.nodeType?(a.setStart(i,0),a.setEnd(i,s),{type:"text",range:a,offset:s,node:i}):(a.setStartBefore(i.childNodes[0]),n=i.childNodes[s-1],a.setEndAfter(n),{type:"element",range:a,offset:s,node:n});if(a.setStartAndEnd(i,0),t){var l=this.getPreviousNode(i,!0),c=null;if(l&&(c=1===l.nodeType&&e.dom.hasClass(l,this.unselectableClass)?l:e.dom.domNode(l).lastLeafNode()),c)return{type:"leafnode",range:a,offset:s,node:c}}return{type:"none",range:a,offset:s,node:i}}return null},executeAndRestoreRangy:function(e){var t=rangy.saveSelection(this.win);if(t)try{e()}catch(n){setTimeout(function(){throw n},0)}else e();rangy.restoreSelection(t)},executeAndRestore:function(t,n){var r,o,i,a,l,c,d,u,f=this.doc.body,h=n&&f.scrollTop,m=n&&f.scrollLeft,p="_wysihtml5-temp-placeholder",g='<span class="'+p+'">'+e.INVISIBLE_SPACE+"</span>",v=this.getRange(!0);if(!v)return void t(f,f);v.collapsed||(d=v.cloneRange(),c=d.createContextualFragment(g),d.collapse(!1),d.insertNode(c),d.detach()),l=v.createContextualFragment(g),v.insertNode(l),c&&(r=this.contain.querySelectorAll("."+p),v.setStartBefore(r[0]),v.setEndAfter(r[r.length-1])),this.setSelection(v);try{t(v.startContainer,v.endContainer)}catch(y){setTimeout(function(){throw y},0)}if(r=this.contain.querySelectorAll("."+p),r&&r.length){u=rangy.createRange(this.doc),i=r[0].nextSibling,r.length>1&&(a=r[r.length-1].previousSibling),a&&i?(u.setStartBefore(i),u.setEndAfter(a)):(o=this.doc.createTextNode(e.INVISIBLE_SPACE),s.insert(o).after(r[0]),u.setStartBefore(o),u.setEndAfter(o)),this.setSelection(u);for(var b=r.length;b--;)r[b].parentNode.removeChild(r[b])}else this.contain.focus();n&&(f.scrollTop=h,f.scrollLeft=m);try{r.parentNode.removeChild(r)}catch(C){}},set:function(e,t){var n=rangy.createRange(this.doc);n.setStart(e,t||0),this.setSelection(n)},insertHTML:function(e){var t,n=(rangy.createRange(this.doc),this.doc.createElement("DIV")),r=this.doc.createDocumentFragment();for(n.innerHTML=e,t=n.lastChild;n.firstChild;)r.appendChild(n.firstChild);this.insertNode(r),t&&this.setAfter(t)},insertNode:function(e){var t=this.getRange();t&&t.insertNode(e)},canAppendChild:function(e){var t,n,r=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],o=this.getRange();return t=e||o.startContainer,t&&(n=(t.tagName||t.nodeName).toLowerCase()),-1===r.indexOf(n)},splitElementAtCaret:function(t,n){var r,o,i,s,a,l=this.getSelection();if(l.rangeCount>0){r=l.getRangeAt(0).cloneRange(),r.setEndAfter(t),o=r.extractContents(),a=o.childNodes;for(var c=a.length;c--;)e.dom.domNode(a[c]).is.visible()||o.removeChild(a[c]);t.parentNode.insertBefore(o,t.nextSibling),n?(i=n.firstChild||n,s=n.lastChild||n,t.parentNode.insertBefore(n,t.nextSibling),i&&s&&(r.setStartBefore(i),r.setEndAfter(s),this.setSelection(r))):(r.setStartAfter(t),r.setEndAfter(t)),e.dom.domNode(t).is.visible()||(""===e.dom.getTextContent(t)?t.parentNode.removeChild(t):t.parentNode.replaceChild(this.doc.createTextNode(" "),t))}},surround:function(e){var t,n=this.getOwnRanges(),r=[];if(0==n.length)return r;for(var o=n.length;o--;){t=this.doc.createElement(e.nodeName),r.push(t),e.className&&(t.className=e.className),e.cssStyle&&t.setAttribute("style",e.cssStyle);try{n[o].surroundContents(t),this.selectNode(t)}catch(i){t.appendChild(n[o].extractContents()),n[o].insertNode(t)}}return r},deblockAndSurround:function(t){var n,r,o,i=this.doc.createElement("div"),s=rangy.createRange(this.doc);if(i.className=t.className,this.composer.commands.exec("formatBlock",t),n=this.contain.querySelectorAll("."+t.className),n[0])for(n[0].parentNode.insertBefore(i,n[0]),s.setStartBefore(n[0]),s.setEndAfter(n[n.length-1]),r=s.extractContents();r.firstChild;)if(o=r.firstChild,1==o.nodeType&&e.dom.hasClass(o,t.className)){for(;o.firstChild;)i.appendChild(o.firstChild);"BR"!==o.nodeName&&i.appendChild(this.doc.createElement("br")),r.removeChild(o)}else i.appendChild(o);else i=null;return i},scrollIntoView:function(){var n,r=this.doc,o=5,i=r.documentElement.scrollHeight>r.documentElement.offsetHeight,s=r._wysihtml5ScrollIntoViewElement=r._wysihtml5ScrollIntoViewElement||function(){var t=r.createElement("span");return t.innerHTML=e.INVISIBLE_SPACE,t}();i&&(this.insertNode(s),n=t(s),s.parentNode.removeChild(s),n>=r.body.scrollTop+r.documentElement.offsetHeight-o&&(r.body.scrollTop=n))},selectLine:function(){e.browser.supportsSelectionModify()?this._selectLine_W3C():this.doc.selection&&this._selectLine_MSIE()},_selectLine_W3C:function(){var e=this.win.getSelection();e.modify("move","left","lineboundary"),e.modify("extend","right","lineboundary")},toLineBoundary:function(t,n){if(n="undefined"==typeof n?!1:n,e.browser.supportsSelectionModify()){var r=this.win.getSelection();r.modify("extend",t,"lineboundary"),n&&("left"===t?r.collapseToStart():"right"===t&&r.collapseToEnd())}},_selectLine_MSIE:function(){var e,t,n,r,o,i=this.doc.selection.createRange(),s=i.boundingTop,a=this.doc.body.scrollWidth;if(i.moveToPoint){for(0===s&&(n=this.doc.createElement("span"),this.insertNode(n),s=n.offsetTop,n.parentNode.removeChild(n)),s+=1,r=-10;a>r;r+=2)try{i.moveToPoint(r,s);break}catch(l){}for(e=s,t=this.doc.selection.createRange(),o=a;o>=0;o--)try{t.moveToPoint(o,e);break}catch(c){}i.setEndPoint("EndToEnd",t),i.select()}},getText:function(){var e=this.getSelection();return e?e.toString():""},getNodes:function(e,t){var n=this.getRange();return n?n.getNodes(Array.isArray(e)?e:[e],t):[]},getOwnNodes:function(e,t,n){for(var r=this.getOwnRanges(),o=[],i=0,s=r.length;s>i;i++)r[i]&&(n&&r[i].splitBoundaries(),o=o.concat(r[i].getNodes(Array.isArray(e)?e:[e],t)));
return o},fixRangeOverflow:function(e){if(this.contain&&this.contain.firstChild&&e){var t=e.compareNode(this.contain);if(2!==t)1===t&&e.setStartBefore(this.contain.firstChild),0===t&&e.setEndAfter(this.contain.lastChild),3===t&&(e.setStartBefore(this.contain.firstChild),e.setEndAfter(this.contain.lastChild));else if(this._detectInlineRangeProblems(e)){var n=e.endContainer.previousElementSibling;n&&e.setEnd(n,this._endOffsetForNode(n))}}},_endOffsetForNode:function(e){var t=document.createRange();return t.selectNodeContents(e),t.endOffset},_detectInlineRangeProblems:function(e){var t=s.compareDocumentPosition(e.startContainer,e.endContainer);return 0==e.endOffset&&4&t},getRange:function(e){var t=this.getSelection(),n=t&&t.rangeCount&&t.getRangeAt(0);return e!==!0&&this.fixRangeOverflow(n),n},getOwnUneditables:function(){var t=s.query(this.contain,"."+this.unselectableClass),n=s.query(t,"."+this.unselectableClass);return e.lang.array(t).without(n)},getOwnRanges:function(){var e,t=[],n=this.getRange();if(n&&t.push(n),this.unselectableClass&&this.contain&&n){var r,o=this.getOwnUneditables();if(o.length>0)for(var i=0,s=o.length;s>i;i++){e=[];for(var a=0,l=t.length;l>a;a++){if(t[a])switch(t[a].compareNode(o[i])){case 2:break;case 3:r=t[a].cloneRange(),r.setEndBefore(o[i]),e.push(r),r=t[a].cloneRange(),r.setStartAfter(o[i]),e.push(r);break;default:e.push(t[a])}t=e}}}return t},getSelection:function(){return rangy.getSelection(this.win)},setSelection:function(e){var t=rangy.getSelection(this.win);return t.setSingleRange(e),t&&t.anchorNode&&t.focusNode?t:null},selectAll:function(){var t,n=this.createRange(),o=this.composer,i=this,s=r(this.composer.element),a=r(this.composer.element),l=function(){n.setStart(o.element,0),n.setEnd(o.element,o.element.childNodes.length),t=i.setSelection(n)},c=function(){return!t||t.nativeSelection&&t.nativeSelection.type&&("Caret"===t.nativeSelection.type||"None"===t.nativeSelection.type)};e.dom.removeInvisibleSpaces(this.composer.element),l(),this.composer.element.firstChild&&c()&&(this.composer.element.appendChild(s),l(),c()&&(s.parentNode.removeChild(s),this.composer.element.insertBefore(a,this.composer.element.firstChild),l(),c()&&(this.composer.element.appendChild(s),l())))},createRange:function(){return rangy.createRange(this.doc)},isCollapsed:function(){return this.getSelection().isCollapsed},getHtml:function(){return this.getSelection().toHtml()},getPlainText:function(){return this.getSelection().toString()},isEndToEndInNode:function(t){var n=this.getRange(),r=n.commonAncestorContainer,o=n.startContainer,i=n.endContainer;if(r.nodeType===e.TEXT_NODE&&(r=r.parentNode),o.nodeType===e.TEXT_NODE&&!/^\s*$/.test(o.data.substr(n.startOffset)))return!1;if(i.nodeType===e.TEXT_NODE&&!/^\s*$/.test(i.data.substr(n.endOffset)))return!1;for(;o&&o!==r;){if(o.nodeType!==e.TEXT_NODE&&!e.dom.contains(r,o))return!1;if(e.dom.domNode(o).prev({ignoreBlankTexts:!0}))return!1;o=o.parentNode}for(;i&&i!==r;){if(i.nodeType!==e.TEXT_NODE&&!e.dom.contains(r,i))return!1;if(e.dom.domNode(i).next({ignoreBlankTexts:!0}))return!1;i=i.parentNode}return e.lang.array(t).contains(r.nodeName)?r:!1},isInThisEditable:function(){var t=this.getSelection(),n=t.focusNode,r=t.anchorNode;return n&&1!==n.nodeType&&(n=n.parentNode),r&&1!==r.nodeType&&(r=r.parentNode),r&&n&&(e.dom.contains(this.composer.element,n)||this.composer.element===n)&&(e.dom.contains(this.composer.element,r)||this.composer.element===r)},deselect:function(){var e=this.getSelection();e&&e.removeAllRanges()}})}(r),function(e,t){function n(e,t,n){if(!e.className)return!1;var r=e.className.match(n)||[];return r[r.length-1]===t}function r(e,t){if(!e.getAttribute||!e.getAttribute("style"))return!1;e.getAttribute("style").match(t);return e.getAttribute("style").match(t)?!0:!1}function o(e,t,n){e.getAttribute("style")?(a(e,n),e.getAttribute("style")&&!/^\s*$/.test(e.getAttribute("style"))?e.setAttribute("style",t+";"+e.getAttribute("style")):e.setAttribute("style",t)):e.setAttribute("style",t)}function i(e,t,n){e.className?(s(e,n),e.className+=" "+t):e.className=t}function s(e,t){e.className&&(e.className=e.className.replace(t,""))}function a(e,t){var n,r=[];if(e.getAttribute("style")){n=e.getAttribute("style").split(";");for(var o=n.length;o--;)n[o].match(t)||/^\s*$/.test(n[o])||r.push(n[o]);r.length?e.setAttribute("style",r.join(";")):e.removeAttribute("style")}}function l(e,t){var n=[],r=t.split(";"),o=e.getAttribute("style");if(o){o=o.replace(/\s/gi,"").toLowerCase(),n.push(new RegExp("(^|\\s|;)"+t.replace(/\s/gi,"").replace(/([\(\)])/gi,"\\$1").toLowerCase().replace(";",";?").replace(/rgb\\\((\d+),(\d+),(\d+)\\\)/gi,"\\s?rgb\\($1,\\s?$2,\\s?$3\\)"),"gi"));for(var i=r.length;i-->0;)/^\s*$/.test(r[i])||n.push(new RegExp("(^|\\s|;)"+r[i].replace(/\s/gi,"").replace(/([\(\)])/gi,"\\$1").toLowerCase().replace(";",";?").replace(/rgb\\\((\d+),(\d+),(\d+)\\\)/gi,"\\s?rgb\\($1,\\s?$2,\\s?$3\\)"),"gi"));for(var s=0,a=n.length;a>s;s++)if(o.match(n[s]))return n[s]}return!1}function c(n,r,o,i){return o?l(n,o):i?e.dom.hasClass(n,i):t.dom.arrayContains(r,n.tagName.toLowerCase())}function d(e,t,n,r){for(var o=e.length;o--;)if(!c(e[o],t,n,r))return!1;return e.length?!0:!1}function u(e,t,n){var r=l(e,t);return r?(a(e,r),"remove"):(o(e,t,n),"change")}function f(e,t){return e.className.replace(C," ")==t.className.replace(C," ")}function h(e){for(var t=e.parentNode;e.firstChild;)t.insertBefore(e.firstChild,e);t.removeChild(e)}function m(e,t){if(e.attributes.length!=t.attributes.length)return!1;for(var n,r,o,i=0,s=e.attributes.length;s>i;++i)if(n=e.attributes[i],o=n.name,"class"!=o){if(r=t.attributes.getNamedItem(o),n.specified!=r.specified)return!1;if(n.specified&&n.nodeValue!==r.nodeValue)return!1}return!0}function p(e,n){return t.dom.isCharacterDataNode(e)?0==n?!!e.previousSibling:n==e.length?!!e.nextSibling:!0:n>0&&n<e.childNodes.length}function g(e,n,r,o){var i;if(t.dom.isCharacterDataNode(n)&&(0==r?(r=t.dom.getNodeIndex(n),n=n.parentNode):r==n.length?(r=t.dom.getNodeIndex(n)+1,n=n.parentNode):i=t.dom.splitDataNode(n,r)),!(i||o&&n===o)){i=n.cloneNode(!1),i.id&&i.removeAttribute("id");for(var s;s=n.childNodes[r];)i.appendChild(s);t.dom.insertAfter(i,n)}return n==e?i:g(e,i.parentNode,t.dom.getNodeIndex(i),o)}function v(t){this.isElementMerge=t.nodeType==e.ELEMENT_NODE,this.firstTextNode=this.isElementMerge?t.lastChild:t,this.textNodes=[this.firstTextNode]}function y(e,t,n,r,o,i,s){this.tagNames=e||[b],this.cssClass=t||(t===!1?!1:""),this.similarClassRegExp=n,this.cssStyle=o||"",this.similarStyleRegExp=i,this.normalize=r,this.applyToAnyTagName=!1,this.container=s}var b="span",C=/\s+/g;v.prototype={doMerge:function(){for(var e,t,n,r=[],o=0,i=this.textNodes.length;i>o;++o)e=this.textNodes[o],t=e.parentNode,r[o]=e.data,o&&(t.removeChild(e),t.hasChildNodes()||t.parentNode.removeChild(t));return this.firstTextNode.data=n=r.join(""),n},getLength:function(){for(var e=this.textNodes.length,t=0;e--;)t+=this.textNodes[e].length;return t},toString:function(){for(var e=[],t=0,n=this.textNodes.length;n>t;++t)e[t]="'"+this.textNodes[t].data+"'";return"[Merge("+e.join(",")+")]"}},y.prototype={getAncestorWithClass:function(r){for(var o;r;){if(o=this.cssClass?n(r,this.cssClass,this.similarClassRegExp):""!==this.cssStyle?!1:!0,r.nodeType==e.ELEMENT_NODE&&"false"!=r.getAttribute("contenteditable")&&t.dom.arrayContains(this.tagNames,r.tagName.toLowerCase())&&o)return r;r=r.parentNode}return!1},getAncestorWithStyle:function(n){for(var o;n;){if(o=this.cssStyle?r(n,this.similarStyleRegExp):!1,n.nodeType==e.ELEMENT_NODE&&"false"!=n.getAttribute("contenteditable")&&t.dom.arrayContains(this.tagNames,n.tagName.toLowerCase())&&o)return n;n=n.parentNode}return!1},getMatchingAncestor:function(e){var t=this.getAncestorWithClass(e),n=!1;return t?this.cssStyle&&(n="class"):(t=this.getAncestorWithStyle(e),t&&(n="style")),{element:t,type:n}},postApply:function(e,t){for(var n,r,o,i=e[0],s=e[e.length-1],a=[],l=i,c=s,d=0,u=s.length,f=0,h=e.length;h>f;++f)r=e[f],o=null,r&&r.parentNode&&(o=this.getAdjacentMergeableTextNode(r.parentNode,!1)),o?(n||(n=new v(o),a.push(n)),n.textNodes.push(r),r===i&&(l=n.firstTextNode,d=l.length),r===s&&(c=n.firstTextNode,u=n.getLength())):n=null;if(s&&s.parentNode){var m=this.getAdjacentMergeableTextNode(s.parentNode,!0);m&&(n||(n=new v(s),a.push(n)),n.textNodes.push(m))}if(a.length){for(f=0,h=a.length;h>f;++f)a[f].doMerge();t.setStart(l,d),t.setEnd(c,u)}},getAdjacentMergeableTextNode:function(t,n){var r,o=t.nodeType==e.TEXT_NODE,i=o?t.parentNode:t,s=n?"nextSibling":"previousSibling";if(o){if(r=t[s],r&&r.nodeType==e.TEXT_NODE)return r}else if(r=i[s],r&&this.areElementsMergeable(t,r))return r[n?"firstChild":"lastChild"];return null},areElementsMergeable:function(e,n){return t.dom.arrayContains(this.tagNames,(e.tagName||"").toLowerCase())&&t.dom.arrayContains(this.tagNames,(n.tagName||"").toLowerCase())&&f(e,n)&&m(e,n)},createContainer:function(e){var t=e.createElement(this.tagNames[0]);return this.cssClass&&(t.className=this.cssClass),this.cssStyle&&t.setAttribute("style",this.cssStyle),t},applyToTextNode:function(e){var n=e.parentNode;if(1==n.childNodes.length&&t.dom.arrayContains(this.tagNames,n.tagName.toLowerCase()))this.cssClass&&i(n,this.cssClass,this.similarClassRegExp),this.cssStyle&&o(n,this.cssStyle,this.similarStyleRegExp);else{var r=this.createContainer(t.dom.getDocument(e));e.parentNode.insertBefore(r,e),r.appendChild(e)}},isRemovable:function(n){return t.dom.arrayContains(this.tagNames,n.tagName.toLowerCase())&&""===e.lang.string(n.className).trim()&&(!n.getAttribute("style")||""===e.lang.string(n.getAttribute("style")).trim())},undoToTextNode:function(e,t,n,r){var o=n?!1:!0,i=n||r,a=!1;if(!t.containsNode(i)){var l=t.cloneRange();l.selectNode(i),l.isPointInRange(t.endContainer,t.endOffset)&&p(t.endContainer,t.endOffset)&&(g(i,t.endContainer,t.endOffset,this.container),t.setEndAfter(i)),l.isPointInRange(t.startContainer,t.startOffset)&&p(t.startContainer,t.startOffset)&&(i=g(i,t.startContainer,t.startOffset,this.container))}!o&&this.similarClassRegExp&&s(i,this.similarClassRegExp),o&&this.similarStyleRegExp&&(a="change"===u(i,this.cssStyle,this.similarStyleRegExp)),this.isRemovable(i)&&!a&&h(i)},applyToRange:function(t){for(var n,r=t.length;r--;){if(n=t[r].getNodes([e.TEXT_NODE]),!n.length)try{var o=this.createContainer(t[r].endContainer.ownerDocument);return t[r].surroundContents(o),void this.selectNode(t[r],o)}catch(i){}if(t[r].splitBoundaries(),n=t[r].getNodes([e.TEXT_NODE]),n.length){for(var s,a=0,l=n.length;l>a;++a)s=n[a],this.getMatchingAncestor(s).element||this.applyToTextNode(s);t[r].setStart(n[0],0),s=n[n.length-1],t[r].setEnd(s,s.length),this.normalize&&this.postApply(n,t[r])}}},undoToRange:function(t){for(var n,r,o,i=t.length;i--;){if(n=t[i].getNodes([e.TEXT_NODE]),n.length)t[i].splitBoundaries(),n=t[i].getNodes([e.TEXT_NODE]);else{var s=t[i].endContainer.ownerDocument,a=s.createTextNode(e.INVISIBLE_SPACE);t[i].insertNode(a),t[i].selectNode(a),n=[a]}for(var l=0,c=n.length;c>l;++l)t[i].isValid()&&(r=n[l],o=this.getMatchingAncestor(r),"style"===o.type?this.undoToTextNode(r,t[i],!1,o.element):o.element&&this.undoToTextNode(r,t[i],o.element));1==c?this.selectNode(t[i],n[0]):(t[i].setStart(n[0],0),r=n[n.length-1],t[i].setEnd(r,r.length),this.normalize&&this.postApply(n,t[i]))}},selectNode:function(t,n){var r=n.nodeType===e.ELEMENT_NODE,o="canHaveHTML"in n?n.canHaveHTML:!0,i=r?n.innerHTML:n.data,s=""===i||i===e.INVISIBLE_SPACE;if(s&&r&&o)try{n.innerHTML=e.INVISIBLE_SPACE}catch(a){}t.selectNodeContents(n),s&&r?t.collapse(!1):s&&(t.setStartAfter(n),t.setEndAfter(n))},getTextSelectedByRange:function(e,t){var n=t.cloneRange();n.selectNodeContents(e);var r=n.intersection(t),o=r?r.toString():"";return n.detach(),o},isAppliedToRange:function(t){for(var n,r,o=[],i="full",s=t.length;s--;){if(r=t[s].getNodes([e.TEXT_NODE]),!r.length)return n=this.getMatchingAncestor(t[s].startContainer).element,n?{elements:[n],coverage:i}:!1;for(var a,l=0,c=r.length;c>l;++l)a=this.getTextSelectedByRange(r[l],t[s]),n=this.getMatchingAncestor(r[l]).element,n&&""!=a?(o.push(n),1===e.dom.getTextNodes(n,!0).length?i="full":"full"===i&&(i="inline")):n||(i="partial")}return o.length?{elements:o,coverage:i}:!1},toggleRange:function(e){var t,n=this.isAppliedToRange(e);n?"full"===n.coverage?this.undoToRange(e):"inline"===n.coverage?(t=d(n.elements,this.tagNames,this.cssStyle,this.cssClass),this.undoToRange(e),t||this.applyToRange(e)):(d(n.elements,this.tagNames,this.cssStyle,this.cssClass)||this.undoToRange(e),this.applyToRange(e)):this.applyToRange(e)}},e.selection.HTMLApplier=y}(r,rangy),r.Commands=o.extend({constructor:function(e){this.editor=e,this.composer=e.composer,this.doc=this.composer.doc},support:function(e){return r.browser.supportsCommand(this.doc,e)},exec:function(e,t){var n=r.commands[e],o=r.lang.array(arguments).get(),i=n&&n.exec,s=null;if(this.composer.hasPlaceholderSet()&&!r.lang.array(["styleWithCSS","enableObjectResizing","enableInlineTableEditing"]).contains(e)&&(this.composer.element.innerHTML="",this.composer.selection.selectNode(this.composer.element)),this.editor.fire("beforecommand:composer"),i)o.unshift(this.composer),s=i.apply(n,o);else try{s=this.doc.execCommand(e,!1,t)}catch(a){}return this.editor.fire("aftercommand:composer"),s},remove:function(e){var t=r.commands[e],n=r.lang.array(arguments).get(),o=t&&t.remove;return o?(n.unshift(this.composer),o.apply(t,n)):void 0},state:function(e){var t=r.commands[e],n=r.lang.array(arguments).get(),o=t&&t.state;if(o)return n.unshift(this.composer),o.apply(t,n);try{return this.doc.queryCommandState(e)}catch(i){return!1}},stateValue:function(e){var t=r.commands[e],n=r.lang.array(arguments).get(),o=t&&t.stateValue;return o?(n.unshift(this.composer),o.apply(t,n)):!1}}),function(e){var t={nodeName:"B",toggle:!0};e.commands.bold={exec:function(n,r){e.commands.formatInline.exec(n,r,t)},state:function(n,r){return e.commands.formatInline.state(n,r,t)}}}(r),function(e){function t(t){return e.lang.object({}).merge(n).merge({attribute:t}).get()}var n={nodeName:"A",toggle:!1};e.commands.createLink={exec:function(n,r,o){var i=t(o);if(n.selection.isCollapsed()&&!this.state(n,r)){var s=n.doc.createTextNode(i.attribute.href);n.selection.insertNode(s),n.selection.selectNode(s)}e.commands.formatInline.exec(n,r,i)},state:function(t,r){return e.commands.formatInline.state(t,r,n)}}}(r),function(e){var t={nodeName:"A"};e.commands.removeLink={exec:function(n,r){e.commands.formatInline.remove(n,r,t)},state:function(n,r){return e.commands.formatInline.state(n,r,t)}}}(r),function(e){var t=/wysiwyg-font-size-[0-9a-z\-]+/g;e.commands.fontSize={exec:function(n,r,o){e.commands.formatInline.exec(n,r,{className:"wysiwyg-font-size-"+o,classRegExp:t,toggle:!0})},state:function(t,n,r){return e.commands.formatInline.state(t,n,{className:"wysiwyg-font-size-"+r})}}}(r),function(e){e.commands.fontSizeStyle={exec:function(t,n,r){r=r.size||r,/^\s*$/.test(r)||e.commands.formatInline.exec(t,n,{styleProperty:"fontSize",styleValue:r,toggle:!1})},state:function(t,n,r){return e.commands.formatInline.state(t,n,{styleProperty:"fontSize",styleValue:r||void 0})},remove:function(t,n){return e.commands.formatInline.remove(t,n,{styleProperty:"fontSize"})},stateValue:function(t,n){var r,o=this.state(t,n);return o&&e.lang.object(o).isArray()&&(o=o[0]),o&&(r=o.getAttribute("style"))?e.quirks.styleParser.parseFontSize(r):!1}}}(r),function(e){var t=/wysiwyg-color-[0-9a-z]+/g;e.commands.foreColor={exec:function(n,r,o){e.commands.formatInline.exec(n,r,{className:"wysiwyg-color-"+o,classRegExp:t,toggle:!0})},state:function(t,n,r){return e.commands.formatInline.state(t,n,{className:"wysiwyg-color-"+r})}}}(r),function(e){e.commands.foreColorStyle={exec:function(t,n,r){var o,i;r&&(o=e.quirks.styleParser.parseColor("color:"+(r.color||r),"color"),o&&(i=(1===o[3]?"rgb("+[o[0],o[1],o[2]].join(", "):"rgba("+o.join(", "))+")",e.commands.formatInline.exec(t,n,{styleProperty:"color",styleValue:i})))},state:function(t,n,r){var o,i=r?e.quirks.styleParser.parseColor("color:"+(r.color||r),"color"):null;return i&&(o=(1===i[3]?"rgb("+[i[0],i[1],i[2]].join(", "):"rgba("+i.join(", "))+")"),e.commands.formatInline.state(t,n,{styleProperty:"color",styleValue:o})},remove:function(t,n){return e.commands.formatInline.remove(t,n,{styleProperty:"color"})},stateValue:function(t,n,r){var o,i=this.state(t,n),s=!1;return i&&e.lang.object(i).isArray()&&(i=i[0]),i&&(o=i.getAttribute("style"))?(s=e.quirks.styleParser.parseColor(o,"color"),e.quirks.styleParser.unparseColor(s,r)):!1}}}(r),function(e){e.commands.bgColorStyle={exec:function(t,n,r){var o,i=e.quirks.styleParser.parseColor("background-color:"+(r.color||r),"background-color");i&&(o=(1===i[3]?"rgb("+[i[0],i[1],i[2]].join(", "):"rgba("+i.join(", "))+")",e.commands.formatInline.exec(t,n,{styleProperty:"backgroundColor",styleValue:o}))},state:function(t,n,r){var o,i=r?e.quirks.styleParser.parseColor("background-color:"+(r.color||r),"background-color"):null;return i&&(o=(1===i[3]?"rgb("+[i[0],i[1],i[2]].join(", "):"rgba("+i.join(", "))+")"),e.commands.formatInline.state(t,n,{styleProperty:"backgroundColor",styleValue:o})},remove:function(t,n){return e.commands.formatInline.remove(t,n,{styleProperty:"backgroundColor"})},stateValue:function(t,n,r){var o,i=this.state(t,n),s=!1;return i&&e.lang.object(i).isArray()&&(i=i[0]),i&&(o=i.getAttribute("style"))?(s=e.quirks.styleParser.parseColor(o,"background-color"),e.quirks.styleParser.unparseColor(s,r)):!1}}}(r),function(e){function t(e){return{nodeName:e.nodeName||null,className:e.classRegExp?null:e.className||null,classRegExp:e.classRegExp||null,styleProperty:e.styleProperty||null}}function n(t){for(var n=t.element,r=n.querySelectorAll(m),o=n.querySelectorAll(t.config.classNames.uneditableContainer),i=e.lang.array(r).without(o),s=i.length;s--;)""===i[s].innerHTML.replace(/[\uFEFF]/g,"")&&i[s].parentNode.removeChild(i[s])}function r(e){return e.config.useLineBreaks?"DIV":"P"}function o(e,t,n){for(var r=e,o=null;r&&t&&r!==t;)1===r.nodeType&&r.matches(n?m:h)&&(o=r),r=r.parentNode;return o}function i(e,t){for(var n,r,o,i=e,s=null;i&&t&&i!==t;)1===i.nodeType&&i.matches(p)&&(r=i,null===s?(s=i.cloneNode(!1),n=s):(o=i.cloneNode(!1),o.appendChild(s),s=o)),i=i.parentNode;return{parent:r,outerNode:s,innerNode:n}}function s(t,n,o){return t||(t=o.doc.createElement(n.nodeName||r(o)),t.appendChild(o.doc.createTextNode(e.INVISIBLE_SPACE))),n.nodeName&&t.nodeName!==n.nodeName&&(t=f.renameElement(t,n.nodeName)),n.classRegExp&&(t.className=t.className.replace(n.classRegExp,"")),n.className&&t.classList.add(n.className),n.styleProperty&&"undefined"!=typeof n.styleValue&&(t.style[e.browser.fixStyleKey(n.styleProperty)]=n.styleValue),t}function a(t,n,o){var i;n.styleProperty&&(t.style[e.browser.fixStyleKey(n.styleProperty)]=""),n.className&&t.classList.remove(n.className),n.classRegExp&&(t.className=t.className.replace(n.classRegExp,"")),null!==t.getAttribute("class")&&""===t.getAttribute("class").trim()&&t.removeAttribute("class"),n.nodeName&&t.nodeName===n.nodeName&&(i=t.getAttribute("style"),i&&""!==i.trim()?t=f.renameElement(t,r(o)):f.unwrap(t)),null!==t.getAttribute("style")&&""===t.getAttribute("style").trim()&&t.removeAttribute("style")}function l(t){for(var n=t.querySelectorAll(m)||[],r=n.length;r--;)n[r].nextSibling&&1===n[r].nextSibling.nodeType&&"BR"===n[r].nextSibling.nodeName||""!==(n[r].innerHTML||n[r].nodeValue||"").trim()&&n[r].parentNode.insertBefore(n[r].ownerDocument.createElement("BR"),n[r].nextSibling),e.dom.unwrap(n[r])}function c(e,t){var n;return e.startContainer&&1===e.startContainer.nodeType&&e.startContainer===e.endContainer?void(e.startContainer.firstChild===e.startContainer.lastChild&&1===e.endOffset&&e.startContainer!==t.element&&(e.setStartBefore(e.startContainer),e.setEndAfter(e.endContainer))):e.startContainer&&1===e.startContainer.nodeType&&3===e.endContainer.nodeType?void(e.startContainer.firstChild===e.endContainer&&1===e.endOffset&&e.startContainer!==t.element&&e.setEndAfter(e.startContainer)):e.endContainer&&1===e.endContainer.nodeType&&3===e.startContainer.nodeType?void(e.endContainer.firstChild===e.startContainer&&1===e.endOffset&&e.endContainer!==t.element&&e.setStartBefore(e.endContainer)):e.startContainer&&3===e.startContainer.nodeType&&e.startContainer===e.endContainer&&e.startContainer.parentNode?void(e.startContainer.parentNode.firstChild===e.startContainer&&e.endOffset==e.endContainer.length&&0===e.startOffset&&(n=e.startContainer.parentNode,n!==t.element&&(e.setStartBefore(n),e.setEndAfter(n)))):void 0}function d(n,a,d,u){var f=a?e.lang.object(a).clone(!0):null;f&&(f.nodeName=f.nodeName||d||r(u)),c(n,u);var p,g,v,y=n.cloneRange(),b=y.startContainer,C=y.extractContents(),N=u.doc.createDocumentFragment(),w=f?t(f):null,E=w?e.dom.getParentElement(b,w,null,u.element):null,x=!f||"BLOCKQUOTE"===d&&f.nodeName&&"BLOCKQUOTE"===f.nodeName,S=E||o(b,u.element,x);if(a&&a.nodeName&&"BLOCKQUOTE"===a.nodeName){var T=s(null,a,u);T.appendChild(C),N.appendChild(T),g=[T]}else{if(C.firstChild)for(;C.firstChild;)if(1==C.firstChild.nodeType&&C.firstChild.matches(m))if(a)s(C.firstChild,a,u),C.firstChild.matches(h)&&l(C.firstChild),N.appendChild(C.firstChild);else{l(C.firstChild),v=e.dom.unwrap(C.firstChild);for(var R=0,A=v.length;A>R;R++)N.appendChild(v[R]);N.childNodes.length>0&&N.appendChild(u.doc.createElement("BR"))}else if(a){for(p=s(null,f,u);C.firstChild&&(1!==C.firstChild.nodeType||!C.firstChild.matches(m));)1==C.firstChild.nodeType&&p.matches(h)&&l(C.firstChild),p.appendChild(C.firstChild);N.appendChild(p)}else 1==C.firstChild.nodeType&&l(C.firstChild),N.appendChild(C.firstChild);else N.appendChild(s(null,a,u));g=e.lang.array(N.childNodes).get()}if(S)u.selection.splitElementAtCaret(S,N);else{var _=i(b,u.element);if(_.outerNode&&_.innerNode&&_.parent){if(1===N.childNodes.length){for(;N.firstChild.firstChild;)_.innerNode.appendChild(N.firstChild.firstChild);N.firstChild.appendChild(_.outerNode)}u.selection.splitElementAtCaret(_.parent,N)}else y.insertNode(N)}return g}function u(t,n){var r=e.dom.getParentElement(t,{query:m},null,n.element);return r?r.nodeName:null}var f=e.dom,h="h1, h2, h3, h4, h5, h6, p, pre",m="h1, h2, h3, h4, h5, h6, p, pre, div, blockquote",p="b, big, i, small, tt, abbr, acronym, cite, code, dfn, em, kbd, strong, samp, var, a, bdo, br, q, span, sub, sup, button, label, textarea, input, select, u";e.commands.formatBlock={exec:function(t,r,o){var i,s,l,c,f,m=[];if("string"==typeof o&&(o={nodeName:o.toUpperCase()}),o&&o.toggle&&(f=this.state(t,r,o))){c=rangy.saveSelection(t.win);for(var p=0,g=f.length;g>p;p++)a(f[p],o,t)}if(!f){t.selection.isCollapsed()&&(l=e.dom.getParentElement(t.selection.getOwnRanges()[0].startContainer,{query:h+", "+(o&&o.nodeName?o.nodeName.toLowerCase():"div")},null,t.element),l?(c=rangy.saveSelection(t.win),s=t.selection.createRange(),s.selectNode(l),t.selection.setSelection(s)):t.isEmpty()||(c=rangy.saveSelection(t.win),t.selection.selectLine())),i=t.selection.getOwnRanges();for(var v=i.length;v--;)m=m.concat(d(i[v],o,u(i[v].startContainer,t),t))}n(t);for(var y=m.length;y--;)m[y].parentNode||m.splice(y,1);c?rangy.restoreSelection(c):(s=t.selection.createRange(),s.setStartBefore(m[0]),s.setEndAfter(m[m.length-1]),t.selection.setSelection(s)),e.dom.removeInvisibleSpaces(t.element)},state:function(t,n,r){"string"==typeof r&&(r={query:r});for(var o,i=t.selection.filterElements(function(t){return e.dom.domNode(t).test(r||{query:m})}.bind(this)),s=t.selection.getSelectedOwnNodes(),a=0,l=s.length;l>a;a++)o=f.getParentElement(s[a],r||{query:m},null,t.element),o&&-1===i.indexOf(o)&&i.push(o);return 0===i.length?!1:i}}}(r),function(e){e.commands.formatCode={exec:function(t,n,r){var o,i,s,a=this.state(t)[0];a?t.selection.executeAndRestore(function(){o=a.querySelector("code"),e.dom.replaceWithChildNodes(a),o&&e.dom.replaceWithChildNodes(o)}):(i=t.selection.getRange(),s=i.extractContents(),a=t.doc.createElement("pre"),o=t.doc.createElement("code"),r&&(o.className=r),a.appendChild(o),o.appendChild(s),i.insertNode(a),t.selection.selectNode(a))},state:function(t){var n,r=t.selection.getSelectedNode();return r&&r.nodeName&&"PRE"==r.nodeName&&r.firstChild&&r.firstChild.nodeName&&"CODE"==r.firstChild.nodeName?[r]:(n=e.dom.getParentElement(r,{query:"pre code"}),n?[n.parentNode]:!1)}}}(r),function(e){function t(e){return/^\s*$/.test(e.className)}function n(e){return!e.getAttribute("style")||/^\s*$/.test(e.getAttribute("style"))}function r(t){var n=e.dom.getAttributes(t);return e.lang.object(n).isEmpty()}function o(t,n){var r,o,i,s;return 1!==t.nodeType||1!==n.nodeType?!1:t.nodeName!==n.nodeName?!1:(r=t.className.trim().replace(/\s+/g," ").split(" "),o=n.className.trim().replace(/\s+/g," ").split(" "),e.lang.array(r).without(o).length>0?!1:(i=e.dom.getAttributes(t),s=e.dom.getAttributes(n),i.length===s.length&&e.lang.object(e.lang.object(i).difference(s)).isEmpty()?!0:!1))}function i(t,n){var r=n&&n.nodeName||L,o=t.ownerDocument.createElement(r);if(n.classRegExp&&(o.className=o.className.replace(n.classRegExp,"")),n.className&&o.classList.add(n.className),n.styleProperty&&"undefined"!=typeof n.styleValue&&(o.style[e.browser.fixStyleKey(n.styleProperty)]=n.styleValue),n.attribute)if("object"==typeof n.attribute)for(var i in n.attribute)n.attribute.hasOwnProperty(i)&&o.setAttribute(i,n.attribute[i]);else"undefined"!=typeof n.attributeValue&&o.setAttribute(n.attribute,n.attributeValue);return o}function s(e,t){for(var n in e)if(e.hasOwnProperty(n)&&(void 0===typeof t[n]||t[n]!==e[n]))return!1;return!0}function a(t,n,r){{var o,i=e.dom.getAttributes(t),a=s(n,i);e.lang.object(i).difference(n)}if(a&&r!==!1)for(o in n)n.hasOwnProperty(o)&&t.removeAttribute(o);else for(o in n)n.hasOwnProperty(o)&&t.setAttribute(o,n[o])}function l(o,i){var s,l,c;i.className&&(i.toggle!==!1&&o.classList.contains(i.className)?o.classList.remove(i.className):o.classList.add(i.className),t(o)&&o.removeAttribute("class")),i.styleProperty&&(o.style[e.browser.fixStyleKey(i.styleProperty)]=i.toggle!==!1&&o.style[e.browser.fixStyleKey(i.styleProperty)].trim().replace(/, /g,",")===i.styleValue?"":i.styleValue),n(o)&&o.removeAttribute("style"),i.attribute&&("object"==typeof i.attribute?s=i.attribute:(s={},s[i.attribute]=i.attributeValue||""),a(o,s,i.toggle)),l=i.nodeName?P[i.nodeName.toLowerCase()]||i.nodeName.toLowerCase():null,c=l?e.dom.domNode(o).test({query:l}):!1,(!i.nodeName||i.nodeName===L||c)&&(i.toggle!==!1&&c||!i.nodeName&&o.nodeName===L)&&t(o)&&n(o)&&r(o)&&e.dom.unwrap(o)}function c(t,n){var r=[];return t.isCollapsed()||(r=r.concat(t.getOwnNodes([3],function(t){return!e.dom.domNode(t).is.emptyTextNode()},n))),r}function d(e,t,n,r){var o=e,i=r?t:u(t);do{if(1===o.nodeType&&f(o,i))return o;o=o.parentNode}while(o&&o!==n);return null}function u(e){return{nodeName:e.nodeName||null,className:e.classRegExp?null:e.className||null,classRegExp:e.classRegExp||null,styleProperty:e.styleProperty||null}}function f(t,n){var r;if(n.nodeName){var o=P[n.nodeName.toLowerCase()]||n.nodeName.toLowerCase();return e.dom.domNode(t).test({query:o})}return r=e.lang.object(n).clone(),r.query=I,e.dom.domNode(t).test(r)}function h(t,n){{var r=document.documentElement||document.body,o=r.scrollTop,i=r.scrollLeft;rangy.getSelection(t.win)}rangy.getSelection(t.win).removeAllRanges();try{rangy.getSelection(t.win).addRange(n)}catch(s){}t.doc.activeElement&&e.dom.contains(t.element,t.doc.activeElement)||(t.element.focus(),r.scrollTop=o,r.scrollLeft=i,rangy.getSelection(t.win).addRange(n))}function m(e,t){var n=rangy.createRange(t.doc),r=e[e.length-1];e[0]&&r&&(n.setStart(e[0],0),n.setEnd(r,r.length),h(t,n))}function p(e,t,n,r){var o=rangy.createRange(e.doc);t&&(o.setStart(t,n),o.setEnd(t,"undefined"!=typeof r?r:n),h(e,o))}function g(e,t,n){var r,o,i,s=c(e.selection),a=[],l=!1;if(e.selection.isInThisEditable()){if(0===s.length&&e.selection.isCollapsed()){if(i=e.selection.getSelection().anchorNode,!i)return{nodes:[],partial:!1};3===i.nodeType&&(s=[i])}s.length||(o=e.selection.getOwnRanges()[0],o&&(s=[o.endContainer]));for(var u=0,f=s.length;f>u;u++)r=d(s[u],t,e.element,n),r?a.push(r):l=!0}return{nodes:a,partial:l}}function v(e){var t,n,r,o;return e&&(t=e.anchorNode,n=e.anchorOffset,t&&3===t.nodeType&&n>0&&n<t.data.length)?(r=t.data[n-1],o=t.data[n],/\w/.test(r)&&/\w/.test(o)):!1}function y(t){var n,r,o,i,s,a,l=[];if(t&&(n=t.anchorNode,r=s=a=t.anchorOffset,o=n.ownerDocument,i=rangy.createRange(o),n&&3===n.nodeType)){for(;s>0&&/\w/.test(n.data[s-1]);)s--;for(;a<n.data.length&&/\w/.test(n.data[a]);)a++;return i.setStartAndEnd(n,s,a),i.splitBoundaries(),l=i.getNodes([3],function(t){return!e.dom.domNode(t).is.emptyTextNode()}),{wordOffset:r-s,range:i,textNode:l[0]}}return!1}function b(e,t){for(;t.firstChild;)e.appendChild(t.firstChild);t.parentNode.removeChild(t)}function C(e){for(var t=e.length;t--;)e[t]&&e[t].parentNode&&(e[t].nextSibling&&o(e[t],e[t].nextSibling)&&b(e[t],e[t].nextSibling),e[t].previousSibling&&o(e[t],e[t].previousSibling)&&b(e[t].previousSibling,e[t]))}function N(e,t,n){t.length>0&&m(t,e),C(g(e,n).nodes),t.length>0&&m(t,e)}function w(e,t,n,r){p(e,t,n),C(g(e,r).nodes),p(e,t,n)}function E(e,t){var n=i(e,t);e.parentNode.insertBefore(n,e),n.appendChild(e)}function x(t,n,r){var o,i=n.element,s=d(t,r,i);s&&(o=s.cloneNode(!1),e.dom.domNode(t).escapeParent(s,o),l(o,r))}function S(t,n,r){var o=n.element,i=d(t,r,o);i&&e.dom.domNode(t).escapeParent(i)}function T(e,t,n){var r=i(e.endContainer,n);e.surroundContents(r),t.selection.selectNode(r)}function R(t,n,r,o){var i,s,a,c,u=g(t,o,!0),f=t.selection.getSelection();if(n.length){if(u.partial||o.toggle===!1)for(c=n.length;c--;)d(n[c],o,t.element)&&x(n[c],t,o),d(n[c],o,t.element)||E(n[c],o);else for(c=n.length;c--;)x(n[c],t,o);N(t,n,o)}else if(o.toggle!==!1)if(v(f))i=y(f),s=i.textNode,x(i.textNode,t,o),w(t,i.textNode,i.wordOffset,o);else{s=t.doc.createTextNode(e.INVISIBLE_SPACE),a=r.nodes[0].cloneNode(!1),a.appendChild(s),t.selection.splitElementAtCaret(r.nodes[0],a),l(a,o),N(t,[s],o);var h=t.selection.getSelection();if(h.anchorNode&&h.focusNode)try{h.collapseToEnd()}catch(m){}}else for(c=r.nodes.length;c--;)l(r.nodes[c],o)}function A(t,n,r,o){var i,s,a,l=t.selection.getSelection();if(n.length){for(a=n.length;a--;)S(n[a],t,o);N(t,n,o)}else{for(i=l.anchorNode,s=l.anchorOffset,a=r.nodes.length;a--;)e.dom.unwrap(r.nodes[a]);w(t,i,s,o)}}function _(e,t,n){var r,o,i=e.selection.getSelection();if(t.length){for(o=t.length;o--;)E(t[o],n);N(e,t,n)}else if(v(i))r=y(i),E(r.textNode,n),w(e,r.textNode,r.wordOffset,n);else{var s=e.selection.getOwnRanges()[0];s&&T(s,e,n)}}function O(e){return e="string"==typeof e?{nodeName:e}:e,e.nodeName&&(e.nodeName=e.nodeName.toUpperCase()),e}var L="SPAN",I="b, big, i, small, tt, abbr, acronym, cite, code, dfn, em, kbd, strong, samp, var, a, bdo, br, q, span, sub, sup, button, label, textarea, input, select, u",P={b:"b, strong",strong:"b, strong",em:"em, i",i:"em, i"};e.commands.formatInline={exec:function(e,t,n){n=O(n),e.element.normalize();var r=c(e.selection,!0),o=g(e,n);o.nodes.length>0?R(e,r,o,n):_(e,r,n),e.element.normalize()},remove:function(e,t,n){n=O(n),e.element.normalize();var r=c(e.selection,!0),o=g(e,n);o.nodes.length>0&&A(e,r,o,n),e.element.normalize()},state:function(e,t,n){n=O(n);var r=g(e,n,!0).nodes;return 0===r.length?!1:r}}}(r),function(e){var t={nodeName:"BLOCKQUOTE",toggle:!0};e.commands.insertBlockQuote={exec:function(n){return e.commands.formatBlock.exec(n,"formatBlock",t)},state:function(n){return e.commands.formatBlock.state(n,"formatBlock",t)}}}(r),function(e){e.commands.insertHTML={exec:function(e,t,n){e.commands.support(t)?e.doc.execCommand(t,!1,n):e.selection.insertHTML(n)},state:function(){return!1}}}(r),function(e){var t="IMG";e.commands.insertImage={exec:function(n,r,o){o="object"==typeof o?o:{src:o};var i,s,a=n.doc,l=this.state(n);if(l&&!o.src)return n.selection.setBefore(l),s=l.parentNode,s.removeChild(l),e.dom.removeEmptyTextNodes(s),"A"!==s.nodeName||s.firstChild||(n.selection.setAfter(s),s.parentNode.removeChild(s)),void e.quirks.redraw(n.element);
if(l)for(var c in o)o.hasOwnProperty(c)&&l.setAttribute("className"===c?"class":c,o[c]);else{l=a.createElement(t);for(var d in o)l.setAttribute("className"===d?"class":d,o[d]);n.selection.insertNode(l),e.browser.hasProblemsSettingCaretAfterImg()?(i=a.createTextNode(e.INVISIBLE_SPACE),n.selection.insertNode(i),n.selection.setAfter(i)):n.selection.setAfter(l)}},state:function(n){var r,o,i,s=n.doc;return e.dom.hasElementWithTagName(s,t)&&(r=n.selection.getSelectedNode())?r.nodeName===t?r:r.nodeType!==e.ELEMENT_NODE?!1:(o=n.selection.getText(),(o=e.lang.string(o).trim())?!1:(i=n.selection.getNodes(e.ELEMENT_NODE,function(e){return"IMG"===e.nodeName}),1!==i.length?!1:i[0])):!1}}}(r),function(e){var t="<br>"+(e.browser.needsSpaceAfterLineBreak()?" ":"");e.commands.insertLineBreak={exec:function(n,r){n.commands.support(r)?(n.doc.execCommand(r,!1,null),e.browser.autoScrollsToCaret()||n.selection.scrollIntoView()):n.commands.exec("insertHTML",t)},state:function(){return!1}}}(r),function(e){e.commands.insertOrderedList={exec:function(t,n){e.commands.insertList.exec(t,n,"OL")},state:function(t,n){return e.commands.insertList.state(t,n,"OL")}}}(r),function(e){e.commands.insertUnorderedList={exec:function(t,n){e.commands.insertList.exec(t,n,"UL")},state:function(t,n){return e.commands.insertList.state(t,n,"UL")}}}(r),r.commands.insertList=function(e){var t=function(e,t){if(e&&e.nodeName){"string"==typeof t&&(t=[t]);for(var n=t.length;n--;)if(e.nodeName===t[n])return!0}return!1},n=function(n,r,o){var i={el:null,other:!1};if(n){var s=e.dom.getParentElement(n,{query:"li"},!1,o.element),a="UL"===r?"OL":"UL";t(n,r)?i.el=n:t(n,a)?i={el:n,other:!0}:s&&(t(s.parentNode,r)?i.el=s.parentNode:t(s.parentNode,a)&&(i={el:s.parentNode,other:!0}))}return i.el&&!o.element.contains(i.el)&&(i.el=null),i},r=function(t,n,r){var o,s,a="UL"===n?"OL":"UL";r.selection.executeAndRestoreRangy(function(){if(o=i(a,r),o.length)for(var l=o.length;l--;)e.dom.renameElement(o[l],n.toLowerCase());else{s=i(["OL","UL"],r);for(var c=s.length;c--;)e.dom.resolveList(s[c],r.config.useLineBreaks);e.dom.resolveList(t,r.config.useLineBreaks)}})},o=function(t,n,r){var o="UL"===n?"OL":"UL";r.selection.executeAndRestoreRangy(function(){for(var s=[t].concat(i(o,r)),a=s.length;a--;)e.dom.renameElement(s[a],n.toLowerCase())})},i=function(e,n){for(var r=n.selection.getOwnRanges(),o=[],i=r.length;i--;)o=o.concat(r[i].getNodes([1],function(n){return t(n,e)}));return o},s=function(t,n){n.selection.executeAndRestoreRangy(function(){var r,o,i="_wysihtml5-temp-"+(new Date).getTime(),s=n.selection.deblockAndSurround({nodeName:"div",className:i});s.innerHTML=s.innerHTML.replace(e.INVISIBLE_SPACE_REG_EXP,""),s&&(r=e.lang.array(["","<br>",e.INVISIBLE_SPACE]).contains(s.innerHTML),o=e.dom.convertToList(s,t.toLowerCase(),n.parent.config.classNames.uneditableContainer),r&&n.selection.selectNode(o.querySelector("li"),!0))})};return{exec:function(e,t,i){var a=e.doc,l="OL"===i?"insertOrderedList":"insertUnorderedList",c=e.selection.getSelectedNode(),d=n(c,i,e);d.el?d.other?o(d.el,i,e):r(d.el,i,e):e.commands.support(l)?a.execCommand(l,!1,null):s(i,e)},state:function(e,t,r){var o=e.selection.getSelectedNode(),i=n(o,r,e);return i.el&&!i.other?i.el:!1}}}(r),function(e){var t={nodeName:"I",toggle:!0};e.commands.italic={exec:function(n,r){e.commands.formatInline.exec(n,r,t)},state:function(n,r){return e.commands.formatInline.state(n,r,t)}}}(r),function(e){var t={className:"wysiwyg-text-align-center",classRegExp:/wysiwyg-text-align-[0-9a-z]+/g,toggle:!0};e.commands.justifyCenter={exec:function(n){return e.commands.formatBlock.exec(n,"formatBlock",t)},state:function(n){return e.commands.formatBlock.state(n,"formatBlock",t)}}}(r),function(e){var t={className:"wysiwyg-text-align-left",classRegExp:/wysiwyg-text-align-[0-9a-z]+/g,toggle:!0};e.commands.justifyLeft={exec:function(n){return e.commands.formatBlock.exec(n,"formatBlock",t)},state:function(n){return e.commands.formatBlock.state(n,"formatBlock",t)}}}(r),function(e){var t={className:"wysiwyg-text-align-right",classRegExp:/wysiwyg-text-align-[0-9a-z]+/g,toggle:!0};e.commands.justifyRight={exec:function(n){return e.commands.formatBlock.exec(n,"formatBlock",t)},state:function(n){return e.commands.formatBlock.state(n,"formatBlock",t)}}}(r),function(e){var t={className:"wysiwyg-text-align-justify",classRegExp:/wysiwyg-text-align-[0-9a-z]+/g,toggle:!0};e.commands.justifyFull={exec:function(n){return e.commands.formatBlock.exec(n,"formatBlock",t)},state:function(n){return e.commands.formatBlock.state(n,"formatBlock",t)}}}(r),function(e){var t={styleProperty:"textAlign",styleValue:"right",toggle:!0};e.commands.alignRightStyle={exec:function(n){return e.commands.formatBlock.exec(n,"formatBlock",t)},state:function(n){return e.commands.formatBlock.state(n,"formatBlock",t)}}}(r),function(e){var t={styleProperty:"textAlign",styleValue:"left",toggle:!0};e.commands.alignLeftStyle={exec:function(n){return e.commands.formatBlock.exec(n,"formatBlock",t)},state:function(n){return e.commands.formatBlock.state(n,"formatBlock",t)}}}(r),function(e){var t={styleProperty:"textAlign",styleValue:"center",toggle:!0};e.commands.alignCenterStyle={exec:function(n){return e.commands.formatBlock.exec(n,"formatBlock",t)},state:function(n){return e.commands.formatBlock.state(n,"formatBlock",t)}}}(r),function(e){e.commands.redo={exec:function(e){return e.undoManager.redo()},state:function(){return!1}}}(r),function(e){var t={nodeName:"U",toggle:!0};e.commands.underline={exec:function(n,r){e.commands.formatInline.exec(n,r,t)},state:function(n,r){return e.commands.formatInline.state(n,r,t)}}}(r),function(e){e.commands.undo={exec:function(e){return e.undoManager.undo()},state:function(){return!1}}}(r),function(e){e.commands.createTable={exec:function(e,t,n){var r,o,i;if(n&&n.cols&&n.rows&&parseInt(n.cols,10)>0&&parseInt(n.rows,10)>0){for(i=n.tableStyle?'<table style="'+n.tableStyle+'">':"<table>",i+="<tbody>",o=0;o<n.rows;o++){for(i+="<tr>",r=0;r<n.cols;r++)i+="<td><br></td>";i+="</tr>"}i+="</tbody></table>",e.commands.exec("insertHTML",i)}},state:function(){return!1}}}(r),function(e){e.commands.mergeTableCells={exec:function(t,n){t.tableSelection&&t.tableSelection.start&&t.tableSelection.end&&(this.state(t,n)?e.dom.table.unmergeCell(t.tableSelection.start):e.dom.table.mergeCellsBetween(t.tableSelection.start,t.tableSelection.end))},state:function(t){if(t.tableSelection){var n=t.tableSelection.start,r=t.tableSelection.end;if(n&&r&&n==r&&(e.dom.getAttribute(n,"colspan")&&parseInt(e.dom.getAttribute(n,"colspan"),10)>1||e.dom.getAttribute(n,"rowspan")&&parseInt(e.dom.getAttribute(n,"rowspan"),10)>1))return[n]}return!1}}}(r),function(e){e.commands.addTableCells={exec:function(t,n,r){if(t.tableSelection&&t.tableSelection.start&&t.tableSelection.end){var o=e.dom.table.orderSelectionEnds(t.tableSelection.start,t.tableSelection.end);"before"==r||"above"==r?e.dom.table.addCells(o.start,r):("after"==r||"below"==r)&&e.dom.table.addCells(o.end,r),setTimeout(function(){t.tableSelection.select(o.start,o.end)},0)}},state:function(){return!1}}}(r),function(e){e.commands.deleteTableCells={exec:function(t,n,r){if(t.tableSelection&&t.tableSelection.start&&t.tableSelection.end){var o,i=e.dom.table.orderSelectionEnds(t.tableSelection.start,t.tableSelection.end),s=e.dom.table.indexOf(i.start),a=t.tableSelection.table;e.dom.table.removeCells(i.start,r),setTimeout(function(){o=e.dom.table.findCell(a,s),o||("row"==r&&(o=e.dom.table.findCell(a,{row:s.row-1,col:s.col})),"column"==r&&(o=e.dom.table.findCell(a,{row:s.row,col:s.col-1}))),o&&t.tableSelection.select(o,o)},0)}},state:function(){return!1}}}(r),function(e){e.commands.indentList={exec:function(e){var t=e.selection.getSelectionParentsByTag("LI");return t?this.tryToPushLiLevel(t,e.selection):!1},state:function(){return!1},tryToPushLiLevel:function(t,n){var r,o,i,s,a,l=!1;return n.executeAndRestoreRangy(function(){for(var n=t.length;n--;)s=t[n],r="OL"===s.parentNode.nodeName?"OL":"UL",o=s.ownerDocument.createElement(r),i=e.dom.domNode(s).prev({nodeTypes:[e.ELEMENT_NODE]}),a=i?i.querySelector("ul, ol"):null,i&&(a?a.appendChild(s):(o.appendChild(s),i.appendChild(o)),l=!0)}),l}}}(r),function(e){e.commands.outdentList={exec:function(e){var t=e.selection.getSelectionParentsByTag("LI");return t?this.tryToPullLiLevel(t,e):!1},state:function(){return!1},tryToPullLiLevel:function(t,n){var r,o,i,s,a,l=!1,c=this;return n.selection.executeAndRestoreRangy(function(){for(var d=t.length;d--;)if(s=t[d],s.parentNode&&(r=s.parentNode,"OL"===r.tagName||"UL"===r.tagName)){if(l=!0,o=e.dom.getParentElement(r.parentNode,{query:"ol, ul"},!1,n.element),i=e.dom.getParentElement(r.parentNode,{query:"li"},!1,n.element),o&&i)s.nextSibling&&(a=c.getAfterList(r,s),s.appendChild(a)),o.insertBefore(s,i.nextSibling);else{s.nextSibling&&(a=c.getAfterList(r,s),s.appendChild(a));for(var u=s.childNodes.length;u--;)r.parentNode.insertBefore(s.childNodes[u],r.nextSibling);r.parentNode.insertBefore(document.createElement("br"),r.nextSibling),s.parentNode.removeChild(s)}0===r.childNodes.length&&r.parentNode.removeChild(r)}}),l},getAfterList:function(e,t){for(var n=e.nodeName,r=document.createElement(n);t.nextSibling;)r.appendChild(t.nextSibling);return r}}}(r),function(e){var t={nodeName:"SUB",toggle:!0};e.commands.subscript={exec:function(n,r){e.commands.formatInline.exec(n,r,t)},state:function(n,r){return e.commands.formatInline.state(n,r,t)}}}(r),function(e){var t={nodeName:"SUP",toggle:!0};e.commands.superscript={exec:function(n,r){e.commands.formatInline.exec(n,r,t)},state:function(n,r){return e.commands.formatInline.state(n,r,t)}}}(r),function(e){var t=90,n=89,r=8,o=46,i=25,s="data-wysihtml5-selection-node",a="data-wysihtml5-selection-offset",l=('<span id="_wysihtml5-undo" class="_wysihtml5-temp">'+e.INVISIBLE_SPACE+"</span>",'<span id="_wysihtml5-redo" class="_wysihtml5-temp">'+e.INVISIBLE_SPACE+"</span>",e.dom);e.UndoManager=e.lang.Dispatcher.extend({constructor:function(e){this.editor=e,this.composer=e.composer,this.element=this.composer.element,this.position=0,this.historyStr=[],this.historyDom=[],this.transact(),this._observe()},_observe:function(){{var e,i=this;this.composer.sandbox.getDocument()}l.observe(this.element,"keydown",function(e){if(!e.altKey&&(e.ctrlKey||e.metaKey)){var r=e.keyCode,o=r===t&&!e.shiftKey,s=r===t&&e.shiftKey||r===n;o?(i.undo(),e.preventDefault()):s&&(i.redo(),e.preventDefault())}}),l.observe(this.element,"keydown",function(t){var n=t.keyCode;n!==e&&(e=n,(n===r||n===o)&&i.transact())}),this.editor.on("newword:composer",function(){i.transact()}).on("beforecommand:composer",function(){i.transact()})},transact:function(){var t,n,r,o,l,c=this.historyStr[this.position-1],d=this.composer.getValue(!1,!1),u=this.element.offsetWidth>0&&this.element.offsetHeight>0;if(d!==c){var f=this.historyStr.length=this.historyDom.length=this.position;f>i&&(this.historyStr.shift(),this.historyDom.shift(),this.position--),this.position++,u&&(t=this.composer.selection.getRange(),n=t&&t.startContainer?t.startContainer:this.element,r=t&&t.startOffset?t.startOffset:0,n.nodeType===e.ELEMENT_NODE?o=n:(o=n.parentNode,l=this.getChildNodeIndex(o,n)),o.setAttribute(a,r),"undefined"!=typeof l&&o.setAttribute(s,l));var h=this.element.cloneNode(!!d);this.historyDom.push(h),this.historyStr.push(d),o&&(o.removeAttribute(a),o.removeAttribute(s))}},undo:function(){this.transact(),this.undoPossible()&&(this.set(this.historyDom[--this.position-1]),this.editor.fire("undo:composer"))},redo:function(){this.redoPossible()&&(this.set(this.historyDom[++this.position-1]),this.editor.fire("redo:composer"))},undoPossible:function(){return this.position>1},redoPossible:function(){return this.position<this.historyStr.length},set:function(e){this.element.innerHTML="";for(var t=0,n=e.childNodes,r=e.childNodes.length;r>t;t++)this.element.appendChild(n[t].cloneNode(!0));var o,i,l;e.hasAttribute(a)?(o=e.getAttribute(a),l=e.getAttribute(s),i=this.element):(i=this.element.querySelector("["+a+"]")||this.element,o=i.getAttribute(a),l=i.getAttribute(s),i.removeAttribute(a),i.removeAttribute(s)),null!==l&&(i=this.getChildNodeByIndex(i,+l)),this.composer.selection.set(i,o)},getChildNodeIndex:function(e,t){for(var n=0,r=e.childNodes,o=r.length;o>n;n++)if(r[n]===t)return n},getChildNodeByIndex:function(e,t){return e.childNodes[t]}})}(r),r.views.View=o.extend({constructor:function(e,t,n){this.parent=e,this.element=t,this.config=n,this.config.noTextarea||this._observeViewChange()},_observeViewChange:function(){var e=this;this.parent.on("beforeload",function(){e.parent.on("change_view",function(t){t===e.name?(e.parent.currentView=e,e.show(),setTimeout(function(){e.focus()},0)):e.hide()})})},focus:function(){if(!this.element||!this.element.ownerDocument||this.element.ownerDocument.querySelector(":focus")!==this.element)try{this.element&&this.element.focus()}catch(e){}},hide:function(){this.element.style.display="none"},show:function(){this.element.style.display=""},disable:function(){this.element.setAttribute("disabled","disabled")},enable:function(){this.element.removeAttribute("disabled")}}),function(e){var t=e.dom,n=e.browser;e.views.Composer=e.views.View.extend({name:"composer",CARET_HACK:"<br>",constructor:function(e,t,n){this.base(e,t,n),this.config.noTextarea?this.editableArea=t:this.textarea=this.parent.textarea,this.config.contentEditableMode?this._initContentEditableArea():this._initSandbox()},clear:function(){this.element.innerHTML=n.displaysCaretInEmptyContentEditableCorrectly()?"":this.CARET_HACK},getValue:function(t,n){var r=this.isEmpty()?"":e.quirks.getCorrectInnerHTML(this.element);return t!==!1&&(r=this.parent.parse(r,n===!1?!1:!0)),r},setValue:function(e,t){t&&(e=this.parent.parse(e));try{this.element.innerHTML=e}catch(n){this.element.innerText=e}},cleanUp:function(){var e;this.selection&&(e=rangy.saveSelection(this.win)),this.parent.parse(this.element),e&&rangy.restoreSelection(e)},show:function(){this.editableArea.style.display=this._displayStyle||"",this.config.noTextarea||this.textarea.element.disabled||(this.disable(),this.enable())},hide:function(){this._displayStyle=t.getStyle("display").from(this.editableArea),"none"===this._displayStyle&&(this._displayStyle=null),this.editableArea.style.display="none"},disable:function(){this.parent.fire("disable:composer"),this.element.removeAttribute("contentEditable")},enable:function(){this.parent.fire("enable:composer"),this.element.setAttribute("contentEditable","true")},focus:function(t){e.browser.doesAsyncFocus()&&this.hasPlaceholderSet()&&this.clear(),this.base();var n=this.element.lastChild;t&&n&&this.selection&&("BR"===n.nodeName?this.selection.setBefore(this.element.lastChild):this.selection.setAfter(this.element.lastChild))},getScrollPos:function(){if(this.doc&&this.win){var e={};return e.y="undefined"!=typeof this.win.pageYOffset?this.win.pageYOffset:(this.doc.documentElement||this.doc.body.parentNode||this.doc.body).scrollTop,e.x="undefined"!=typeof this.win.pageXOffset?this.win.pageXOffset:(this.doc.documentElement||this.doc.body.parentNode||this.doc.body).scrollLeft,e}},setScrollPos:function(e){e&&"undefined"!=typeof e.x&&"undefined"!=typeof e.y&&this.win.scrollTo(e.x,e.y)},getTextContent:function(){return t.getTextContent(this.element)},hasPlaceholderSet:function(){return this.getTextContent()==(this.config.noTextarea?this.editableArea.getAttribute("data-placeholder"):this.textarea.element.getAttribute("placeholder"))&&this.placeholderSet},isEmpty:function(){var e=this.element.innerHTML.toLowerCase();return/^(\s|<br>|<\/br>|<p>|<\/p>)*$/i.test(e)||""===e||"<br>"===e||"<p></p>"===e||"<p><br></p>"===e||this.hasPlaceholderSet()},_initContentEditableArea:function(){var e=this;this.config.noTextarea?this.sandbox=new t.ContentEditableArea(function(){e._create()},{className:this.config.classNames.sandbox},this.editableArea):(this.sandbox=new t.ContentEditableArea(function(){e._create()},{className:this.config.classNames.sandbox}),this.editableArea=this.sandbox.getContentEditable(),t.insert(this.editableArea).after(this.textarea.element),this._createWysiwygFormField())},_initSandbox:function(){var e=this;this.sandbox=new t.Sandbox(function(){e._create()},{stylesheets:this.config.stylesheets,className:this.config.classNames.sandbox}),this.editableArea=this.sandbox.getIframe();var n=this.textarea.element;t.insert(this.editableArea).after(n),this._createWysiwygFormField()},_createWysiwygFormField:function(){if(this.textarea.element.form){var e=document.createElement("input");e.type="hidden",e.name="_wysihtml5_mode",e.value=1,t.insert(e).after(this.textarea.element)}},_create:function(){var r=this;this.doc=this.sandbox.getDocument(),this.win=this.sandbox.getWindow(),this.element=this.config.contentEditableMode?this.sandbox.getContentEditable():this.doc.body,this.config.noTextarea?this.cleanUp():(this.textarea=this.parent.textarea,this.element.innerHTML=this.textarea.getValue(!0,!1)),this.selection=new e.Selection(this.parent,this.element,this.config.classNames.uneditableContainer),this.commands=new e.Commands(this.parent),this.config.noTextarea||t.copyAttributes(["className","spellcheck","title","lang","dir","accessKey"]).from(this.textarea.element).to(this.element),t.addClass(this.element,this.config.classNames.composer),this.config.style&&!this.config.contentEditableMode&&this.style(),this.observe();var o=this.config.name;o&&(t.addClass(this.element,o),this.config.contentEditableMode||t.addClass(this.editableArea,o)),this.enable(),!this.config.noTextarea&&this.textarea.element.disabled&&this.disable();var i="string"==typeof this.config.placeholder?this.config.placeholder:this.config.noTextarea?this.editableArea.getAttribute("data-placeholder"):this.textarea.element.getAttribute("placeholder");i&&t.simulatePlaceholder(this.parent,this,i,this.config.classNames.placeholder),this.commands.exec("styleWithCSS",!1),this._initAutoLinking(),this._initObjectResizing(),this._initUndoManager(),this._initLineBreaking(),this.config.noTextarea||!this.textarea.element.hasAttribute("autofocus")&&document.querySelector(":focus")!=this.textarea.element||n.isIos()||setTimeout(function(){r.focus(!0)},100),n.clearsContentEditableCorrectly()||e.quirks.ensureProperClearing(this),this.initSync&&this.config.sync&&this.initSync(),this.config.noTextarea||this.textarea.hide(),this.parent.fire("beforeload").fire("load")},_initAutoLinking:function(){var r=this,o=n.canDisableAutoLinking(),i=n.doesAutoLinkingInContentEditable();if(o&&this.commands.exec("autoUrlDetect",!1),this.config.autoLink){(!i||i&&o)&&(this.parent.on("newword:composer",function(){if(t.getTextContent(r.element).match(t.autoLink.URL_REG_EXP)){for(var n=r.selection.getSelectedNode(),o=r.element.querySelectorAll("."+r.config.classNames.uneditableContainer),i=!1,s=o.length;s--;)e.dom.contains(o[s],n)&&(i=!0);i||t.autoLink(n,[r.config.classNames.uneditableContainer])}}),t.observe(this.element,"blur",function(){t.autoLink(r.element,[r.config.classNames.uneditableContainer])}));var s=this.sandbox.getDocument().getElementsByTagName("a"),a=t.autoLink.URL_REG_EXP,l=function(n){var r=e.lang.string(t.getTextContent(n)).trim();return"www."===r.substr(0,4)&&(r="http://"+r),r};t.observe(this.element,"keydown",function(e){if(s.length){var n,o=r.selection.getSelectedNode(e.target.ownerDocument),i=t.getParentElement(o,{query:"a"},4);i&&(n=l(i),setTimeout(function(){var e=l(i);e!==n&&e.match(a)&&i.setAttribute("href",e)},0))}})}},_initObjectResizing:function(){if(this.commands.exec("enableObjectResizing",!0),n.supportsEvent("resizeend")){var r=["width","height"],o=r.length,i=this.element;t.observe(i,"resizeend",function(t){var n,s=t.target||t.srcElement,a=s.style,l=0;if("IMG"===s.nodeName){for(;o>l;l++)n=r[l],a[n]&&(s.setAttribute(n,parseInt(a[n],10)),a[n]="");e.quirks.redraw(i)}})}},_initUndoManager:function(){this.undoManager=new e.UndoManager(this.parent)},_initLineBreaking:function(){function r(e){var n=t.getParentElement(e,{query:"p, div"},2);n&&t.contains(o.element,n)&&o.selection.executeAndRestore(function(){o.config.useLineBreaks?t.replaceWithChildNodes(n):"P"!==n.nodeName&&t.renameElement(n,"p")})}var o=this,i="li, p, h1, h2, h3, h4, h5, h6",s="ul, ol, menu";this.config.useLineBreaks||t.observe(this.element,["focus","keydown"],function(){if(o.isEmpty()){var e=o.doc.createElement("P");o.element.innerHTML="",o.element.appendChild(e),n.displaysCaretInEmptyContentEditableCorrectly()?o.selection.selectNode(e,!0):(e.innerHTML="<br>",o.selection.setBefore(e.firstChild))}}),t.observe(this.element,"keydown",function(n){var a=n.keyCode;if(!n.shiftKey&&(a===e.ENTER_KEY||a===e.BACKSPACE_KEY)){var l=t.getParentElement(o.selection.getSelectedNode(),{query:i},4);return l?void setTimeout(function(){var n,i=o.selection.getSelectedNode();if("LI"===l.nodeName){if(!i)return;n=t.getParentElement(i,{query:s},2),n||r(i)}a===e.ENTER_KEY&&l.nodeName.match(/^H[1-6]$/)&&r(i)},0):void(o.config.useLineBreaks&&a===e.ENTER_KEY&&!e.browser.insertsLineBreaksOnReturn()&&(n.preventDefault(),o.commands.exec("insertLineBreak")))}})}})}(r),function(e){var t=e.dom,n=document,r=window,o=n.createElement("div"),i=["background-color","color","cursor","font-family","font-size","font-style","font-variant","font-weight","line-height","letter-spacing","text-align","text-decoration","text-indent","text-rendering","word-break","word-wrap","word-spacing"],s=["background-color","border-collapse","border-bottom-color","border-bottom-style","border-bottom-width","border-left-color","border-left-style","border-left-width","border-right-color","border-right-style","border-right-width","border-top-color","border-top-style","border-top-width","clear","display","float","margin-bottom","margin-left","margin-right","margin-top","outline-color","outline-offset","outline-width","outline-style","padding-left","padding-right","padding-top","padding-bottom","position","top","left","right","bottom","z-index","vertical-align","text-align","-webkit-box-sizing","-moz-box-sizing","-ms-box-sizing","box-sizing","-webkit-box-shadow","-moz-box-shadow","-ms-box-shadow","box-shadow","-webkit-border-top-right-radius","-moz-border-radius-topright","border-top-right-radius","-webkit-border-bottom-right-radius","-moz-border-radius-bottomright","border-bottom-right-radius","-webkit-border-bottom-left-radius","-moz-border-radius-bottomleft","border-bottom-left-radius","-webkit-border-top-left-radius","-moz-border-radius-topleft","border-top-left-radius","width","height"],a=["html                 { height: 100%; }","body                 { height: 100%; padding: 1px 0 0 0; margin: -1px 0 0 0; }","body > p:first-child { margin-top: 0; }","._wysihtml5-temp     { display: none; }",e.browser.isGecko?"body.placeholder { color: graytext !important; }":"body.placeholder { color: #a9a9a9 !important; }","img:-moz-broken      { -moz-force-broken-image-icon: 1; height: 24px; width: 24px; }"],l=function(e){if(e.setActive)try{e.setActive()}catch(o){}else{var i=e.style,s=n.documentElement.scrollTop||n.body.scrollTop,a=n.documentElement.scrollLeft||n.body.scrollLeft,l={position:i.position,top:i.top,left:i.left,WebkitUserSelect:i.WebkitUserSelect};t.setStyles({position:"absolute",top:"-99999px",left:"-99999px",WebkitUserSelect:"none"}).on(e),e.focus(),t.setStyles(l).on(e),r.scrollTo&&r.scrollTo(a,s)}};e.views.Composer.prototype.style=function(){var r,c=this,d=n.querySelector(":focus"),u=this.textarea.element,f=u.hasAttribute("placeholder"),h=f&&u.getAttribute("placeholder"),m=u.style.display,p=u.disabled;this.focusStylesHost=o.cloneNode(!1),this.blurStylesHost=o.cloneNode(!1),this.disabledStylesHost=o.cloneNode(!1),f&&u.removeAttribute("placeholder"),u===d&&u.blur(),u.disabled=!1,u.style.display=r="none",(u.getAttribute("rows")&&"auto"===t.getStyle("height").from(u)||u.getAttribute("cols")&&"auto"===t.getStyle("width").from(u))&&(u.style.display=r=m),t.copyStyles(s).from(u).to(this.editableArea).andTo(this.blurStylesHost),t.copyStyles(i).from(u).to(this.element).andTo(this.blurStylesHost),t.insertCSS(a).into(this.element.ownerDocument),u.disabled=!0,t.copyStyles(s).from(u).to(this.disabledStylesHost),t.copyStyles(i).from(u).to(this.disabledStylesHost),u.disabled=p,u.style.display=m,l(u),u.style.display=r,t.copyStyles(s).from(u).to(this.focusStylesHost),t.copyStyles(i).from(u).to(this.focusStylesHost),u.style.display=m,t.copyStyles(["display"]).from(u).to(this.editableArea);var g=e.lang.array(s).without(["display"]);return d?d.focus():u.blur(),f&&u.setAttribute("placeholder",h),this.parent.on("focus:composer",function(){t.copyStyles(g).from(c.focusStylesHost).to(c.editableArea),t.copyStyles(i).from(c.focusStylesHost).to(c.element)}),this.parent.on("blur:composer",function(){t.copyStyles(g).from(c.blurStylesHost).to(c.editableArea),t.copyStyles(i).from(c.blurStylesHost).to(c.element)}),this.parent.observe("disable:composer",function(){t.copyStyles(g).from(c.disabledStylesHost).to(c.editableArea),t.copyStyles(i).from(c.disabledStylesHost).to(c.element)}),this.parent.observe("enable:composer",function(){t.copyStyles(g).from(c.blurStylesHost).to(c.editableArea),t.copyStyles(i).from(c.blurStylesHost).to(c.element)}),this}}(r),function(e){var t=e.dom,n=e.browser,r={66:"bold",73:"italic",85:"underline"},o=function(e,t,n){for(var r=0,o=t.length;o>r;r++)e.addEventListener(t[r],n,!1)},i=function(e,t,n){for(var r=0,o=t.length;o>r;r++)e.removeEventListener(t[r],n,!1)},s=function(t,n){if(t.selection.caretIsLastInSelection()){var r=t.selection.getSelection(),o=r.anchorNode;if(o&&1===o.nodeType&&(e.dom.getParentElement(o,{query:"td, th"},!1,t.element)||n)){var i=o.childNodes[r.anchorOffset];if(i&&1===i.nodeType&"BR"===i.nodeName)return i.parentNode.removeChild(i),!0}}return!1},a=function(e){var t=e.selection.getBeforeSelection(!0);if(t&&("element"===t.type||"leafnode"===t.type)&&1===t.node.nodeType&&t.node.classList.contains(e.config.classNames.uneditableContainer)){if(s(e,!0))return!0;try{var n=new CustomEvent("wysihtml5:uneditable:delete");t.node.dispatchEvent(n)}catch(r){}return t.node.parentNode.removeChild(t.node),!0}return!1},l=function(t){var n=t.selection,r=n.getPreviousNode();if(n.caretIsFirstInSelection()&&r&&1===r.nodeType&&/block/.test(t.win.getComputedStyle(r).display)){if(/^\s*$/.test(r.textContent||r.innerText))return r.parentNode.removeChild(r),!0;if(r.lastChild){var o=r.lastChild,i=n.getSelectedNode(),s=e.dom.domNode(r).commonAncestor(i,t.element);if(curNode=s?e.dom.getParentElement(i,{query:"h1, h2, h3, h4, h5, h6, p, pre, div, blockquote"},!1,s):null){for(;curNode.firstChild;)r.appendChild(curNode.firstChild);return n.setAfter(o),!0}if(3===i.nodeType)return r.appendChild(i),n.setAfter(o),!0}}return!1},c=function(e,t){{var n=t.selection;t.element}if(n.isCollapsed()){if(l(t))return void e.preventDefault();if(s(t))return void e.preventDefault();if(a(t))return void e.preventDefault()}else n.containsUneditable()&&(e.preventDefault(),n.deleteContents())},d=function(e,t,n){if(e.selection.isCollapsed()){if(e.selection.caretIsInTheBeginnig("li"))if(n){if(e.commands.exec("outdentList"))return}else if(e.commands.exec("indentList"))return}else e.selection.deleteContents();e.commands.exec("insertHTML","&emsp;")},u=function(){this.domNodeRemovedInterval&&clearInterval(domNodeRemovedInterval),this.parent.fire("destroy:composer")},f=function(e){this.parent.fire("beforeinteraction",e).fire("beforeinteraction:composer",e),setTimeout(function(){this.parent.fire("interaction",e).fire("interaction:composer",e)}.bind(this),0)},h=function(e){this.parent.fire("focus",e).fire("focus:composer",e),setTimeout(function(){this.focusState=this.getValue(!1,!1)}.bind(this),0)},m=function(e){if(this.focusState!==this.getValue(!1,!1)){var t=e;"function"==typeof Object.create&&(t=Object.create(e,{type:{value:"change"}})),this.parent.fire("change",t).fire("change:composer",t)}this.parent.fire("blur",e).fire("blur:composer",e)},p=function(e){this.parent.fire(e.type,e).fire(e.type+":composer",e),"paste"===e.type&&setTimeout(function(){this.parent.fire("newword:composer")}.bind(this),0)},g=function(e){this.config.copyedFromMarking&&(e.clipboardData&&(e.clipboardData.setData("text/html",this.config.copyedFromMarking+this.selection.getHtml()),e.clipboardData.setData("text/plain",this.selection.getPlainText()),e.preventDefault()),this.parent.fire(e.type,e).fire(e.type+":composer",e))},v=function(t){var n=t.keyCode;(n===e.SPACE_KEY||n===e.ENTER_KEY)&&this.parent.fire("newword:composer")},y=function(t){if(!n.canSelectImagesInContentEditable()){var r=t.target,o=this.element.querySelectorAll("img"),i=this.element.querySelectorAll("."+this.config.classNames.uneditableContainer+" img"),s=e.lang.array(o).without(i);"IMG"===r.nodeName&&e.lang.array(s).contains(r)&&this.selection.selectNode(r)}},b=function(e){var t,n={IMG:"Image: ",A:"Link: "},r=e.target,o=r.nodeName;("A"===o||"IMG"===o)&&(r.hasAttribute("title")||(t=n[o]+(r.getAttribute("href")||r.getAttribute("src")),r.setAttribute("title",t)))},C=function(t){if(this.config.classNames.uneditableContainer){var n=e.dom.getParentElement(t.target,{query:"."+this.config.classNames.uneditableContainer},!1,this.element);n&&this.selection.setAfter(n)}},N=function(){n.canSelectImagesInContentEditable()||setTimeout(function(){this.selection.getSelection().removeAllRanges()}.bind(this),0)},w=function(t){var n,o,i=t.keyCode,s=r[i];return(t.ctrlKey||t.metaKey)&&65===i?(this.selection.selectAll(),void t.preventDefault()):((t.ctrlKey||t.metaKey)&&!t.altKey&&s&&(this.commands.exec(s),t.preventDefault()),i===e.BACKSPACE_KEY&&c(t,this),(i===e.BACKSPACE_KEY||i===e.DELETE_KEY)&&(n=this.selection.getSelectedNode(!0),n&&"IMG"===n.nodeName&&(t.preventDefault(),o=n.parentNode,o.removeChild(n),"A"!==o.nodeName||o.firstChild||o.parentNode.removeChild(o),setTimeout(function(){e.quirks.redraw(this.element)}.bind(this),0))),void(this.config.handleTabKey&&i===e.TAB_KEY&&(t.preventDefault(),d(this,this.element,t.shiftKey))))},E=function(){var t=function(){this.doc.execCommand("enableObjectResizing",!1,"false"),this.doc.execCommand("enableInlineTableEditing",!1,"false")},n=function(){t.call(this),i(this.sandbox.getIframe(),["focus","mouseup","mouseover"],n)}.bind(this);this.doc.execCommand&&e.browser.supportsCommand(this.doc,"enableObjectResizing")&&e.browser.supportsCommand(this.doc,"enableInlineTableEditing")&&(this.sandbox.getIframe?o(this.sandbox.getIframe(),["focus","mouseup","mouseover"],n):setTimeout(function(){t.call(this)}.bind(this),0)),this.tableSelection=e.quirks.tableCellsSelection(this.element,this.parent)};e.views.Composer.prototype.observe=function(){var e=this.sandbox.getIframe?this.sandbox.getIframe():this.sandbox.getContentEditable(),r=(this.element,n.supportsEventsInIframeCorrectly()||this.sandbox.getContentEditable?this.element:this.sandbox.getWindow());this.focusState=this.getValue(!1,!1),e.addEventListener(["DOMNodeRemoved"],u.bind(this),!1),n.supportsMutationEvents()||(this.domNodeRemovedInterval=setInterval(function(){t.contains(document.documentElement,e)||u.call(this)},250)),this.config.handleTables&&E.call(this),o(r,["drop","paste","mouseup","focus","keyup"],f.bind(this)),r.addEventListener("focus",h.bind(this),!1),r.addEventListener("blur",m.bind(this),!1),o(this.element,["drop","paste","beforepaste"],p.bind(this),!1),this.element.addEventListener("copy",g.bind(this),!1),this.element.addEventListener("mousedown",y.bind(this),!1),this.element.addEventListener("mouseover",b.bind(this),!1),this.element.addEventListener("click",C.bind(this),!1),this.element.addEventListener("drop",N.bind(this),!1),this.element.addEventListener("keyup",v.bind(this),!1),this.element.addEventListener("keydown",w.bind(this),!1),this.element.addEventListener("dragenter",function(){this.parent.fire("unset_placeholder")}.bind(this),!1)}}(r),function(e){var t=400;e.views.Synchronizer=o.extend({constructor:function(e,t,n){this.editor=e,this.textarea=t,this.composer=n,this._observe()},fromComposerToTextarea:function(t){this.textarea.setValue(e.lang.string(this.composer.getValue(!1,!1)).trim(),t)
},fromTextareaToComposer:function(e){var t=this.textarea.getValue(!1,!1);t?this.composer.setValue(t,e):(this.composer.clear(),this.editor.fire("set_placeholder"))},sync:function(e){"textarea"===this.editor.currentView.name?this.fromTextareaToComposer(e):this.fromComposerToTextarea(e)},_observe:function(){var n,r=this,o=this.textarea.element.form,i=function(){n=setInterval(function(){r.fromComposerToTextarea()},t)},s=function(){clearInterval(n),n=null};i(),o&&(e.dom.observe(o,"submit",function(){r.sync(!0)}),e.dom.observe(o,"reset",function(){setTimeout(function(){r.fromTextareaToComposer()},0)})),this.editor.on("change_view",function(e){"composer"!==e||n?"textarea"===e&&(r.fromComposerToTextarea(!0),s()):(r.fromTextareaToComposer(!0),i())}),this.editor.on("destroy:composer",s)}})}(r),function(e){e.views.SourceView=o.extend({constructor:function(e,t){this.editor=e,this.composer=t,this._observe()},switchToTextarea:function(e){var t=this.composer.win.getComputedStyle(this.composer.element),n=parseFloat(t.width),r=Math.max(parseFloat(t.height),100);this.textarea||(this.textarea=this.composer.doc.createElement("textarea"),this.textarea.className="wysihtml5-source-view"),this.textarea.style.width=n+"px",this.textarea.style.height=r+"px",this.textarea.value=this.editor.getValue(e,!0),this.composer.element.parentNode.insertBefore(this.textarea,this.composer.element),this.editor.currentView="source",this.composer.element.style.display="none"},switchToComposer:function(e){var t=this.textarea.value;t?this.composer.setValue(t,e):(this.composer.clear(),this.editor.fire("set_placeholder")),this.textarea.parentNode.removeChild(this.textarea),this.editor.currentView=this.composer,this.composer.element.style.display=""},_observe:function(){this.editor.on("change_view",function(e){"composer"===e?this.switchToComposer(!0):"textarea"===e&&this.switchToTextarea(!0)}.bind(this))}})}(r),r.views.Textarea=r.views.View.extend({name:"textarea",constructor:function(e,t,n){this.base(e,t,n),this._observe()},clear:function(){this.element.value=""},getValue:function(e){var t=this.isEmpty()?"":this.element.value;return e!==!1&&(t=this.parent.parse(t)),t},setValue:function(e,t){t&&(e=this.parent.parse(e)),this.element.value=e},cleanUp:function(){var e=this.parent.parse(this.element.value);this.element.value=e},hasPlaceholderSet:function(){var e=r.browser.supportsPlaceholderAttributeOn(this.element),t=this.element.getAttribute("placeholder")||null,n=this.element.value,o=!n;return e&&o||n===t},isEmpty:function(){return!r.lang.string(this.element.value).trim()||this.hasPlaceholderSet()},_observe:function(){var e=this.element,t=this.parent,n={focusin:"focus",focusout:"blur"},o=r.browser.supportsEvent("focusin")?["focusin","focusout","change"]:["focus","blur","change"];t.on("beforeload",function(){r.dom.observe(e,o,function(e){var r=n[e.type]||e.type;t.fire(r).fire(r+":textarea")}),r.dom.observe(e,["paste","drop"],function(){setTimeout(function(){t.fire("paste").fire("paste:textarea")},0)})})}}),function(e){var t,n={name:t,style:!0,toolbar:t,showToolbarAfterInit:!0,showToolbarDialogsOnSelection:!0,autoLink:!0,handleTables:!0,handleTabKey:!0,parserRules:{tags:{br:{},span:{},div:{},p:{}},classes:{}},pasteParserRulesets:null,parser:e.dom.parse,useLineBreaks:!0,stylesheets:[],placeholderText:t,supportTouchDevices:!0,cleanUp:!0,contentEditableMode:!1,classNames:{composer:"wysihtml5-editor",body:"wysihtml5-supported",sandbox:"wysihtml5-sandbox",placeholder:"wysihtml5-placeholder",uneditableContainer:"wysihtml5-uneditable-container"},copyedFromMarking:'<meta name="copied-from" content="wysihtml5">'};e.Editor=e.lang.Dispatcher.extend({constructor:function(t,r){if(this.editableElement="string"==typeof t?document.getElementById(t):t,this.config=e.lang.object({}).merge(n).merge(r).get(),this._isCompatible=e.browser.supported(),r&&r.classNames&&e.lang.object(this.config.classNames).merge(r.classNames),"textarea"!=this.editableElement.nodeName.toLowerCase()&&(this.config.contentEditableMode=!0,this.config.noTextarea=!0),this.config.noTextarea||(this.textarea=new e.views.Textarea(this,this.editableElement,this.config),this.currentView=this.textarea),!this._isCompatible||!this.config.supportTouchDevices&&e.browser.isTouchDevice()){var o=this;return void setTimeout(function(){o.fire("beforeload").fire("load")},0)}e.dom.addClass(document.body,this.config.classNames.body),this.composer=new e.views.Composer(this,this.editableElement,this.config),this.currentView=this.composer,"function"==typeof this.config.parser&&this._initParser(),this.on("beforeload",this.handleBeforeLoad)},handleBeforeLoad:function(){this.config.noTextarea?this.sourceView=new e.views.SourceView(this,this.composer):this.synchronizer=new e.views.Synchronizer(this,this.textarea,this.composer),this.config.toolbar&&(this.toolbar=new e.toolbar.Toolbar(this,this.config.toolbar,this.config.showToolbarAfterInit))},isCompatible:function(){return this._isCompatible},clear:function(){return this.currentView.clear(),this},getValue:function(e,t){return this.currentView.getValue(e,t)},setValue:function(e,t){return this.fire("unset_placeholder"),e?(this.currentView.setValue(e,t),this):this.clear()},cleanUp:function(){this.currentView.cleanUp()},focus:function(e){return this.currentView.focus(e),this},disable:function(){return this.currentView.disable(),this},enable:function(){return this.currentView.enable(),this},isEmpty:function(){return this.currentView.isEmpty()},hasPlaceholderSet:function(){return this.currentView.hasPlaceholderSet()},parse:function(t,n){var r=this.config.contentEditableMode?document:this.composer?this.composer.sandbox.getDocument():null,o=this.config.parser(t,{rules:this.config.parserRules,cleanUp:this.config.cleanUp,context:r,uneditableClass:this.config.classNames.uneditableContainer,clearInternals:n});return"object"==typeof t&&e.quirks.redraw(t),o},_initParser:function(){var t;e.browser.supportsModernPaste()?this.on("paste:composer",function(n){n.preventDefault(),t=e.dom.getPastedHtml(n),t&&this._cleanAndPaste(t)}.bind(this)):this.on("beforepaste:composer",function(t){t.preventDefault();var n=this.composer.getScrollPos();e.dom.getPastedHtmlWithDiv(this.composer,function(e){e&&this._cleanAndPaste(e),this.composer.setScrollPos(n)}.bind(this))}.bind(this))},_cleanAndPaste:function(t){var n=e.quirks.cleanPastedHTML(t,{referenceNode:this.composer.element,rules:this.config.pasteParserRulesets||[{set:this.config.parserRules}],uneditableClass:this.config.classNames.uneditableContainer});this.composer.selection.deleteContents(),this.composer.selection.insertHTML(n)}})}(r),n.exports=r});