define("fishstrap/util/upload.js",function(e,n,t){var i=e("fishstrap/core/global.js"),o=e("fishstrap/core/html5.js"),a=e("fishstrap/util/imageCompresser.js"),r=e("fishstrap/util/jpegMeta.js").JpegMeta,s=e("fishstrap/module/jweixin.js");t.exports={_checkFileSize:function(e,n,t){function i(e){e>n.maxSize?n.onFail(n.maxSize<1024?"上传文件必须少于"+n.maxSize+"Byte":n.maxSize<1048576?"上传文件必须少于"+n.maxSize/1024+"KB":"上传文件必须少于"+n.maxSize/1024/1024+"MB"):t()}if(e.files)i(e.files[0].size?e.files[0].size:e.files[0].fileSize);else if(n._fileName.match(/.jpg|.jpeg|.gif|.png|.bmp/i)){var o=new Image;o.onerror=function(){n.onFail("图像格式不正确")};var a=0,r=setInterval(function(){a++,o.fileSize>0?(i(o.fileSize),clearInterval(r)):10==a&&(clearInterval(r),t())},100);o.src=n._fileAddress}else t()},_checkCanUpload:function(e,n,t){if(i.os.android){var o=navigator.userAgent.match(/MQQBrowser\/([^\s]+)/);if((!o||o&&o[1]<"5.2")&&i.os.version.toString()<="2.1")return void n.onFail("您的安卓手机系统暂不支持上传功能，请下载最新版的QQ浏览器")}else if(i.os.ios&&i.os.version.toString()<"6.0")return void n.onFail("您的手机系统不支持传图，请升级到ios6.0以上");return i.os.wx&&i.os.wxVersion.toString()<"5.2"?void n.onFail("您当前的微信版本太低，不支持传图，请升级到最新版"):void t()},_checkFileSelect:function(e,n,t){if(e.files){if(0==e.files.length)return;n._fileName=e.files[0].name;var i=window.URL||window.webkitURL||!1;n._fileAddress=i?i.createObjectURL(e.files[0]):e.value}else{if(!e.value||null==e.value)return;n._fileName=e.value,n._fileAddress=e.value}t()},_checkFileType:function(e,n,t){if(n.type&&null!=n.type){var o=!1,a=n.type.split("|");for(var r in a){var s=i.trim(a[r]);if(""!=s){var s="."+s;if(n._fileName.substring(n._fileName.length-s.length).toLowerCase()==s.toLowerCase()){o=!0;break}}}if(!o)return void n.onFail("仅支持上传以下格式的文件："+n.type)}t()},_readImage:function(e,n,t){o.fileReader.open({file:e.files[0],mode:"binary",onSuccess:function(e){n._fieldata=e,t()},onFail:function(e){n.onFail(e)}})},_compressImage:function(e,n,t){var o={quality:n.quality,scale:0,orien:1};if(n.width&&null!=n.width&&(o.maxW=n.width),n.height&&null!=n.height&&(o.maxH=n.height),o.maxW&&o.maxH&&(o.scale=o.maxW/o.maxH),"image/jpeg"==e.files[0].type){try{var s=new r.JpegFile(n._fieldata,n._fileName)}catch(l){i.console.warn("读取jpeg的meta数据失败"+l)}s&&s.tiff&&s.tiff.Orientation&&(o=i.extend(o,{orien:s.tiff.Orientation.value}))}var c=new Image;c.onload=function(){if("image/jpeg"==e.files[0].type){var r;try{r=a.getImageBase64(this,{maxW:320,quality:.8,orien:o.orien})}catch(s){return n.onFail("压缩图片失败 "+s),!1}if(r.indexOf("data:image")<0)return n.onFail("上传照片格式不支持"),!1;var l;try{l=a.getImageBase64(this,o)}catch(s){return n.onFail("压缩图片失败 "+s),!1}if(l.indexOf("data:image")<0)return n.onFail("上传照片格式不支持"),!1;n.onOpen(r),n._uploadData=l.split(";base64,")[1]}else{var l=i.base64.encode(n._fieldata,!1);n.onOpen("data:"+e.files[0].type+";base64,"+l),n._uploadData=l}t()},c.onerror=function(){return n.onFail("读取图片数据失败"),!1},c.src=n._fileAddress},_startUploadProgres:function(e,n,t){n._progress=1,n._progressInterval=0,n.onProgress(n._progress),n._progressInterval=setInterval(function(){return n._progress+5>=100?(clearInterval(n._progressInterval),void(n._progressInterval=null)):(n._progress+=5,void n.onProgress(n._progress))},1e3),t()},_cloudImageUpload:function(e,n){var t=n._uploadData,o=function(e){e.lengthComputable&&(n._progress=Math.ceil(100*(e.loaded/e.total)),n.onProgress(n._progress))},a=function(e){var t=i.JSON.parse(e.target.response);if(0==_.isUndefined(t.error))return void n.onFail(t.error);var o={code:0,msg:"",data:"http://"+n.url+"/"+t.key};n.onSuccess(i.JSON.stringify(o))},r=function(){n.onFail("网络断开，请稍后重新操作")},s=function(){n.onFail("上传已取消")},l=new XMLHttpRequest;l.upload&&l.upload.addEventListener("progress",o,!1),l.open("POST","http://upload.qiniu.com/putb64/-1",!0),l.addEventListener("progress",o,!1),l.addEventListener("load",a,!1),l.addEventListener("abort",s,!1),l.addEventListener("error",r,!1),l.setRequestHeader("Authorization","UpToken "+n.urlToken),l.setRequestHeader("Content-Type","application/octet-stream"),l.send(t)},_localImageUpload:function(e,n){var t=new FormData;t.append("data",n._uploadData);var i=function(e){e.lengthComputable&&(n._progress=Math.ceil(100*(e.loaded/e.total)),n.onProgress(n._progress))},o=function(e){n.onSuccess(e.target.response)},a=function(){n.onFail("网络断开，请稍后重新操作")},r=function(){n.onFail("上传已取消")},s=new XMLHttpRequest;s.upload&&s.upload.addEventListener("progress",i,!1),s.open("POST",n.url+"?t="+Date.now(),!0),s.addEventListener("progress",i,!1),s.addEventListener("load",o,!1),s.addEventListener("abort",r,!1),s.addEventListener("error",a,!1),s.send(t)},_uploadImage:function(e,n){var t=this;"local"==n.urlType?t._localImageUpload(e,n):t._cloudImageUpload(e,n)},_iframeUpload:function(e,n,t){t._progress=1,t._progressInterval=0,t.onProgress(t._progress),t._progressInterval=setInterval(function(){return t._progress+5>=100?(clearInterval(t._progressInterval),void(t._progressInterval=null)):(t._progress+=5,void t.onProgress(t._progress))},1e3),i("#"+n).submit()},file:function(e){var n=this,t={url:"",target:"",field:"",type:null,maxSize:null,accept:null,iframe:null};t=i.extend(t,e);var o="",a=i.uniqueNum(),r=i.uniqueNum(),s=i.uniqueNum();t.accept&&(t.accept='accept="'+t.accept+'"'),window.FormData&&window.File||(t.iframe='<iframe name="'+r+'" id="'+r+'" style="display:none">'),o='<form id="'+a+'" action="'+t.url+'" target="'+r+'" method="post" enctype="multipart/form-data" style="opacity:0;filter:alpha(opacity=0);display:block;position:absolute;top:0px;bottom:0px;left:0px;right:0px;width:100%;height:100%;z-index:9;overflow:hidden;"><input type="file" id="'+s+'" style="width:100%;height:100%;font-size:1000px;" name="'+t.field+'"'+t.accept+"/>"+t.iframe+"</form>",o=i(o),i("#"+t.target).css("position","relative"),i("#"+t.target).append(o),t.iframe&&i("#"+r).load(function(){if(t._progress){var e;e=this.contentWindow?i(this.contentWindow.document.body).text():i(this.contentDocument.document.body).text(),clearInterval(t._progressInterval),t.onProgress(100),t.onSuccess(e)}}),o.find("input").on("change",function(){var e=this;n._checkCanUpload(e,t,function(){n._checkFileSelect(e,t,function(){n._checkFileType(e,t,function(){n._checkFileSize(e,t,function(){t.iframe?n._iframeUpload(r,a,t):(t._uploadData=e.files[0],n._localImageUpload(e,t))})})})})})},_cordovaImage:function(e){function n(n){window.imagePicker.getPictures(function(t){return 0==t.length?void e.onFail("请选择图片上传噢"):void n(t[0])},function(n){e.onFail(n)},{maximumImagesCount:1,width:e.width})}function t(n){var t=function(n){return 200!=n.responseCode?void e.onFail("上传图片到服务器失败，错误码为："+n.responseCode):void e.onSuccess(n.response)},i=function(n){e.onFail("上传图片到服务器失败 "+n.code)},o=new window.FileUploadOptions;o.fileKey="data",o.fileName=n.substr(n.lastIndexOf("/")+1),o.mimeType="text/plain";var a=new window.FileTransfer;a.onprogress=function(n){if(n.lengthComputable){var t=Math.ceil(100*(n.loaded/n.total));e.onProgress(t)}},a.upload(n,encodeURI(e.url),t,i,o)}function o(){e.onOpen(),n(function(e){t(e)})}i("#"+e.target).click(o)},_wxImage:function(e){function n(n){s.chooseImage({success:function(t){var i=t.localIds;0!=i.length&&(r=i[0],e.onOpen(r),e.onProgress(0),n())}})}function t(n){s.uploadImage({localId:r,isShowProgressTips:1,success:function(e){l=e.serverId,n()},fail:function(){e.onFail("上传图片到微信服务器失败")}})}function o(){var n=new FormData;n.append("data",l);var t=function(n){if(n.lengthComputable){var t=Math.ceil(100*(n.loaded/n.total));e.onProgress(t)}},i=function(n){e.onSuccess(n.target.response)},o=function(){e.onFail("下载微信图片断开，请稍后重新操作")},a=function(){e.onFail("上传已取消")},r=new XMLHttpRequest;r.upload&&r.upload.addEventListener("progress",t,!1),r.open("POST",e.url+"?t="+Date.now(),!0),r.addEventListener("progress",t,!1),r.addEventListener("load",i,!1),r.addEventListener("abort",a,!1),r.addEventListener("error",o,!1),r.send(n)}function a(){return i.os.wxVersion.toString()<"6.1"?void alert("您的微信版本过低，微信上传图功能将不能正常使用，请升级微信至6.1及以上"):void n(function(){t(function(){o()})})}var r=null,l=null;i("#"+e.target).click(a)},_crossImage:function(e){function n(n){i._ajax({url:"/crossapi/image/choose",data:{isShowCamera:!0,count:1},success:function(t){return t=i.JSON.parse(t),0!=t.code?void alert(t.msg):void(0!=t.data.length&&(e.onOpen(),e.onProgress(0),a=t.data[0],n()))},error:function(e,n){alert(n)}})}function t(){i._ajax({url:"/crossapi/image/upload",data:{url:e.url,image:a,field:"data",maxWidth:e.width,maxHeight:e.height},success:function(n){return n=i.JSON.parse(n),0!=n.code?void e.onFail(n.msg):(e.onProgress(100),void e.onSuccess(n.data))},error:function(n,t){e.onFail(t)}})}function o(){n(function(){t()})}var a=null;i("#"+e.target).click(o)},imageV3:function(e){var n={url:"",field:"",target:"",width:null,height:null,quality:.8,onOpen:function(){},onProgress:function(){},onSuccess:function(){},onFail:function(){}};return n=i.extend(n,e),i.os.wx?this._wxImage(n):i.os.crossapi?this._crossImage(n):i.os.crosswalk?(n.type="png|jpg|jpeg|gif|bmp",n.accept="image/*",n.maxSize=8388608,this.file(n)):this.image(n)},imageV2:function(e){var n=this,t={url:"",urlToken:"",urlType:"local",field:"",width:null,height:null,quality:.8,onOpen:function(){},onProgress:function(){},onSuccess:function(){},onFail:function(){}};t=i.extend(t,e),t.type="png|jpg|jpeg|gif|bmp",t.id=_.uniqueId("upload_"),t.onUpload=function(e){n._checkCanUpload(e,t,function(){n._checkFileSelect(e,t,function(){n._checkFileType(e,t,function(){n._readImage(e,t,function(){n._compressImage(e,t,function(){n._startUploadProgres(e,t,function(){n._uploadImage(e,t)})})})})})})};var o='<input id="'+t.id+'" type="file" name="'+t.field+'" style="opacity:0;display:block;position:absolute;top:0px;bottom:0px;left:0px;right:0px;width:100%;height:100%;" accept="image/*" onchange="'+i.func.invoke(t.onUpload)+'">';return{el:o}},image:function(e){var n,t=this;if(n=window.File&&window.FileList&&window.FileReader&&window.Blob?!0:!1,0==n)return e.type="png|jpg|jpeg|gif|bmp",e.accept="image/*",t.file(e);var o={url:"",urlToken:"",urlType:"local",target:"",field:"",width:null,height:null,quality:.8,onOpen:function(){},onProgress:function(){},onSuccess:function(){},onFail:function(){}};o=i.extend(o,e),o.type="png|jpg|jpeg|gif|bmp";var a="",r=i.uniqueNum();o.accept&&(o.type='accept="image/*"'),a='<input id="'+r+'" type="file" name="'+o.field+'" style="opacity:0;display:block;position:absolute;top:0px;bottom:0px;left:0px;right:0px;width:100%;height:100%;" accept="image/*">',a=i(a),i("#"+o.target).css("overflow","hidden"),i("#"+o.target).css("position","relative"),i("#"+o.target).append(a),a.on("change",function(){var e=this;t._checkCanUpload(e,o,function(){t._checkFileSelect(e,o,function(){t._checkFileType(e,o,function(){t._readImage(e,o,function(){t._compressImage(e,o,function(){t._uploadImage(e,o)})})})})})})}}});
;define("fishstrap/util/jpegEncoder.js",function(r,a,n){n.exports={JPEGEncoder:function(r){function a(r){for(var a=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],n=0;64>n;n++){var e=j((a[n]*r+50)/100);1>e?e=1:e>255&&(e=255),T[H[n]]=e}for(var o=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],t=0;64>t;t++){var f=j((o[t]*r+50)/100);1>f?f=1:f>255&&(f=255),C[H[t]]=f}for(var i=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],v=0,u=0;8>u;u++)for(var c=0;8>c;c++)M[v]=1/(T[H[v]]*i[u]*i[c]*8),b[v]=1/(C[H[v]]*i[u]*i[c]*8),v++}function n(r,a){for(var n=0,e=0,o=new Array,t=1;16>=t;t++){for(var f=1;f<=r[t];f++)o[a[e]]=[],o[a[e]][0]=n,o[a[e]][1]=t,e++,n++;n*=2}return o}function e(){p=n(K,L),l=n(R,U),D=n(O,Q),E=n(V,W)}function o(){for(var r=1,a=2,n=1;15>=n;n++){for(var e=r;a>e;e++)_[32767+e]=n,x[32767+e]=[],x[32767+e][1]=n,x[32767+e][0]=e;for(var o=-(a-1);-r>=o;o++)_[32767+o]=n,x[32767+o]=[],x[32767+o][1]=n,x[32767+o][0]=a-1+o;r<<=1,a<<=1}}function t(){for(var r=0;256>r;r++)z[r]=19595*r,z[r+256>>0]=38470*r,z[r+512>>0]=7471*r+32768,z[r+768>>0]=-11059*r,z[r+1024>>0]=-21709*r,z[r+1280>>0]=32768*r+8421375,z[r+1536>>0]=-27439*r,z[r+1792>>0]=-5329*r}function f(r){for(var a=r[0],n=r[1]-1;n>=0;)a&1<<n&&(J|=1<<N),n--,N--,0>N&&(255==J?(i(255),i(0)):i(J),N=7,J=0)}function i(r){G.push(q[r])}function v(r){i(r>>8&255),i(255&r)}function u(r,a){var n,e,o,t,f,i,v,u,c,w=0,h=8,g=64;for(c=0;h>c;++c){n=r[w],e=r[w+1],o=r[w+2],t=r[w+3],f=r[w+4],i=r[w+5],v=r[w+6],u=r[w+7];var d=n+u,y=n-u,m=e+v,A=e-v,s=o+i,p=o-i,l=t+f,D=t-f,E=d+l,I=d-l,j=m+s,T=m-s;r[w]=E+j,r[w+4]=E-j;var C=.707106781*(T+I);r[w+2]=I+C,r[w+6]=I-C,E=D+p,j=p+A,T=A+y;var M=.382683433*(E-T),b=.5411961*E+M,x=1.306562965*T+M,_=.707106781*j,F=y+_,G=y-_;r[w+5]=G+b,r[w+3]=G-b,r[w+1]=F+x,r[w+7]=F-x,w+=8}for(w=0,c=0;h>c;++c){n=r[w],e=r[w+8],o=r[w+16],t=r[w+24],f=r[w+32],i=r[w+40],v=r[w+48],u=r[w+56];var J=n+u,N=n-u,P=e+v,S=e-v,k=o+i,q=o-i,z=t+f,H=t-f,K=J+z,L=J-z,O=P+k,Q=P-k;r[w]=K+O,r[w+32]=K-O;var R=.707106781*(Q+L);r[w+16]=L+R,r[w+48]=L-R,K=H+q,O=q+S,Q=S+N;var U=.382683433*(K-Q),V=.5411961*K+U,W=1.306562965*Q+U,X=.707106781*O,Y=N+X,Z=N-X;r[w+40]=Z+V,r[w+24]=Z-V,r[w+8]=Y+W,r[w+56]=Y-W,w++}var $;for(c=0;g>c;++c)$=r[c]*a[c],B[c]=$>0?$+.5|0:$-.5|0;return B}function c(){v(65504),v(16),i(74),i(70),i(73),i(70),i(0),i(1),i(1),i(0),v(1),v(1),i(0),i(0)}function w(r,a){v(65472),v(17),i(8),v(a),v(r),i(3),i(1),i(17),i(0),i(2),i(17),i(1),i(3),i(17),i(1)}function h(){v(65499),v(132),i(0);for(var r=0;64>r;r++)i(T[r]);i(1);for(var a=0;64>a;a++)i(C[a])}function g(){v(65476),v(418),i(0);for(var r=0;16>r;r++)i(K[r+1]);for(var a=0;11>=a;a++)i(L[a]);i(16);for(var n=0;16>n;n++)i(O[n+1]);for(var e=0;161>=e;e++)i(Q[e]);i(1);for(var o=0;16>o;o++)i(R[o+1]);for(var t=0;11>=t;t++)i(U[t]);i(17);for(var f=0;16>f;f++)i(V[f+1]);for(var u=0;161>=u;u++)i(W[u])}function d(){v(65498),v(12),i(3),i(1),i(0),i(2),i(17),i(3),i(17),i(0),i(63),i(0)}function y(r,a,n,e,o){for(var t,i=o[0],v=o[240],c=16,w=63,h=64,g=u(r,a),d=0;h>d;++d)F[H[d]]=g[d];var y=F[0]-n;n=F[0],0==y?f(e[0]):(t=32767+y,f(e[_[t]]),f(x[t]));for(var m=63;m>0&&0==F[m];m--);if(0==m)return f(i),n;for(var A,s=1;m>=s;){for(var p=s;0==F[s]&&m>=s;++s);var l=s-p;if(l>=c){A=l>>4;for(var D=1;A>=D;++D)f(v);l=15&l}t=32767+F[s],f(o[(l<<4)+_[t]]),f(x[t]),s++}return m!=w&&f(i),n}function m(){for(var r=String.fromCharCode,a=0;256>a;a++)q[a]=r(a)}function A(r){if(0>=r&&(r=1),r>100&&(r=100),I!=r){var n=0;n=Math.floor(50>r?5e3/r:200-2*r),a(n),I=r}}function s(){var a=(new Date).getTime();r||(r=50),m(),e(),o(),t(),A(r);(new Date).getTime()-a}var p,l,D,E,I,j=(Math.round,Math.floor),T=new Array(64),C=new Array(64),M=new Array(64),b=new Array(64),x=new Array(65535),_=new Array(65535),B=new Array(64),F=new Array(64),G=[],J=0,N=7,P=new Array(64),S=new Array(64),k=new Array(64),q=new Array(256),z=new Array(2048),H=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],K=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],L=[0,1,2,3,4,5,6,7,8,9,10,11],O=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],Q=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],R=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],U=[0,1,2,3,4,5,6,7,8,9,10,11],V=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],W=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];this.encode=function(r,a){var n=(new Date).getTime();a&&A(a),G=new Array,J=0,N=7,v(65496),c(),h(),w(r.width,r.height),g(),d();var e=0,o=0,t=0;J=0,N=7,this.encode.displayName="_encode_";for(var i,u,m,s,I,j,T,C,x,_=r.data,B=r.width,F=r.height,q=4*B,H=0;F>H;){for(i=0;q>i;){for(I=q*H+i,j=I,T=-1,C=0,x=0;64>x;x++)C=x>>3,T=4*(7&x),j=I+C*q+T,H+C>=F&&(j-=q*(H+1+C-F)),i+T>=q&&(j-=i+T-q+4),u=_[j++],m=_[j++],s=_[j++],P[x]=(z[u]+z[m+256>>0]+z[s+512>>0]>>16)-128,S[x]=(z[u+768>>0]+z[m+1024>>0]+z[s+1280>>0]>>16)-128,k[x]=(z[u+1280>>0]+z[m+1536>>0]+z[s+1792>>0]>>16)-128;e=y(P,M,e,p,D),o=y(S,b,o,l,E),t=y(k,b,t,l,E),i+=32}H+=8}if(N>=0){var K=[];K[1]=N+1,K[0]=(1<<N+1)-1,f(K)}v(65497);var L="data:image/jpeg;base64,"+btoa(G.join(""));G=[];(new Date).getTime()-n;return L},s()},getImageDataFromImage:function(r){var a="string"==typeof r?document.getElementById(r):r,n=document.createElement("canvas");n.width=a.width,n.height=a.height;var e=n.getContext("2d");return e.drawImage(a,0,0),e.getImageData(0,0,n.width,n.height)}}});
;define("fishstrap/util/imageCompresser.js",function(t,e,a){var r=t("fishstrap/core/global.js"),n=t("fishstrap/util/jpegEncoder.js");a.exports={isIosSubSample:function(t){var e=t.naturalWidth,a=t.naturalHeight,r=!1;if(e*a>1048576){var n=document.createElement("canvas");ctx=n.getContext("2d"),n.width=n.height=1,ctx.drawImage(t,1-e,0),r=0===ctx.getImageData(0,0,1,1).data[3],n=ctx=null}return r},getIosImageRatio:function(t,e,a){var r,n=document.createElement("canvas"),o=n.getContext("2d"),i=0,c=a,s=a;for(n.width=1,n.height=a,o.drawImage(t,1-Math.ceil(Math.random()*e),0),r=o.getImageData(0,0,1,a).data;s>i;){var l=r[4*(s-1)+3];0===l?c=s:i=s,s=c+i>>1}return s/a},drawImageIosFix:function(t,e,a,r,n,o,i,c,s,l){this.isIosSubSample(e)&&(n/=2,o/=2);var d,g,h,u,m,w,I,f,x=document.createElement("canvas"),v=x.getContext("2d"),p=1024,b=this.getIosImageRatio(e,n,o);for(x.width=x.height=p,g=0;o>g;){for(u=g+p>o?o-g:p,d=0;n>d;)h=d+p>n?n-d:p,v.clearRect(0,0,p,p),v.drawImage(e,-d-a,-g-r),m=Math.floor(d*s/n),I=Math.ceil(h*s/n),w=Math.floor(g*l/o/b),f=Math.ceil(u*l/o/b),t.drawImage(x,0,0,h,u,m,w,I,f),d+=p;g+=p}},clipImage:function(t,e,a,r,n){var o=document.createElement("canvas"),i=o.getContext("2d");o.width=r,o.height=n;var c=t.getImageData(e,a,r,n);return i.putImageData(c,0,0),{canvas:o,context:i}},getImageBase64:function(t,e){e=r.extend({maxW:2e3,maxH:2e3,quality:.8,scale:0,orien:1},e);var a,o,i,c=e.maxW,s=e.maxH,l=e.quality,d=t.naturalWidth,g=t.naturalHeight,h=0,u=0,m=e.scale;i=e.orien>=5&&e.orien<=8?!0:!1,m&&0!=m?0==i?d/g>=m?(o=s,a=o*m,h=(d-m*g)/2,u=0,d=m*g,g=g):(a=c,o=a/m,h=0,u=(g-d/m)/2,d=d,g=d/m):g/d>=m?(a=s,o=s*m,h=0,u=(g-d*m)/2,d=d,g=d*m):(o=c,a=c/m,u=0,h=(d-g/m)/2,g=g,d=g/m):d>c&&d/g>=c/s?(a=c,o=g*c/d):g>s&&g/d>=s/c?(a=d*s/g,o=s):(a=d,o=g);var w,I=document.createElement("canvas"),f=I.getContext("2d");if(this.doAutoRotate(I,a,o,e.orien),r.os.ios?this.drawImageIosFix(f,t,h,u,d,g,0,0,a,o):f.drawImage(t,h,u,d,g,0,0,a,o),r.os.android){var v=f.getImageData(0,0,I.width,I.height);x=n.JPEGEncoder(100*l),w=n.encode(v),x=null}else w=I.toDataURL("image/jpeg",l);return I=f=null,w},doAutoRotate:function(t,e,a,r){var n=t.getContext("2d");switch(r>=5&&8>=r?(t.width=a,t.height=e):(t.width=e,t.height=a),r){case 2:n.translate(e,0),n.scale(-1,1);break;case 3:n.translate(e,a),n.rotate(Math.PI);break;case 4:n.translate(0,a),n.scale(1,-1);break;case 5:n.rotate(.5*Math.PI),n.scale(1,-1);break;case 6:n.rotate(.5*Math.PI),n.translate(0,-a);break;case 7:n.rotate(.5*Math.PI),n.translate(e,-a),n.scale(-1,1);break;case 8:n.rotate(-.5*Math.PI),n.translate(-e,0)}},getFileObjectURL:function(t){var e=window.URL||window.webkitURL||!1;return e?e.createObjectURL(t):void 0},support:function(){return typeof window.File&&typeof window.FileList&&typeof window.FileReader&&typeof window.Blob}}});
;define("fishstrap/util/jpegMeta.js",function(e,t,i){i.exports={init:function(){var e={};this.JpegMeta=e,e.parseNum=function(e,t,i,a){var r,n,o=">"===e;for(void 0===i&&(i=0),void 0===a&&(a=t.length-i),r=o?i:i+a-1;o?i+a>r:r>=i;o?r++:r--)n<<=8,n+=t.charCodeAt(r);return n},e.parseSnum=function(e,t,i,a){var r,n,o,s=">"===e;for(void 0===i&&(i=0),void 0===a&&(a=t.length-i),r=s?i:i+a-1;s?i+a>r:r>=i;s?r++:r--)void 0===o&&(o=128===(128&t.charCodeAt(r))),n<<=8,n+=o?255&~t.charCodeAt(r):t.charCodeAt(r);return o&&(n+=1,n*=-1),n},e.Rational=function(e,t){return this.num=e,this.den=t||1,this},e.Rational.prototype.toString=function(){return 0===this.num?""+this.num:1===this.den?""+this.num:1===this.num?this.num+" / "+this.den:this.num/this.den},e.Rational.prototype.asFloat=function(){return this.num/this.den},e.MetaGroup=function(e,t){return this.fieldName=e,this.description=t,this.metaProps={},this},e.MetaGroup.prototype._addProperty=function(t,i,a){var r=new e.MetaProp(t,i,a);this[r.fieldName]=r,this.metaProps[r.fieldName]=r},e.MetaGroup.prototype.toString=function(){return"[MetaGroup "+this.description+"]"},e.MetaProp=function(e,t,i){return this.fieldName=e,this.description=t,this.value=i,this},e.MetaProp.prototype.toString=function(){return""+this.value},e.JpegFile=function(t,i){var a=this._SOS;this.metaGroups={},this._binary_data=t,this.filename=i;var r,n,o,s,l,u,p,d=0,f=0;if(this._binary_data.slice(0,2)!==this._SOI_MARKER)throw new Error("Doesn't look like a JPEG file. First two bytes are "+this._binary_data.charCodeAt(0)+","+this._binary_data.charCodeAt(1)+".");for(d+=2;d<this._binary_data.length&&(r=this._binary_data.charCodeAt(d++),n=this._binary_data.charCodeAt(d++),f=d,r==this._DELIM)&&n!==a;){for(l=e.parseNum(">",this._binary_data,d,2),d+=l;d<this._binary_data.length;)if(console.log(d+","+this._binary_data.length),r=this._binary_data.charCodeAt(d++),r==this._DELIM&&(o=this._binary_data.charCodeAt(d++),0!=o)){d-=2;break}s=d-f,this._markers[n]?(u=this._markers[n][0],p=this._markers[n][1]):(u="UNKN",p=void 0),p&&this[p](n,f+2)}if(void 0===this.general)throw Error("Invalid JPEG file.");return this},this.JpegMeta.JpegFile.prototype.toString=function(){return"[JpegFile "+this.filename+" "+this.general.type+" "+this.general.pixelWidth+"x"+this.general.pixelHeight+" Depth: "+this.general.depth+"]"},this.JpegMeta.JpegFile.prototype._SOI_MARKER="ÿØ",this.JpegMeta.JpegFile.prototype._DELIM=255,this.JpegMeta.JpegFile.prototype._EOI=217,this.JpegMeta.JpegFile.prototype._SOS=218,this.JpegMeta.JpegFile.prototype._sofHandler=function(t,i){if(void 0!==this.general)throw Error("Unexpected multiple-frame image");this._addMetaGroup("general","General"),this.general._addProperty("depth","Depth",e.parseNum(">",this._binary_data,i,1)),this.general._addProperty("pixelHeight","Pixel Height",e.parseNum(">",this._binary_data,i+1,2)),this.general._addProperty("pixelWidth","Pixel Width",e.parseNum(">",this._binary_data,i+3,2)),this.general._addProperty("type","Type",this._markers[t][2])},this.JpegMeta.JpegFile.prototype._JFIF_IDENT="JFIF\x00",this.JpegMeta.JpegFile.prototype._JFXX_IDENT="JFXX\x00",this.JpegMeta.JpegFile.prototype._EXIF_IDENT="Exif\x00",this.JpegMeta.JpegFile.prototype._types={1:["BYTE",1],2:["ASCII",1],3:["SHORT",2],4:["LONG",4],5:["RATIONAL",8],6:["SBYTE",1],7:["UNDEFINED",1],8:["SSHORT",2],9:["SLONG",4],10:["SRATIONAL",8],11:["FLOAT",4],12:["DOUBLE",8]},this.JpegMeta.JpegFile.prototype._tifftags={256:["Image width","ImageWidth"],257:["Image height","ImageLength"],258:["Number of bits per component","BitsPerSample"],259:["Compression scheme","Compression",{1:"uncompressed",6:"JPEG compression"}],262:["Pixel composition","PhotmetricInerpretation",{2:"RGB",6:"YCbCr"}],274:["Orientation of image","Orientation",{1:"Normal",2:"Reverse?",3:"Upside-down",4:"Upside-down Reverse",5:"90 degree CW",6:"90 degree CW reverse",7:"90 degree CCW",8:"90 degree CCW reverse"}],277:["Number of components","SamplesPerPixel"],284:["Image data arrangement","PlanarConfiguration",{1:"chunky format",2:"planar format"}],530:["Subsampling ratio of Y to C","YCbCrSubSampling"],531:["Y and C positioning","YCbCrPositioning",{1:"centered",2:"co-sited"}],282:["X Resolution","XResolution"],283:["Y Resolution","YResolution"],296:["Resolution Unit","ResolutionUnit",{2:"inches",3:"centimeters"}],273:["Image data location","StripOffsets"],278:["Number of rows per strip","RowsPerStrip"],279:["Bytes per compressed strip","StripByteCounts"],513:["Offset to JPEG SOI","JPEGInterchangeFormat"],514:["Bytes of JPEG Data","JPEGInterchangeFormatLength"],301:["Transfer function","TransferFunction"],318:["White point chromaticity","WhitePoint"],319:["Chromaticities of primaries","PrimaryChromaticities"],529:["Color space transformation matrix coefficients","YCbCrCoefficients"],532:["Pair of black and white reference values","ReferenceBlackWhite"],306:["Date and time","DateTime"],270:["Image title","ImageDescription"],271:["Make","Make"],272:["Model","Model"],305:["Software","Software"],315:["Person who created the image","Artist"],316:["Host Computer","HostComputer"],33432:["Copyright holder","Copyright"],34665:["Exif tag","ExifIfdPointer"],34853:["GPS tag","GPSInfoIfdPointer"]},this.JpegMeta.JpegFile.prototype._exiftags={36864:["Exif Version","ExifVersion"],40960:["FlashPix Version","FlashpixVersion"],40961:["Color Space","ColorSpace"],37121:["Meaning of each component","ComponentsConfiguration"],37122:["Compressed Bits Per Pixel","CompressedBitsPerPixel"],40962:["Pixel X Dimension","PixelXDimension"],40963:["Pixel Y Dimension","PixelYDimension"],37500:["Manufacturer notes","MakerNote"],37510:["User comments","UserComment"],40964:["Related audio file","RelatedSoundFile"],36867:["Date Time Original","DateTimeOriginal"],36868:["Date Time Digitized","DateTimeDigitized"],37520:["DateTime subseconds","SubSecTime"],37521:["DateTimeOriginal subseconds","SubSecTimeOriginal"],37522:["DateTimeDigitized subseconds","SubSecTimeDigitized"],33434:["Exposure time","ExposureTime"],33437:["FNumber","FNumber"],34850:["Exposure program","ExposureProgram"],34852:["Spectral sensitivity","SpectralSensitivity"],34855:["ISO Speed Ratings","ISOSpeedRatings"],34856:["Optoelectric coefficient","OECF"],37377:["Shutter Speed","ShutterSpeedValue"],37378:["Aperture Value","ApertureValue"],37379:["Brightness","BrightnessValue"],37380:["Exposure Bias Value","ExposureBiasValue"],37381:["Max Aperture Value","MaxApertureValue"],37382:["Subject Distance","SubjectDistance"],37383:["Metering Mode","MeteringMode"],37384:["Light Source","LightSource"],37385:["Flash","Flash"],37386:["Focal Length","FocalLength"],37396:["Subject Area","SubjectArea"],41483:["Flash Energy","FlashEnergy"],41484:["Spatial Frequency Response","SpatialFrequencyResponse"],41486:["Focal Plane X Resolution","FocalPlaneXResolution"],41487:["Focal Plane Y Resolution","FocalPlaneYResolution"],41488:["Focal Plane Resolution Unit","FocalPlaneResolutionUnit"],41492:["Subject Location","SubjectLocation"],41493:["Exposure Index","ExposureIndex"],41495:["Sensing Method","SensingMethod"],41728:["File Source","FileSource"],41729:["Scene Type","SceneType"],41730:["CFA Pattern","CFAPattern"],41985:["Custom Rendered","CustomRendered"],41986:["Exposure Mode","Exposure Mode"],41987:["White Balance","WhiteBalance"],41988:["Digital Zoom Ratio","DigitalZoomRatio"],41990:["Scene Capture Type","SceneCaptureType"],41991:["Gain Control","GainControl"],41992:["Contrast","Contrast"],41993:["Saturation","Saturation"],41994:["Sharpness","Sharpness"],41995:["Device settings description","DeviceSettingDescription"],41996:["Subject distance range","SubjectDistanceRange"],42016:["Unique image ID","ImageUniqueID"],40965:["Interoperability tag","InteroperabilityIFDPointer"]},this.JpegMeta.JpegFile.prototype._gpstags={0:["GPS tag version","GPSVersionID"],1:["North or South Latitude","GPSLatitudeRef"],2:["Latitude","GPSLatitude"],3:["East or West Longitude","GPSLongitudeRef"],4:["Longitude","GPSLongitude"],5:["Altitude reference","GPSAltitudeRef"],6:["Altitude","GPSAltitude"],7:["GPS time (atomic clock)","GPSTimeStamp"],8:["GPS satellites usedd for measurement","GPSSatellites"],9:["GPS receiver status","GPSStatus"],10:["GPS mesaurement mode","GPSMeasureMode"],11:["Measurement precision","GPSDOP"],12:["Speed unit","GPSSpeedRef"],13:["Speed of GPS receiver","GPSSpeed"],14:["Reference for direction of movement","GPSTrackRef"],15:["Direction of movement","GPSTrack"],16:["Reference for direction of image","GPSImgDirectionRef"],17:["Direction of image","GPSImgDirection"],18:["Geodetic survey data used","GPSMapDatum"],19:["Reference for latitude of destination","GPSDestLatitudeRef"],20:["Latitude of destination","GPSDestLatitude"],21:["Reference for longitude of destination","GPSDestLongitudeRef"],22:["Longitude of destination","GPSDestLongitude"],23:["Reference for bearing of destination","GPSDestBearingRef"],24:["Bearing of destination","GPSDestBearing"],25:["Reference for distance to destination","GPSDestDistanceRef"],26:["Distance to destination","GPSDestDistance"],27:["Name of GPS processing method","GPSProcessingMethod"],28:["Name of GPS area","GPSAreaInformation"],29:["GPS Date","GPSDateStamp"],30:["GPS differential correction","GPSDifferential"]},this.JpegMeta.JpegFile.prototype._markers={192:["SOF0","_sofHandler","Baseline DCT"],193:["SOF1","_sofHandler","Extended sequential DCT"],194:["SOF2","_sofHandler","Progressive DCT"],195:["SOF3","_sofHandler","Lossless (sequential)"],197:["SOF5","_sofHandler","Differential sequential DCT"],198:["SOF6","_sofHandler","Differential progressive DCT"],199:["SOF7","_sofHandler","Differential lossless (sequential)"],200:["JPG",null,"Reserved for JPEG extensions"],201:["SOF9","_sofHandler","Extended sequential DCT"],202:["SOF10","_sofHandler","Progressive DCT"],203:["SOF11","_sofHandler","Lossless (sequential)"],205:["SOF13","_sofHandler","Differential sequential DCT"],206:["SOF14","_sofHandler","Differential progressive DCT"],207:["SOF15","_sofHandler","Differential lossless (sequential)"],196:["DHT",null,"Define Huffman table(s)"],204:["DAC",null,"Define arithmetic coding conditioning(s)"],208:["RST0",null,"Restart with modulo 8 count “0”"],209:["RST1",null,"Restart with modulo 8 count “1”"],210:["RST2",null,"Restart with modulo 8 count “2”"],211:["RST3",null,"Restart with modulo 8 count “3”"],212:["RST4",null,"Restart with modulo 8 count “4”"],213:["RST5",null,"Restart with modulo 8 count “5”"],214:["RST6",null,"Restart with modulo 8 count “6”"],215:["RST7",null,"Restart with modulo 8 count “7”"],216:["SOI",null,"Start of image"],217:["EOI",null,"End of image"],218:["SOS",null,"Start of scan"],219:["DQT",null,"Define quantization table(s)"],220:["DNL",null,"Define number of lines"],221:["DRI",null,"Define restart interval"],222:["DHP",null,"Define hierarchical progression"],223:["EXP",null,"Expand reference component(s)"],224:["APP0","_app0Handler","Reserved for application segments"],225:["APP1","_app1Handler"],226:["APP2",null],227:["APP3",null],228:["APP4",null],229:["APP5",null],230:["APP6",null],231:["APP7",null],232:["APP8",null],233:["APP9",null],234:["APP10",null],235:["APP11",null],236:["APP12",null],237:["APP13",null],238:["APP14",null],239:["APP15",null],240:["JPG0",null],241:["JPG1",null],242:["JPG2",null],243:["JPG3",null],244:["JPG4",null],245:["JPG5",null],246:["JPG6",null],247:["JPG7",null],248:["JPG8",null],249:["JPG9",null],250:["JPG10",null],251:["JPG11",null],252:["JPG12",null],253:["JPG13",null],254:["COM",null],1:["JPG13",null]},this.JpegMeta.JpegFile.prototype._addMetaGroup=function(t,i){var a=new e.MetaGroup(t,i);return this[a.fieldName]=a,this.metaGroups[a.fieldName]=a,a},this.JpegMeta.JpegFile.prototype._parseIfd=function(t,i,a,r,n,o,s){var l,u,p,d,h,m,c,g,P,S,_,y,D,F=e.parseNum(t,i,a+r,2);D=this._addMetaGroup(o,s);for(var l=0;F>l;l++)if(p=a+r+2+12*l,d=e.parseNum(t,i,p,2),m=e.parseNum(t,i,p+2,2),g=e.parseNum(t,i,p+4,4),P=e.parseNum(t,i,p+8,4),void 0!==this._types[m]){if(h=this._types[m][0],c=this._types[m][1],P=4>=c*g?p+8:a+P,"UNDEFINED"==h)f=i.slice(P,P+g);else if("ASCII"==h)S=i.slice(P,P+g),S=S.split("\x00")[0];else{for(S=new Array,u=0;g>u;u++,P+=c)("BYTE"==h||"SHORT"==h||"LONG"==h)&&S.push(e.parseNum(t,i,P,c)),("SBYTE"==h||"SSHORT"==h||"SLONG"==h)&&S.push(e.parseSnum(t,i,P,c)),"RATIONAL"==h&&(_=e.parseNum(t,i,P,4),y=e.parseNum(t,i,P+4,4),S.push(new e.Rational(_,y))),"SRATIONAL"==h&&(_=e.parseSnum(t,i,P,4),y=e.parseSnum(t,i,P+4,4),S.push(new e.Rational(_,y))),S.push();1===g&&(S=S[0])}void 0!==n[d]&&D._addProperty(n[d][1],n[d][0],S)}},this.JpegMeta.JpegFile.prototype._jfifHandler=function(t,i){if(void 0!==this.jfif)throw Error("Multiple JFIF segments found");this._addMetaGroup("jfif","JFIF"),this.jfif._addProperty("version_major","Version Major",this._binary_data.charCodeAt(i+5)),this.jfif._addProperty("version_minor","Version Minor",this._binary_data.charCodeAt(i+6)),this.jfif._addProperty("version","JFIF Version",this.jfif.version_major.value+"."+this.jfif.version_minor.value),this.jfif._addProperty("units","Density Unit",this._binary_data.charCodeAt(i+7)),this.jfif._addProperty("Xdensity","X density",e.parseNum(">",this._binary_data,i+8,2)),this.jfif._addProperty("Ydensity","Y Density",e.parseNum(">",this._binary_data,i+10,2)),this.jfif._addProperty("Xthumbnail","X Thumbnail",e.parseNum(">",this._binary_data,i+12,1)),this.jfif._addProperty("Ythumbnail","Y Thumbnail",e.parseNum(">",this._binary_data,i+13,1))},this.JpegMeta.JpegFile.prototype._app0Handler=function(e,t){var i=this._binary_data.slice(t,t+5);i==this._JFIF_IDENT?this._jfifHandler(e,t):i==this._JFXX_IDENT},this.JpegMeta.JpegFile.prototype._app1Handler=function(e,t){var i=this._binary_data.slice(t,t+5);i==this._EXIF_IDENT&&this._exifHandler(e,t+6)},e.JpegFile.prototype._exifHandler=function(t,i){if(void 0!==this.exif)throw new Error("Multiple JFIF segments found");var a,r,n,o=this._binary_data.slice(i,i+2);if("II"===o)a="<";else{if("MM"!==o)throw new Error("Malformed TIFF meta-data. Unknown endianess: "+o);a=">"}if(r=e.parseNum(a,this._binary_data,i+2,2),42!==r)throw new Error("Malformed TIFF meta-data. Bad magic: "+r);n=e.parseNum(a,this._binary_data,i+4,4),this._parseIfd(a,this._binary_data,i,n,this._tifftags,"tiff","TIFF"),this.tiff.ExifIfdPointer&&this._parseIfd(a,this._binary_data,i,this.tiff.ExifIfdPointer.value,this._exiftags,"exif","Exif"),this.tiff.GPSInfoIfdPointer}}},i.exports.init()});